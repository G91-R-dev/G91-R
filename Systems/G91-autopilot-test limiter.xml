<?xml version="1.0"?>

<!-- Autopilot JSBSim
Original work Copyright (c) 2019 Adriano Bassignana (abassign)

<property>/fdm/jsbsim/systems/gauges/cockpit-attitude-J8-horizon-offset</property>
-->

<system>
    
    <property value="0.0">systems/autopilot/gui/heading-control</property>
    <property value="0.0">systems/autopilot/gui/wing-leveler</property>
    <property value="0.0">systems/autopilot/gui/true-heading</property>
    <property value="0.0">systems/autopilot/gui/phi-heading</property>
    
    <property value="0.0">systems/autopilot/gui/altitude-active</property>
    <property value="0.0">systems/autopilot/gui/vertical-speed</property>
    <property value="0.0">systems/autopilot/gui/vertical-speed-fpm</property>
    <property value="0.0">systems/autopilot/gui/pitch-hold</property>
    <property value="0.0">systems/autopilot/gui/pitch-hold-deg</property>
    
    <property value="0.0">systems/autopilot/gui/altitude-hold</property>
    <property value="0.0">systems/autopilot/gui/altitude-hold-ft</property>
    <property value="0.0">systems/autopilot/gui/altitude-hold-togle</property>
    
    <property value="0.0">systems/autopilot/wing-leveler-active</property>
    <property value="0.0">systems/autopilot/wing-leveler-ap-on-off</property>
    
    <property value="0.0">systems/autopilot/gui/pitch-hold-active</property>
    <property value="0.0">systems/autopilot/gui/pitch-hold-ap-on-off</property>
    
    <property value="0.0">systems/autopilot/v-up-fpm</property>
    <property value="0.1">systems/autopilot/v-up-fpm-lag-lag-coefficient</property>
    <property value="0.0">systems/autopilot/elevator-cmd</property>
    <property value="5.0">systems/autopilot/pitch-pid-kp</property>
    <property value="1.0">systems/autopilot/pitch-pid-ki</property>
    <property value="5.0">systems/autopilot/pitch-pid-kd</property>
    <property value="-0.25">systems/autopilot/pitch-error-coefficient</property>
    <property value="0.0">systems/autopilot/pitch-ap-autoswitch-norm</property>
    
    <property value="0.0">systems/autopilot/gui/vertical-speed-active</property>
    <property value="1.5">systems/autopilot/vertical-speed-pid-kp</property>
    <property value="0.5">systems/autopilot/vertical-speed-pid-ki</property>
    <property value="2.0">systems/autopilot/vertical-speed-pid-kd</property>
    <property value="0.1">systems/autopilot/vertical-speed-lag-coefficient</property>
    <property value="1.0">systems/autopilot/vertical-speed-error-coefficient</property>
    <property value="0.0">systems/autopilot/vertical-speed-pitch-error-lag</property>
    
    <property value="0.5">systems/autopilot/gui/h-sl-ft-lag-coefficient</property>
    <property value="0.0">systems/autopilot/gui/altitude-hold-active</property>
    <property value="0.0">systems/autopilot/altitude-hold-versus-lag</property>
    <property value="2.0">systems/autopilot/altitude-hold-versus-lag-C1</property>
    <property value="0.0">systems/autopilot/altitude-hold-limitator-active</property>
    <property value="0.5">systems/autopilot/altitude-hold-lag-coefficient</property>
    <property value="0.0">systems/autopilot/altitude-hold-pitch-error-lag</property>
    <property value="1.0">systems/autopilot/altitude-hold-pid-kp</property>
    <property value="0.0">systems/autopilot/altitude-hold-pid-ki</property>
    <property value="1.0">systems/autopilot/altitude-hold-pid-kd</property>
    <property value="0.003">systems/autopilot/altitude-hold-error-coefficient</property>
    
    <property value="3.0">systems/autopilot/roll-pid-kp</property>
    <property value="0.5">systems/autopilot/roll-pid-ki</property>
    <property value="1.5">systems/autopilot/roll-pid-kd</property>
    <property value="0.0">systems/autopilot/roll-ap-autoswitch-norm</property>
    
    
    <channel name="Autopilot GUI Interface" execrate="32">
        
        <switch name="systems/autopilot/wing-leveler-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/heading-control == 1.0
                systems/autopilot/gui/wing-leveler == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/gui/pitch-hold-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/altitude-active == 1.0
                systems/autopilot/gui/pitch-hold == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/gui/vertical-speed-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/altitude-active == 1.0
                systems/autopilot/gui/vertical-speed == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/gui/altitude-hold-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/altitude-active == 1.0
                systems/autopilot/gui/altitude-hold == 1.0
            </test>
        </switch>
        
    </channel>
    
    
    <channel name="Heading control">
        
        <switch name="systems/autopilot/wing-leveler-ap-on-off">
            <default value="-1"/>
            <test logic="AND" value="0">
                systems/autopilot/wing-leveler-active == 1
            </test>
        </switch>
        
        <pure_gain name="systems/autopilot/phi-rad-limited">
            <input>attitude/phi-rad</input>
            <clipto>
                <min>-0.25</min>
                <max>0.25</max>
            </clipto>
        </pure_gain>
        
        <pid name="systems/autopilot/roll-ap-pid">
            <input>systems/autopilot/phi-rad-limited</input>
            <kp>systems/autopilot/roll-pid-kp</kp>
            <ki>systems/autopilot/roll-pid-ki</ki>
            <kd>systems/autopilot/roll-pid-kd</kd>
            <trigger>systems/autopilot/wing-leveler-ap-on-off</trigger>
        </pid>
        
        <switch name="systems/autopilot/roll-ap-autoswitch">
            <default value="0"/>
            <test logic="AND" value="systems/autopilot/roll-ap-pid">
                systems/autopilot/wing-leveler-active == 1
            </test>
        </switch>
        
        <pure_gain name="systems/autopilot/roll-ap-autoswitch-norm">
            <input>systems/autopilot/roll-ap-autoswitch</input>
            <gain>-1</gain>
        </pure_gain> 
        
    </channel>
    
    
    <channel name="Altitude control">
        
        <switch name="systems/autopilot/gui/pitch-hold-ap-on-off">
            <default value="-1"/>
            <test logic="AND" value="0">
                systems/autopilot/gui/pitch-hold-active == 1
            </test>
        </switch>
        
        <pure_gain name="systems/autopilot/v-up-fpm">
            <input>velocities/v-down-fps</input>
            <gain>-60</gain>
        </pure_gain>
        
        <lag_filter name="systems/autopilot/v-up-fpm-lag">
            <input>systems/autopilot/v-up-fpm</input>
            <c1>systems/autopilot/v-up-fpm-lag-lag-coefficient</c1>
        </lag_filter>
        
        <lag_filter name="systems/autopilot/h-sl-ft-lag">
            <input>position/h-sl-ft</input>
            <c1>systems/autopilot/gui/h-sl-ft-lag-coefficient</c1>
        </lag_filter>

        <!-- Pitch section -->
        
        <fcs_function name="systems/autopilot/pitch-hold-deg-mod">
            <function>
                <ifthen>
                    <p>systems/autopilot/gui/altitude-hold-active</p>
                    <product>
                        <p>systems/autopilot/altitude-hold-pitch-error-lag</p>
                        <product>
                            <p>systems/autopilot/altitude-hold-versus-lag</p>
                            <abs><p>systems/autopilot/gui/pitch-hold-deg</p></abs>
                        </product>
                    </product>
                    <p>systems/autopilot/gui/pitch-hold-deg</p>
                </ifthen>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/pitch-hold-deg-max-min-calc">
            <function>
                <product>
                    <ifthen>
                        <gt><p>velocities/vtrue-fps</p><v>100</v></gt>
                        <todegrees>
                            <atan>
                                <quotient>
                                    <quotient>
                                        <abs><p>systems/autopilot/v-up-fpm-lag</p></abs>
                                        <v>60.0</v>
                                    </quotient>
                                    <abs><p>velocities/vtrue-fps</p></abs>
                                </quotient>
                            </atan>
                        </todegrees>
                        <v>15.0</v>
                    </ifthen>
                </product>
            </function>
            <clipto>
                <min>-15.0</min>
                <max>15.0</max>
            </clipto>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/pitch-hold-deg-mod-limited">
            <function>
                <ifthen>
                    <p>systems/autopilot/gui/vertical-speed-active</p>
                    <ifthen>
                        <gt>
                            <abs><p>systems/autopilot/pitch-hold-deg-mod</p></abs>
                            <p>systems/autopilot/pitch-hold-deg-max-min-calc</p>
                        </gt>
                        <product>
                            <p>systems/autopilot/pitch-hold-deg-max-min-calc</p>
                            <ifthen>
                                <ge><p>systems/autopilot/pitch-hold-deg-mod</p><v>0.0</v></ge>
                                <v>1.2</v>
                                <v>-1.2</v>
                            </ifthen>
                        </product>
                        <p>systems/autopilot/pitch-hold-deg-mod</p>
                    </ifthen>
                    <p>systems/autopilot/pitch-hold-deg-mod</p>
                </ifthen>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/pitch-rad-error">
            <function>
                <difference>
                    <ifthen>
                        <p>systems/autopilot/gui/pitch-hold-active</p>
                        <toradians>
                            <p>systems/autopilot/pitch-hold-deg-mod-limited</p>
                        </toradians>
                        <ifthen>
                            <p>systems/autopilot/gui/vertical-speed-active</p>
                            <p>systems/autopilot/vertical-speed-pitch-error-lag</p>
                            <p>attitude/pitch-rad</p>
                        </ifthen>
                    </ifthen>
                    <p>attitude/pitch-rad</p>
                </difference>
            </function>
            <clipto>
                <min>-0.25</min>
                <max>0.25</max>
            </clipto>
        </fcs_function>
        
        <pid name="systems/autopilot/pitch-speed-ap-pid">
            <input>systems/autopilot/pitch-rad-error</input>
            <kp>systems/autopilot/pitch-pid-kp</kp>
            <ki>systems/autopilot/pitch-pid-ki</ki>
            <kd>systems/autopilot/pitch-pid-kd</kd>
            <trigger>systems/autopilot/gui/pitch-hold-ap-on-off</trigger>
        </pid>
        
        <pure_gain name="systems/autopilot/pitch-error">
            <input>systems/autopilot/pitch-speed-ap-pid</input>
            <gain>systems/autopilot/pitch-error-coefficient</gain>
        </pure_gain> 
        
        <!-- Vertical speed section -->
        
        <switch name="systems/autopilot/vertical-speed-reset-integrator">
            <default value="-1"/>
            <test logic="AND" value="0">
                systems/autopilot/gui/vertical-speed-active == 1
            </test>
        </switch>
        
        <fcs_function name="systems/autopilot/vertical-speed-error-norm">
            <function>
                <product>
                    <quotient>
                        <difference>
                            <p>systems/autopilot/gui/vertical-speed-fpm</p>
                            <p>systems/autopilot/v-up-fpm-lag</p>
                        </difference>
                        <abs><p>systems/autopilot/v-up-fpm-lag</p></abs>
                    </quotient>
                    <p>systems/autopilot/vertical-speed-error-coefficient</p>
                </product>
            </function>
            <clipto>
                <min>-0.25</min>
                <max>0.25</max>
            </clipto>
        </fcs_function>

        <pid name="systems/autopilot/vertical-speed-ap-pid-norm">
            <input>systems/autopilot/vertical-speed-error-norm</input>
            <kp>systems/autopilot/vertical-speed-pid-kp</kp>
            <ki>systems/autopilot/vertical-speed-pid-ki</ki>
            <kd>systems/autopilot/vertical-speed-pid-kd</kd>
            <trigger>systems/autopilot/vertical-speed-reset-integrator</trigger>
        </pid>
        
        <lag_filter name="systems/autopilot/vertical-speed-pitch-error-lag">
            <input>systems/autopilot/vertical-speed-ap-pid-norm</input>
            <c1>systems/autopilot/vertical-speed-lag-coefficient</c1>
        </lag_filter>
        
        <!-- Altitude hold section -->
        
        <fcs_function name="systems/autopilot/altitude-hold-versus">
            <function>
                <ifthen>
                    <ge>
                        <difference>
                            <p>systems/autopilot/gui/altitude-hold-ft</p>
                            <p>systems/autopilot/h-sl-ft-lag</p>
                        </difference>
                        <v>0.0</v>
                    </ge>
                    <v>1.0</v>
                    <v>-1.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/altitude-hold-versus-lag">
            <input>systems/autopilot/altitude-hold-versus</input>
            <c1>systems/autopilot/altitude-hold-versus-lag-C1</c1>
        </lag_filter>
        
        <fcs_function name="systems/autopilot/altitude-hold-error-norm">
            <function>
                <product>
                    <difference>
                        <p>systems/autopilot/gui/altitude-hold-ft</p>
                        <p>systems/autopilot/h-sl-ft-lag</p>
                    </difference>
                    <p>systems/autopilot/altitude-hold-error-coefficient</p>
                    <p>systems/autopilot/altitude-hold-versus-lag</p>
                </product>
            </function>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </fcs_function>
        
        <switch name="systems/autopilot/altitude-hold-limitator-active">
            <default value="0"/>
            <test logic="AND" value="1">
                systems/autopilot/gui/pitch-hold-active == 1
                systems/autopilot/gui/altitude-hold-active == 1
                systems/autopilot/altitude-hold-error-norm GT -1.0
                systems/autopilot/altitude-hold-error-norm LT 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/altitude-hold-reset-integrator">
            <default value="-1"/>
            <test logic="AND" value="0">
                systems/autopilot/altitude-hold-limitator-active == 1
            </test>
        </switch>
        
        <pid name="systems/autopilot/altitude-hold-ap-pid-norm">
            <input>systems/autopilot/altitude-hold-error-norm</input>
            <kp>systems/autopilot/altitude-hold-pid-kp</kp>
            <ki>systems/autopilot/altitude-hold-pid-ki</ki>
            <kd>systems/autopilot/altitude-hold-pid-kd</kd>
            <trigger>systems/autopilot/altitude-hold-reset-integrator</trigger>
        </pid>
        
        <switch name="systems/autopilot/altitude-hold-ap-pid-norm-active">
            <default value="1"/>
            <test logic="AND" value="systems/autopilot/altitude-hold-ap-pid-norm">
                systems/autopilot/altitude-hold-limitator-active == 1
            </test>
        </switch>
        
        <lag_filter name="systems/autopilot/altitude-hold-pitch-error-lag">
            <input>systems/autopilot/altitude-hold-ap-pid-norm-active</input>
            <c1>systems/autopilot/altitude-hold-lag-coefficient</c1>
        </lag_filter>
        
        <!-- output select section -->
        
        <switch name="systems/autopilot/pitch-ap-autoswitch-norm">
            <default value="0"/>
            <test logic="AND" value="systems/autopilot/pitch-error">
                systems/autopilot/gui/pitch-hold-active == 1
            </test>
            <test logic="AND" value="systems/autopilot/pitch-error">
                systems/autopilot/gui/vertical-speed-active == 1
            </test>
        </switch>

    </channel>
    
    
    <channel name="Speed control">
        
        
    </channel>
    
    
</system>
