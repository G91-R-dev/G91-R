<?xml version="1.0"?>  

<system name="fuel"> 
    <!--
    Information from G91R4 Flight Manual 1-35
    File explain from: http://wiki.flightgear.org/Howto:Write_a_fuel_system_in_JSBSim
    Forward Tank id = 0
    Aft Tank Right id = 1
    Aft Tank Left id = 2
    Auxiliary Tank Right (Droppable fuel tank) id = 3
    Auxiliary Tank Left (Droppable fuel tank) id = 4
    Collector or Manifold Tank id = 5
    Cut-Off valve and fuel pressure circuit is Tank id = 8
    The drop tank (3-4) if there are, fill the internal tanks (0) (1-2), in turn tanks (1-2) are kept level.
    The tank (5) is fed through a specially balancing valve that connects to the tanks (0) and (1-2).
    The tank (6) is the collector tank for (3) and (4)
    -->
    
    <property value="0.0">systems/fuel/inlet-a-togle</property>
    <property value="0.0">systems/fuel/inlet-a-pos</property>
    <property value="0.0">systems/fuel/inlet-a-open</property>
    <property value="0.0">systems/fuel/inlet-b-togle</property>
    <property value="0.0">systems/fuel/inlet-b-pos</property>
    <property value="0.0">systems/fuel/inlet-b-open</property>
    <property value="0.0">systems/fuel/refueling-operative</property>
    <property value="0.0">systems/fuel/tank-all-full</property>
    <property value="5.0">systems/fuel/refuel-inlet-a-flow-rate-max-pps</property>
    <property value="0.0">systems/fuel/refuel-inlet-a-flow-rate-pps</property>
    <property value="0.0">systems/fuel/refuel-inlet-a-flow-rate-pps-lag</property>
    <property value="5.0">systems/fuel/refuel-inlet-b-flow-rate-max-pps</property>
    <property value="0.0">systems/fuel/refuel-inlet-b-flow-rate-pps</property>
    <property value="0.0">systems/fuel/refuel-inlet-b-flow-rate-pps-lag</property>
    <property value="0.0">systems/fuel/refuel-inlet-a-flow-rate-pps-lag-effect</property>
    <property value="0.0">systems/fuel/refuel-inlet-b-flow-rate-pps-lag-effect</property>
    <property value="1.0">systems/fuel/refuel-inlet-flow-scale-effect</property>
    
    <!-- Collector Tank 6 level-maintenance for droppable tank 3-4 -->
    <channel name="To Tank6">
        
        <!-- from Tank 3 (to Collector Tank 6) -->
        <switch name="systems/fuel/from-tank3-to-tank6">
            <default value="0"/>
            <test logic="AND" value="2">
                propulsion/tank[3]/contents-lbs GT 0
                propulsion/tank[6]/contents-lbs LT 8
                accelerations/Nz GE -0.5
                systems/starter/drop-tank-press-on == 1
                systems/engine/air-compression-service-on == 1
            </test>
        </switch>
        
        <!-- from Tank 4 (to Collector Tank 6) -->
        <switch name="systems/fuel/from-tank4-to-tank6">
            <default value="0"/>
            <test logic="AND" value="2">
                propulsion/tank[4]/contents-lbs GT 0
                propulsion/tank[6]/contents-lbs LT 8
                accelerations/Nz GE -0.5
                systems/starter/drop-tank-press-on == 1
                systems/engine/air-compression-service-on == 1
            </test>
        </switch>
        
        <!-- Total flux from Tank 3 and 4 to Tank 6 -->
        <summer>
            <input>-systems/fuel/from-tank3-to-tank6</input>
            <output>propulsion/tank[3]/external-flow-rate-pps</output>
        </summer>
        
        <summer>
            <input>-systems/fuel/from-tank4-to-tank6</input>
            <output>propulsion/tank[4]/external-flow-rate-pps</output>
        </summer>
        
        <!-- Total flux for Tank 6 -->
        <summer>
            <input>systems/fuel/from-tank3-to-tank6</input>
            <input>systems/fuel/from-tank4-to-tank6</input>
            <input>-systems/fuel/from-tank6-to-tank0</input>
            <input>-systems/fuel/from-tank6-to-tank1</input>
            <output>propulsion/tank[6]/external-flow-rate-pps</output>
        </summer>
        
    </channel>
    
    
    <channel name="To Tank0">
        
        <!-- from Collector Tank 6 to Tank0 -->
        <switch name="systems/fuel/from-tank6-to-tank0">
            <default value="0"/>
            <test logic="AND" value="1.5">
                propulsion/tank[6]/contents-lbs GT 0
                propulsion/tank[0]/contents-lbs LT 1365
                accelerations/Nz GE -0.5
            </test>
        </switch>
        
        <!-- Total from Collector Tank 6 to Tank 0 -->
        <summer>
            <input>systems/fuel/from-tank6-to-tank0</input>
            <input>-systems/fuel/from-tank0-to-tank5</input>
            <input>systems/fuel/refuel-inlet-a-flow-rate-pps-lag</input>
            <output>propulsion/tank[0]/external-flow-rate-pps</output>
        </summer>
        
    </channel>
    
    
    <channel name="To Tank1 and Tank1 - Tank2">
        
        <!-- from Collector Tank 1 to Tank2 -->
        <switch name="systems/fuel/from-tank1-to-tank2">
            <default value="0"/>
            <test logic="AND" value="3.0">
                propulsion/tank[1]/contents-lbs GT 2
                propulsion/tank[1]/contents-lbs GT propulsion/tank[2]/contents-lbs
                propulsion/tank[2]/contents-lbs LT 560
                accelerations/Ny GT -0.2
                accelerations/Ny LT 0.2
                accelerations/Nz GE -0.5
            </test>
            <test logic="AND" value="1.0">
                propulsion/tank[2]/contents-lbs GT 10
                propulsion/tank[2]/contents-lbs LT 550
                accelerations/Ny LE -0.2
                accelerations/Nz GE -0.5
            </test>
        </switch>
        
        <switch name="systems/fuel/from-tank2-to-tank1">
            <default value="0"/>
            <test logic="AND" value="3.0">
                propulsion/tank[2]/contents-lbs GT 2
                propulsion/tank[2]/contents-lbs GT propulsion/tank[1]/contents-lbs
                propulsion/tank[1]/contents-lbs LT 560
                accelerations/Ny GT -0.2
                accelerations/Ny LT 0.2
                accelerations/Nz GE -0.5
            </test>
            <test logic="AND" value="1.0">
                propulsion/tank[1]/contents-lbs GT 10
                propulsion/tank[1]/contents-lbs LT 550
                accelerations/Ny LE 0.2
                accelerations/Nz GE -0.5
            </test>
        </switch>
        
        <!-- from Collector Tank 6 to Tank1 -->
        <switch name="systems/fuel/from-tank6-to-tank1">
            <default value="0"/>
            <test logic="AND" value="1.5">
                propulsion/tank[6]/contents-lbs GT 2
                propulsion/tank[1]/contents-lbs LT 560
                accelerations/Nz GE -0.5
            </test>
        </switch>
        
        <summer>
            <input>systems/fuel/from-tank1-to-tank2</input>
            <input>-systems/fuel/from-tank2-to-tank1</input>
            <input>systems/fuel/refuel-inlet-b-flow-rate-pps-lag</input>
            <output>propulsion/tank[2]/external-flow-rate-pps</output>
        </summer>
        
        <summer>
            <input>systems/fuel/from-tank6-to-tank1</input>
            <input>-systems/fuel/from-tank1-to-tank5</input>
            <input>systems/fuel/from-tank2-to-tank1</input>
            <input>-systems/fuel/from-tank1-to-tank2</input>
            <output>propulsion/tank[1]/external-flow-rate-pps</output>
        </summer>
        
    </channel>
    
    
    <!-- Collector Tank 5 level-maintenance for tank 0-7 -->
    <!-- Note:
    The values assigned to:
    systems/fuel/from-tank0-to-tank5
    fuel/from-tank8-to-tank5
    They must be calibrated appropriately to simulate the mixing device used by heating it.
    Theoretically it should not change the weight relation Tank0 with Tank1+Tank2
    -->
    <channel name="To Tank5">
        
        <switch name="systems/fuel/from-tank0-to-tank5">
            <default value="0"/>
            <test logic="AND" value="2.0">
                propulsion/tank[0]/contents-lbs GT 2
                propulsion/tank[5]/contents-lbs LT 273
                accelerations/Nz GE -0.5
            </test>
        </switch>
        
        <switch name="systems/fuel/from-tank1-to-tank5">
            <default value="0"/>
            <test logic="AND" value="2.0">
                propulsion/tank[1]/contents-lbs GT 2
                propulsion/tank[5]/contents-lbs LT 273
                accelerations/Nz GE -0.5
            </test>
        </switch>
        
        <summer>
            <input>systems/fuel/from-tank0-to-tank5</input>
            <input>systems/fuel/from-tank1-to-tank5</input>
            <input>-systems/fuel/from-tank5-to-tank7</input>
            <output>propulsion/tank[5]/external-flow-rate-pps</output>
        </summer>
        
    </channel>
    
    
    <!-- Total flux for Tank 8 -->
    <channel name="Tank 7 collector for engine">
        
        <switch name="systems/fuel/tank7-pump-pressure-on">
            <default value="0"/>
            <test logic="OR" value="1">
                systems/starter/fuel-booster-pump-on-lag GT 0.7
                systems/engine/air-compression-service-on == 1
            </test>
        </switch>
        
        <switch name="systems/fuel/from-tank5-to-tank7">
            <default value="0"/>
            <test logic="AND" value="2">
                propulsion/tank[5]/contents-lbs GT 2
                propulsion/tank[7]/contents-lbs LT 3
                systems/starter/fuel-shut-off-valve-on == 0
                systems/fuel/tank7-pump-pressure-on == 1
            </test>
        </switch>
        
        <summer name="tank5 to tank7">
            <input>systems/fuel/from-tank5-to-tank7</input>
            <output>propulsion/tank[7]/external-flow-rate-pps</output>
        </summer>
        
    </channel>
    
    
    <channel name="fuel systems fuel pressure" execrate="32">
        
        <lag_filter name="systems/starter/fuel-booster-pump-on-lag">
            <input>systems/starter/fuel-booster-pump-on</input>
            <c1>0.5</c1>
        </lag_filter>
        
        <switch name="systems/fuel/fuel-low-pressure-on">
            <default value="0"/>
            <test logic="OR" value="1">
                <test logic="AND">
                    systems/starter/fuel-booster-pump-on-lag LE 0.7
                    systems/engine/air-compression-service-on == 0
                </test>
                <test logic="AND">
                    propulsion/tank[7]/contents-lbs LT 1.5
                </test>
            </test>
        </switch>
        
        <switch>
            <default value="0"/>
            <test logic="OR" value="systems/warning-lights/light-intensity-by-bus1-tension">
                systems/fuel/fuel-low-pressure-on == 1
            </test>
            <output>systems/fuel/fuel-low-pressure-lg</output>
        </switch>
        
        <switch>
            <default value="0.85"/>
            <test logic="OR" value="systems/warning-lights/transparent-by-bus1-tension">
                systems/fuel/fuel-low-pressure-on == 1
            </test>
            <output>systems/fuel/fuel-low-pressure-lg-transparent</output>
        </switch>
        
    </channel>
    
    
    <channel name="fuel refill" execrate="8">
        
        <switch name="systems/fuel/tank-all-full">
            <default value="systems/fuel/tank-all-full"/>
            <test logic="OR" value="0">
                propulsion/tank[0]/pct-full LE 95.0
                propulsion/tank[1]/pct-full LE 95.0
                propulsion/tank[2]/pct-full LE 95.0
                propulsion/tank[5]/pct-full LE 95.0
            </test>
            <test logic="AND" value="1">
                propulsion/tank[0]/pct-full GE 98.0
                propulsion/tank[1]/pct-full GE 98.0
                propulsion/tank[2]/pct-full GE 98.0
                propulsion/tank[5]/pct-full GE 98.0
            </test>
        </switch>
        
        <switch name="systems/fuel/refueling-operative">
            <default value="systems/fuel/refueling-operative"/>
            <test logic="AND" value="1">
                systems/fuel/tank-all-full == 0
                <test logic="OR">
                    systems/fuel/inlet-a-open == 1
                    systems/fuel/inlet-b-open == 1
                </test>
            </test>
            <test logic="AND" value="0">
                systems/fuel/refueling-operative == 1
                systems/fuel/tank-all-full == 1
            </test>
        </switch>
        
        <lag_filter name="systems/fuel/inlet-a-pos">
            <input>systems/fuel/inlet-a-togle</input>
            <c1>2.0</c1>
        </lag_filter>
        
        <switch name="systems/fuel/inlet-a-togle">
            <default value="systems/fuel/inlet-a-togle"/>
            <test logic="AND" value="0">
                systems/fuel/inlet-a-togle == 1
                systems/fuel/refueling-operative == 0
                systems/fuel/tank-all-full == 1
            </test>
        </switch>
        
        <switch name="systems/fuel/inlet-a-open">
            <default value="0.0"/>
            <test logic="AND" value="1">
                systems/fuel/inlet-a-pos GT 0.95
            </test>
        </switch>
        
        <lag_filter name="systems/fuel/inlet-b-pos">
            <input>systems/fuel/inlet-b-togle</input>
            <c1>2.0</c1>
        </lag_filter>
        
        <switch name="systems/fuel/inlet-b-togle">
            <default value="systems/fuel/inlet-b-togle"/>
            <test logic="AND" value="0">
                systems/fuel/inlet-b-togle == 1
                systems/fuel/refueling-operative == 0
                systems/fuel/tank-all-full == 1
            </test>
        </switch>
        
        <switch name="systems/fuel/inlet-b-open">
            <default value="0.0"/>
            <test logic="AND" value="1">
                systems/fuel/inlet-b-pos GT 0.95
            </test>
        </switch>
        
        <switch name="systems/fuel/refuel-inlet-a-flow-rate-max-pps-lim">
            <default value="systems/fuel/refuel-inlet-a-flow-rate-max-pps"/>
            <test logic="AND" value="0">
                propulsion/tank[0]/pct-full GE 99.0
                systems/fuel/tank-all-full == 0
                systems/fuel/refueling-operative == 1
            </test>
        </switch>
        
        <pure_gain name="systems/fuel/refuel-inlet-a-flow-rate-pps">
            <input>systems/fuel/refuel-inlet-a-flow-rate-max-pps-lim</input>
            <gain>systems/fuel/inlet-a-open</gain>
        </pure_gain>
        
        <lag_filter name="systems/fuel/refuel-inlet-a-flow-rate-pps-lag">
            <input>systems/fuel/refuel-inlet-a-flow-rate-pps</input>
            <c1>0.8</c1>
        </lag_filter>
        
        <scheduled_gain name="systems/fuel/refuel-inlet-a-flow-rate-pps-lag-effect">
            <input>systems/fuel/refuel-inlet-flow-scale-effect</input>
            <table>
                <independentVar>systems/fuel/refuel-inlet-a-flow-rate-pps-lag</independentVar>
                <tableData>
                    0.0	0.00
                    0.1	0.20
                    0.2	0.30
                    0.5	0.40
                    1.0	0.90
                    9.0	1.00
                </tableData>
            </table>
            <gain>systems/lightning/ambient-light-emission-display-correction</gain>
        </scheduled_gain>
        
        <switch name="systems/fuel/refuel-inlet-b-flow-rate-max-pps-lim">
            <default value="systems/fuel/refuel-inlet-b-flow-rate-max-pps"/>
            <test logic="AND" value="0">
                propulsion/tank[2]/pct-full GE 99.0
                systems/fuel/tank-all-full == 0
                systems/fuel/refueling-operative == 1
            </test>
        </switch>
        
        <pure_gain name="systems/fuel/refuel-inlet-b-flow-rate-pps">
            <input>systems/fuel/refuel-inlet-b-flow-rate-max-pps-lim</input>
            <gain>systems/fuel/inlet-b-open</gain>
        </pure_gain>
        
        <lag_filter name="systems/fuel/refuel-inlet-b-flow-rate-pps-lag">
            <input>systems/fuel/refuel-inlet-b-flow-rate-pps</input>
            <c1>0.8</c1>
        </lag_filter>

        <scheduled_gain name="systems/fuel/refuel-inlet-b-flow-rate-pps-lag-effect">
            <input>systems/fuel/refuel-inlet-flow-scale-effect</input>
            <table>
                <independentVar>systems/fuel/refuel-inlet-b-flow-rate-pps-lag</independentVar>
                <tableData>
                    0.0	0.00
                    0.1	0.20
                    0.2	0.30
                    0.5	0.40
                    1.0	0.90
                    9.0	1.00
                </tableData>
            </table>
            <gain>systems/lightning/ambient-light-emission-display-correction</gain>
        </scheduled_gain>

    </channel>
    
</system>
