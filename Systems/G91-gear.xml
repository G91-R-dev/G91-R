<?xml version="1.0"?>

<!--
Description: G91R4 hydraulics system from "Manuale di pilotaggio (1-11,1-12, etc..)
-->

<system name="gear">
    
    <property value="-60">systems/gears/gear[0]/z</property>
    <property value="-55">systems/gears/gear[1]/z</property>
    <property value="-55">systems/gears/gear[2]/z</property>
    
    <channel name="Landing Gear control" execrate="8">
        
        <kinematic name="Gear Control">
            <input>gear/gear-cmd-norm</input>
            <traverse>
                <setting>
                    <position> 0 </position>
                    <time>     0 </time>
                </setting>
                <setting>
                    <position> 1 </position>
                    <time>     12 </time>
                </setting>
            </traverse>
            <output>gear/gear-pos-norm</output>
        </kinematic>
        
        <switch name="Set gear direction">
            <default value="0"/>
            <test logic="AND" value="1">
                gear/gear-cmd-norm EQ 0
                gear/gear-pos-norm GT 0
                gear/gear-pos-norm LT 1
            </test>
            <test logic="AND" value="-1">
                gear/gear-cmd-norm EQ 1
                gear/gear-pos-norm GT 0
                gear/gear-pos-norm LT 1
            </test>
            <output>gear/gear-direction</output>
        </switch>
        
        <fcs_function name="gear sound roumble">
            <function>
                <product>
                    <p>gear/gear-pos-norm</p>
                    <p>aero/qbar-psf</p>
                    <v>0.002</v>
                </product>
            </function>
            <output>gear/gear-pos-norm-sound-roumble</output>
        </fcs_function>
        
        <kinematic name="Gear Control Sound">
            <input>gear/gear-cmd-norm</input>
            <traverse>
                <setting>
                    <position> 0 </position>
                    <time>     0 </time>
                </setting>
                <setting>
                    <position> 1 </position>
                    <time>     17.5 </time>
                </setting>
            </traverse>
            <output>gear/gear-pos-norm-sound</output>
        </kinematic>
        
        <switch name="Set gear direction sound">
            <default value="0"/>
            <test logic="AND" value="1">
                gear/gear-cmd-norm EQ 0
                gear/gear-pos-norm-sound GT 0
                gear/gear-pos-norm-sound LT 1
            </test>
            <test logic="AND" value="-1">
                gear/gear-cmd-norm EQ 1
                gear/gear-pos-norm-sound GT 0
                gear/gear-pos-norm-sound LT 1
            </test>
            <output>gear/gear-direction-sound</output>
        </switch>
        
        <lag_filter name="systems/gears/gear[0]/slip-angle-calc-norm-lag">
            <input>systems/gears/gear[0]/slip-angle-calc-diff-v</input>
            <c1>0.5</c1>
        </lag_filter>
        
        <switch name="systems/gears/gear[0]/slip-angle-calc-norm">
            <default value="systems/gears/gear[0]/slip-angle-calc-norm"/>
            <test logic="AND" value="systems/gears/gear[0]/slip-angle-calc-norm-lag">
                systems/gears/gear[0]/slip-angle-calc-low-wheel-speed == 0.0
            </test>
        </switch>
    
        <pure_gain name="systems/gears/gear[0]/slip-angle-deg-lag">
            <input>systems/gears/gear[0]/slip-angle-calc-norm</input>
            <gain>40.0</gain>
            <clipto>
                <min>-40.0</min>
                <max>40.0</max>
            </clipto>
        </pure_gain>
        
    </channel>
    
    
    <channel name="Landing gear hydraulics extension" execrate="8">
        
        <summer>
            <input>systems/gears/gear[0]/z</input>
            <input>systems/gears/unit[0]/hydraulics-extension</input>
            <output>gear/unit[0]/z-position</output>
        </summer>
        
        <summer>
            <input>systems/gears/gear[1]/z</input>
            <input>systems/gears/unit[1]/hydraulics-extension</input>
            <output>gear/unit[1]/z-position</output>
        </summer>
        
        <summer>
            <input>systems/gears/gear[2]/z</input>
            <input>systems/gears/unit[2]/hydraulics-extension</input>
            <output>gear/unit[2]/z-position</output>
        </summer>
        
    </channel>
    
    
    <channel name="brake gear action">
        
        <lag_filter name="systems/gears/brake-rudder-lag-norm">
            <input>fcs/rudder-pos-norm</input>
            <c1>4.0</c1>
        </lag_filter>
        
        <lag_filter name="systems/gears/handle-brake-full-cmd-lag">
            <input>systems/handle-switches/sw-handle-brake-activate</input>
            <c1>2.0</c1>
        </lag_filter>
        
        <fcs_function name="fcs/left-brake-cmd-norm">
            <function>
                <product>
                    <sum>
                        <p>systems/gears/handle-brake-full-cmd-lag</p>
                        <product>
                            <table>
                                <independentVar>fcs/elevator-cmd-norm</independentVar>
                                <tableData>
                                    0.0  0.00
                                    0.4  0.20
                                    0.5  0.50
                                    0.6  0.80
                                    0.8  0.95
                                    1.0  1.00
                                </tableData>
                            </table>
                            <ifthen>
                                <gt>
                                    <p>fcs/rudder-pos-norm</p>
                                    <v>0.2</v>
                                </gt>    
                                <table>
                                    <independentVar>systems/gears/brake-rudder-lag-norm</independentVar>
                                    <tableData>
                                        0.0  0.0
                                        0.2  0.0
                                        0.5  0.02
                                        0.7  0.2
                                        1.0  1.0
                                    </tableData>
                                </table>
                                <ifthen>
                                    <and>
                                        <le>
                                            <p>fcs/rudder-pos-norm</p>
                                            <v>0.2</v>
                                        </le>
                                        <ge>
                                            <p>fcs/rudder-pos-norm</p>
                                            <v>-0.2</v>
                                        </ge>
                                    </and>
                                    <v>1.0</v>
                                    <v>0.0</v>
                                </ifthen>
                            </ifthen>
                            <table>
                                <independentVar>systems/hydraulics/flight-system-psi</independentVar>
                                <tableData>
                                    0.0  0.0
                                    2000.0 0.8
                                    3000.0 1.0
                                    4000.0 1.2
                                </tableData>
                            </table>
                        </product>
                    </sum>
                    <table>
                        <independentVar>gear/unit[2]/compression-ft</independentVar>
                        <tableData>
                            0.00 0.0
                            0.10 0.9
                            0.15 1.0
                            1.00 1.2
                        </tableData>
                    </table>
                    <v>2.0</v>
                </product>
            </function>
            <clipto>
                <min>0.0</min>
                <max>1.0</max>
            </clipto>
            <output>fcs/left-brake-cmd-norm</output>
        </fcs_function >
        
        <fcs_function name="fcs/right-brake-cmd-norm">
            <function>
                <product>
                    <sum>
                        <p>systems/gears/handle-brake-full-cmd-lag</p>
                        <product>
                            <table>
                                <independentVar>fcs/elevator-cmd-norm</independentVar>
                                <tableData>
                                    0.0  0.00
                                    0.4  0.20
                                    0.5  0.50
                                    0.6  0.80
                                    0.8  0.95
                                    1.0  1.00
                                </tableData>
                            </table>
                            <ifthen>
                                <lt>
                                    <p>fcs/rudder-pos-norm</p>
                                    <v>-0.2</v>
                                </lt>
                                <table>
                                    <independentVar>systems/gears/brake-rudder-lag-norm</independentVar>
                                    <tableData>
                                        -1.0  1.0
                                        -0.7  0.2
                                        -0.5  0.02
                                        -0.2  0.0
                                        0.0  0.0
                                    </tableData>
                                </table>
                                <ifthen>
                                    <and>
                                        <le>
                                            <p>fcs/rudder-pos-norm</p>
                                            <v>0.2</v>
                                        </le>
                                        <ge>
                                            <p>fcs/rudder-pos-norm</p>
                                            <v>-0.2</v>
                                        </ge>
                                    </and>
                                    <v>1.0</v>
                                    <v>0.0</v>
                                </ifthen>
                            </ifthen>
                            <table>
                                <independentVar>systems/hydraulics/flight-system-psi</independentVar>
                                <tableData>
                                    0.0  0.0
                                    2000.0 0.8
                                    3000.0 1.0
                                    4000.0 1.2
                                </tableData>
                            </table>
                        </product>
                    </sum>
                    <table>
                        <independentVar>gear/unit[1]/compression-ft</independentVar>
                        <tableData>
                            0.00 0.0
                            0.10 0.9
                            0.15 1.0
                            1.00 1.2
                        </tableData>
                    </table>
                    <v>2.0</v>
                </product>
            </function>
            <clipto>
                <min>0.0</min>
                <max>1.0</max>
            </clipto>
            <output>fcs/right-brake-cmd-norm</output>
        </fcs_function >
        
    </channel>
    
    <channel name="drag gear" execrate="8">
        
        <pure_gain>
            <input>systems/gears/gear[0]/drag-norm</input>
            <gain>2.0</gain>
            <output>external_reactions/LandingGearFrontAerodinamicDrag/magnitude</output>
        </pure_gain>
        
        <pure_gain>
            <input>systems/gears/gear[1]/drag-norm</input>
            <gain>4.0</gain>
            <output>external_reactions/LandingGearRightAerodinamicDrag/magnitude</output>
        </pure_gain>
        
        <pure_gain>
            <input>systems/gears/gear[2]/drag-norm</input>
            <gain>4.0</gain>
            <output>external_reactions/LandingGearLeftAerodinamicDrag/magnitude</output>
        </pure_gain>
        
    </channel>
    
    
    <function name="systems/gears/unit[0]/hydraulics-extension">
        <description>Extension main gear hydraulic cylinder</description>
        <table>
            <independentVar>systems/hydraulics/flight-system-psi</independentVar>
            <tableData>
                0.0 0.0
                1000.0 0.0
                3000.0 0.0
                4000.0 0.0
            </tableData>
        </table>
    </function>
    
    <function name="systems/gears/unit[1]/hydraulics-extension">
        <description>Extension main gear hydraulic cylinder</description>
        <table>
            <independentVar>systems/hydraulics/flight-system-psi</independentVar>
            <tableData>
                0.0  0.0
                3000.0 -5
                4000.0 -5
            </tableData>
        </table>
    </function>
    
    <function name="systems/gears/unit[2]/hydraulics-extension">
        <description>Extension main gear hydraulic cylinder</description>
        <table>
            <independentVar>systems/hydraulics/flight-system-psi</independentVar>
            <tableData>
                0.0  0.0
                3000.0 -5
                4000.0 -5
            </tableData>
        </table>
    </function>
    
    <function name="systems/gears/gear[0]/slip-angle-calc-low-wheel-speed">
        <ifthen>
            <and>
                <lt>
                    <p>gear/unit[0]/wheel-speed-fps</p>
                    <v>0.01</v>
                </lt>
                <gt>
                    <p>gear/unit[0]/wheel-speed-fps</p>
                    <v>-0.01</v>
                </gt>
            </and>
            <v>1.0</v>
            <v>0.0</v>
        </ifthen>
    </function>
    
    <function name="systems/gears/gear[0]/slip-angle-calc-diff-v">
        <ifthen>
            <ge>
                <p>gear/unit[0]/compression-ft</p>
                <v>0.01</v>
            </ge>
            <quotient>
                <difference>
                    <p>gear/unit[1]/wheel-speed-fps</p>
                    <p>gear/unit[2]/wheel-speed-fps</p>
                </difference>
                <v>2.0</v>
            </quotient>
            <v>0.0</v>
        </ifthen>
    </function>
    
    <function name="systems/gears/gear[0]/drag-norm">
        <product>
            <p>aero/qbar-psf</p>
            <table>
                <independentVar>gear/gear-pos-norm</independentVar>
                <tableData>
                    0.0  0.0
                    0.2  0.292
                    0.4  0.559
                    0.6  0.777
                    0.8  0.927
                    1.0  0.996
                </tableData>
            </table>
        </product>
    </function>
    
    <function name="systems/gears/gear[1]/drag-norm">
        <product>
            <p>aero/qbar-psf</p>
            <table>
                <independentVar>gear/gear-pos-norm</independentVar>
                <tableData>
                    0.0  0.0
                    0.2  0.309
                    0.4  0.588
                    0.6  0.809
                    0.8  0.951
                    1.0  1.000
                </tableData>
            </table>
        </product>
    </function>
    
    <function name="systems/gears/gear[2]/drag-norm">
        <product>
            <p>aero/qbar-psf</p>
            <table>
                <independentVar>gear/gear-pos-norm</independentVar>
                <tableData>
                    0.0  0.0
                    0.2  0.309
                    0.4  0.588
                    0.6  0.809
                    0.8  0.951
                    1.0  1.000
                </tableData>
            </table>
        </product>
    </function>
    
</system>

