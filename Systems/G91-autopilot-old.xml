<?xml version="1.0"?>

<!-- Autopilot JSBSim
Original work Copyright (c) 2019 Adriano Bassignana (abassign)

<property>/fdm/jsbsim/systems/gauges/cockpit-attitude-J8-horizon-offset</property>
-->

<system>
    
    <property value="0.0">systems/autopilot/gui/rudder-auto-coordination</property>
    
    <property value="0.0">systems/autopilot/gui/heading-control</property>
    <property value="0.0">systems/autopilot/gui/wing-leveler</property>
    <property value="0.0">systems/autopilot/gui/true-heading</property>
    <property value="0.0">systems/autopilot/gui/true-heading-deg</property>
    <property value="0.0">systems/autopilot/gui/phi-heading</property>
    
    <property value="0.0">systems/autopilot/gui/altitude-active</property>
    <property value="0.0">systems/autopilot/gui/vertical-speed</property>
    <property value="0.0">systems/autopilot/gui/vertical-speed-fpm</property>
    <property value="0.0">systems/autopilot/gui/pitch-hold</property>
    <property value="5.0">systems/autopilot/gui/pitch-hold-deg</property>
    
    <property value="0.0">systems/autopilot/gui/altitude-hold</property>
    <property value="0.0">systems/autopilot/gui/altitude-hold-ft</property>
    <property value="0.0">systems/autopilot/gui/altitude-hold-togle</property>
    
    <property value="0.0">systems/autopilot/gui/speed-control</property>
    <property value="1.0">systems/autopilot/gui/speed-throttle</property>
    <property value="0.0">systems/autopilot/gui/speed-pitch</property>
    <property value="0.0">systems/autopilot/gui/speed-brake</property>
    <property value="0.0">systems/autopilot/gui/speed-automatic-flap</property>
    <property value="0.0">systems/autopilot/gui/speed-automatic-gear</property>
    <property value="200.0">systems/autopilot/gui/speed-mph</property>
    <property value="0.0">systems/autopilot/gui/speed-mach</property>
    <property value="0.0">systems/autopilot/gui/speed-true-cas-mph</property>
    
    <property value="0.0">systems/autopilot/wing-leveler-active</property>
    <property value="0.0">systems/autopilot/wing-leveler-ap-on-off</property>
    <property value="0.5">systems/autopilot/wing-leveler-lag-coefficient</property>
    <property value="-1.0">systems/autopilot/wing-leveler-output-gain</property>
    
    <property value="0.0">systems/autopilot/true-heading-active</property>
    <property value="0.0">systems/autopilot/true-heading-ap-on-off</property>
    <property value="0.5">systems/autopilot/true-heading-lag-coefficient</property>
    <property value="30.0">systems/autopilot/gui/true-heading-max-wing-slope-deg</property>
    <property value="0.5">systems/autopilot/gui/true-heading-max-wing-slope-rad</property>
    <property value="0.0">systems/autopilot/gui/true-heading-turn-direction</property>
    <property value="0.0">systems/autopilot/true-heading-rad</property>
    <property value="0.0">systems/autopilot/heading-true-deg</property>
    <property value="0.0">systems/autopilot/true-heading-deg-delta</property>
    <property value="5.0">systems/autopilot/true-heading-pid-kp</property>
    <property value="0.1">systems/autopilot/true-heading-pid-ki</property>
    <property value="0.5">systems/autopilot/true-heading-pid-kd</property>
    <property value="0.5">systems/autopilot/true-heading-activate-lag-coefficient</property>
    <property value="0.0">systems/autopilot/phi-heading-active</property>
    <property value="0.0">systems/autopilot/phi-heading-deg</property>
    <property value="0.0">systems/autopilot/phi-heading-rad</property>
    <property value="4.0">systems/autopilot/phi-heading-brg-lag-coefficient</property>
    <property value="0.0">systems/autopilot/phi-rad-limited</property>
    
    <property value="0.0">systems/autopilot/rudder-active</property>
    <property value="0.0">systems/autopilot/rudder-rad-bias</property>
    <property value="1.0">systems/autopilot/rudder-Ny-gain</property>
    <property value="0.1">systems/autopilot/rudder-output-gain</property>
    <property value="0.0">systems/autopilot/rudder-rad</property>
    <property value="0.0">systems/autopilot/rudder-deg</property>
    <property value="0.8">systems/autopilot/rudder-pid-kp</property>
    <property value="0.8">systems/autopilot/rudder-pid-ki</property>
    <property value="0.2">systems/autopilot/rudder-pid-kd</property>
    <property value="0.0">systems/autopilot/rudder-ap-value-norm</property>
    
    <property value="0.0">systems/autopilot/gui/pitch-hold-active</property>
    <property value="0.0">systems/autopilot/gui/pitch-hold-ap-on-off</property>
    
    <property value="0.0">systems/autopilot/v-up-fpm</property>
    <property value="0.0">systems/autopilot/elevator-cmd</property>
    <property value="5.0">systems/autopilot/pitch-pid-kp</property>
    <property value="1.0">systems/autopilot/pitch-pid-ki</property>
    <property value="5.0">systems/autopilot/pitch-pid-kd</property>
    <property value="-0.25">systems/autopilot/pitch-error-coefficient</property>
    <property value="0.0">systems/autopilot/pitch-ap-autoswitch-norm</property>
    
    <property value="0.0">systems/autopilot/vertical-speed-fpm</property>
    <property value="0.0">systems/autopilot/vertical-speed-active</property>
    <property value="0.0">systems/autopilot/vertical-speed-reset-integrator</property>
    <property value="0.4">systems/autopilot/vertical-speed-pid-kp</property>
    <property value="0.1">systems/autopilot/vertical-speed-pid-ki</property>
    <property value="0.1">systems/autopilot/vertical-speed-pid-kd</property>
    <property value="0.4">systems/autopilot/vertical-speed-error-coefficient</property>
    <property value="1000.0">systems/autopilot/vertical-speed-error-convergence-norm</property>
    <property value="0.0">systems/autopilot/vertical-speed-pitch-error-gain</property>
    
    <property value="0.5">systems/autopilot/gui/h-sl-ft-lag-coefficient</property>
    <property value="0.0">systems/autopilot/gui/altitude-hold-active</property>
    <property value="0.0">systems/autopilot/altitude-hold-versus-lag</property>
    <property value="2.0">systems/autopilot/altitude-hold-versus-lag-C1</property>
    <property value="0.0">systems/autopilot/altitude-hold-limitator-active</property>
    <property value="0.0">systems/autopilot/altitude-hold-ap-saturated</property>
    <property value="0.5">systems/autopilot/altitude-hold-lag-coefficient</property>
    <property value="0.1">systems/autopilot/altitude-hold-fdm-lag-coefficient</property>
    <property value="0.0">systems/autopilot/altitude-hold-pitch-error-lag</property>
    <property value="1.0">systems/autopilot/altitude-hold-pid-kp</property>
    <property value="0.0">systems/autopilot/altitude-hold-pid-ki</property>
    <property value="1.0">systems/autopilot/altitude-hold-pid-kd</property>
    <property value="0.003">systems/autopilot/altitude-hold-error-coefficient</property>
    
    <property value="3.0">systems/autopilot/roll-pid-kp</property>
    <property value="0.5">systems/autopilot/roll-pid-ki</property>
    <property value="1.5">systems/autopilot/roll-pid-kd</property>
    <property value="0.0">systems/autopilot/roll-ap-autoswitch-norm</property>
    
    <property value="0.0">systems/autopilot/speed-true-on-air-mph</property>
    <property value="0.0">systems/autopilot/speed-cas-on-air-mph</property>
    <property value="1.0">systems/autopilot/speed-set-cas-mph</property>
    <property value="0.0">systems/autopilot/speed-true-on-air-mph-sec</property>
    <property value="0.0">systems/autopilot/speed-throttle-active</property>
    <property value="0.003">systems/autopilot/speed-throttle-input-gain</property>
    <property value="0.0">systems/autopilot/speed-throttle-ap-saturated</property>
    <property value="1.0">systems/autopilot/speed-throttle-kp</property>
    <property value="0.01">systems/autopilot/speed-throttle-ki</property>
    <property value="0.8">systems/autopilot/speed-throttle-kd</property>
    <property value="0.01">systems/autopilot/speed-throttle-output-gain</property>
    
    <property value="0.0">systems/autopilot/speed-pitch-active</property>
    <property value="0.0">systems/autopilot/speed-speed-brake-active</property>
    <property value="0.0">systems/autopilot/speed-automatic-flap-active</property>
    <property value="0.0">systems/autopilot/speed-automatic-gear-active</property>
    
    <property value="0.0">systems/autopilot/fuel-total-lbs</property>
    <property value="0.0">systems/autopilot/fuel-droppable-auto</property>
    <property value="0.0">systems/autopilot/fuel-droppable-total-lbs</property>
    <property value="0.0">systems/autopilot/fuel-droppable-remain-lbs</property>
    <property value="0.0">systems/autopilot/fuel-flow-rate-lbhr</property>
    <property value="0.0">systems/autopilot/fuel-remain-lbs</property>
    <property value="0.0">systems/autopilot/fuel-remain-percent</property>
    <property value="0.0">systems/autopilot/fuel-time-residue-sec</property>
    <property value="0.0">systems/autopilot/fuel-time-residue-h</property>
    <property value="0.0">systems/autopilot/fuel-nm-residue</property>
    
    <property value="0.0">systems/autopilot/propulsion-specific-con</property>
    
    
    <channel name="Autopilot GUI Interface" execrate="32">
        
        <switch name="systems/autopilot/wing-leveler-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/heading-control == 1.0
                systems/autopilot/gui/wing-leveler == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/true-heading-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                <test logic="AND">
                    systems/autopilot/gui/heading-control == 1.0
                </test>
                <test logic="OR">
                    systems/autopilot/gui/true-heading == 1.0
                    systems/autopilot/phi-heading-active == 1.0
                </test>
            </test>
        </switch>
        
        <switch name="systems/autopilot/phi-heading-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/heading-control == 1.0
                systems/autopilot/gui/phi-heading == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/rudder-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/rudder-auto-coordination == 1.0
            </test>
        </switch>

        <switch name="systems/autopilot/gui/pitch-hold-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/altitude-active == 1.0
                systems/autopilot/gui/pitch-hold == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/vertical-speed-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/altitude-active == 1.0
                systems/autopilot/gui/vertical-speed == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/gui/altitude-hold-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/altitude-active == 1.0
                systems/autopilot/gui/altitude-hold == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/speed-throttle-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/speed-control == 1.0
                systems/autopilot/gui/speed-throttle == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/speed-pitch-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/speed-control == 1.0
                systems/autopilot/gui/speed-pitch == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/speed-brake-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/speed-control == 1.0
                systems/autopilot/gui/speed-brake == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/speed-automatic-flap-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/speed-control == 1.0
                systems/autopilot/gui/speed-automatic-flap == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/speed-automatic-gear-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/speed-control == 1.0
                systems/autopilot/gui/speed-automatic-gear == 1.0
            </test>
        </switch>
        
    </channel>
    
    
    <channel name="Heading control">
        
        <pure_gain name="systems/autopilot/true-heading-rad">
            <input>systems/autopilot/gui/true-heading-deg</input>
            <gain>0.0174533</gain>
        </pure_gain>
        
        <pure_gain name="systems/autopilot/heading-true-deg">
            <input>attitude/heading-true-rad</input>
            <gain>57.2958</gain>
        </pure_gain>
        
        <fcs_function name="systems/autopilot/phi-heading-deg">
            <function>
                <ifthen>
                    <p>systems/gauges/PHI/program/route-from</p>
                    <difference>
                        <p>systems/gauges/PHI/indicator/brg-correct</p>
                        <v>180</v>
                    </difference>
                    <p>systems/gauges/PHI/indicator/brg-correct</p>
                </ifthen>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/phi-heading-deg-lag">
            <input>systems/autopilot/phi-heading-deg</input>
            <c1>systems/autopilot/phi-heading-brg-lag-coefficient</c1>
        </lag_filter>
        
        <pure_gain name="systems/autopilot/phi-heading-rad">
            <input>systems/autopilot/phi-heading-deg-lag</input>
            <gain>0.0174533</gain>
        </pure_gain>
        
        <pure_gain name="systems/autopilot/true-heading-max-wing-slope-rad">
            <input>systems/autopilot/gui/true-heading-max-wing-slope-deg</input>
            <gain>0.0174533</gain>
        </pure_gain>
        

        <switch name="systems/autopilot/true-heading-rad-prop">
            <default value="systems/autopilot/true-heading-rad"/>
            <test logic="AND" value="systems/autopilot/phi-heading-rad">
                systems/autopilot/phi-heading-active == 1
            </test>
        </switch>
        
        <summer name="systems/autopilot/true-heading-rad-prop-dif">
            <input>systems/autopilot/true-heading-rad-prop</input>
            <input>-attitude/heading-true-rad</input>
        </summer>
        
        <fcs_function name="systems/autopilot/true-heading-rad-delta">
            <function>
                <ifthen>
                    <ge><p>systems/autopilot/true-heading-rad-prop-dif</p><pi/></ge>
                    <difference>
                        <p>systems/autopilot/true-heading-rad-prop-dif</p>
                        <product><pi/><v>2.0</v></product>
                    </difference>
                    <ifthen>
                        <lt><p>systems/autopilot/true-heading-rad-prop-dif</p><product><pi/><v>-1.0</v></product></lt>
                        <sum>
                            <p>systems/autopilot/true-heading-rad-prop-dif</p>
                            <product><pi/><v>2.0</v></product>
                        </sum>
                        <p>systems/autopilot/true-heading-rad-prop-dif</p>
                    </ifthen>
                </ifthen>
            </function>
        </fcs_function>

        <pure_gain name="systems/autopilot/true-heading-deg-delta">
            <input>systems/autopilot/true-heading-rad-delta</input>
            <gain>57.2958</gain>
        </pure_gain>
        
        <pure_gain name="systems/autopilot/true-heading-rad-delta-lim">
            <input>systems/autopilot/true-heading-rad-delta</input>
            <gain>1.0</gain>
            <clipto>
                <min>-0.2</min>
                <max>0.2</max>
            </clipto>
        </pure_gain>
        
        <pid name="systems/autopilot/true-heading-rad-delta-pid">
            <input>systems/autopilot/true-heading-rad-delta-lim</input>
            <kp>systems/autopilot/true-heading-pid-kp</kp>
            <ki>systems/autopilot/true-heading-pid-ki</ki>
            <kd>systems/autopilot/true-heading-pid-kd</kd>
            <trigger>systems/autopilot/true-heading-ap-on-off</trigger>
        </pid>
        
        <switch name="systems/autopilot/true-heading-ap-on-off">
            <default value="-1"/>
            <test logic="AND" value="2">
                <test logic="AND">
                    systems/autopilot/true-heading-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/true-heading-rad-delta-lim GE 0.2
                    systems/autopilot/true-heading-rad-delta-lim LE -0.2
                </test>
            </test>
            <test logic="AND" value="0">
                systems/autopilot/true-heading-active == 1
            </test>
        </switch>
        
        <pure_gain name="systems/autopilot/true-heading-turn-direction-versus-slope">
            <input>systems/autopilot/true-heading-rad-delta-pid</input>
            <gain>systems/autopilot/true-heading-max-wing-slope-rad</gain>
        </pure_gain>
        
        <switch name="systems/autopilot/true-heading-turn-direction-versus-slope-sw">
            <default value="0"/>
            <test logic="AND" value="systems/autopilot/true-heading-turn-direction-versus-slope">
                systems/autopilot/true-heading-active == 1
            </test>
        </switch>
        
        <lag_filter name="systems/autopilot/true-heading-turn-direction-versus-slope-sw-lag">
            <input>systems/autopilot/true-heading-turn-direction-versus-slope-sw</input>
            <c1>systems/autopilot/true-heading-activate-lag-coefficient</c1>
        </lag_filter>
        
        <pure_gain name="systems/autopilot/true-heading-turn-direction-versus-slope-sw-lag-deg">
            <input>systems/autopilot/true-heading-turn-direction-versus-slope-sw-lag</input>
            <gain>57.2958</gain>
        </pure_gain>
        
        <summer name="systems/autopilot/phi-rad-limited">
            <input>attitude/phi-rad</input>
            <input>-systems/autopilot/true-heading-turn-direction-versus-slope-sw-lag</input>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </summer>
        
        <pid name="systems/autopilot/wing-leveler-ap-pid">
            <input>systems/autopilot/phi-rad-limited</input>
            <kp>systems/autopilot/roll-pid-kp</kp>
            <ki>systems/autopilot/roll-pid-ki</ki>
            <kd>systems/autopilot/roll-pid-kd</kd>
            <trigger>systems/autopilot/wing-leveler-ap-on-off</trigger>
        </pid>
        
        <switch name="systems/autopilot/wing-leveler-ap-on-off">
            <default value="-1"/>
            <test logic="AND" value="2">
                <test logic="OR">
                    systems/autopilot/wing-leveler-active == 1
                    systems/autopilot/true-heading-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/phi-rad-limited GE 1.0
                    systems/autopilot/phi-rad-limited LE -1.0
                </test>
            </test>
            <test logic="AND" value="0">
                systems/autopilot/wing-leveler-active == 1
            </test>
        </switch>
        
        <switch name="systems/autopilot/wing-leveler-ap-autoswitch">
            <default value="0"/>
            <test logic="OR" value="systems/autopilot/wing-leveler-ap-pid">
                systems/autopilot/wing-leveler-active == 1
                systems/autopilot/true-heading-active == 1
            </test>
        </switch>

        <!-- output -->
        
        <pure_gain name="systems/autopilot/roll-ap-autoswitch-norm">
            <input>systems/autopilot/wing-leveler-ap-autoswitch</input>
            <gain>systems/autopilot/wing-leveler-output-gain</gain>
        </pure_gain>

    </channel>
    
    
    <channel name="Rudder control">
        
        <pure_gain name="systems/autopilot/rudder-rad">
            <input>accelerations/n-pilot-y-norm</input>
            <gain>systems/autopilot/rudder-Ny-gain</gain>
        </pure_gain>
        
        <pure_gain name="systems/autopilot/rudder-deg">
            <input>systems/autopilot/rudder-rad</input>
            <gain>57.2958</gain>
        </pure_gain>
        
        <summer name="systems/autopilot/rudder-rad-limited">
            <input>systems/autopilot/rudder-rad</input>
            <input>systems/autopilot/rudder-rad-bias</input>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </summer>
        
        <switch name="systems/autopilot/rudder-ap-on-off">
            <default value="-1"/>
            <test logic="AND" value="2">
                <test logic="AND">
                    systems/autopilot/rudder-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/rudder-rad-limited GE 1.0
                    systems/autopilot/rudder-rad-limited LE -1.0
                </test>
            </test>
            <test logic="AND" value="0">
                systems/autopilot/rudder-active == 1
            </test>
        </switch>
        
        <pid name="systems/autopilot/rudder-ap-pid">
            <input>systems/autopilot/rudder-rad-limited</input>
            <kp>systems/autopilot/rudder-pid-kp</kp>
            <ki>systems/autopilot/rudder-pid-ki</ki>
            <kd>systems/autopilot/rudder-pid-kd</kd>
            <trigger>systems/autopilot/rudder-ap-on-off</trigger>
        </pid>
        
        <switch name="systems/autopilot/rudder-ap-value">
            <default value="0"/>
            <test logic="OR" value="systems/autopilot/rudder-ap-pid">
                systems/autopilot/rudder-active == 1
            </test>
        </switch>

        <!-- output -->
        
        <pure_gain name="systems/autopilot/rudder-ap-value-norm">
            <input>systems/autopilot/rudder-ap-value</input>
            <gain>systems/autopilot/rudder-output-gain</gain>
        </pure_gain>
        
    </channel>
    
    
    <channel name="Altitude control">
        
        <switch name="systems/autopilot/gui/pitch-hold-ap-on-off">
            <default value="-1"/>
            <test logic="AND" value="0">
                systems/autopilot/gui/pitch-hold-active == 1
            </test>
        </switch>
        
        <pure_gain name="systems/autopilot/v-up-fpm">
            <input>velocities/v-down-fps</input>
            <gain>-60</gain>
        </pure_gain>
        
        <lag_filter name="systems/autopilot/v-up-fpm-lag">
            <input>systems/autopilot/v-up-fpm</input>
            <c1>0.1</c1>
        </lag_filter>
        
        <lag_filter name="systems/autopilot/h-sl-ft-lag">
            <input>position/h-sl-ft</input>
            <c1>systems/autopilot/gui/h-sl-ft-lag-coefficient</c1>
        </lag_filter>

        <!-- Pitch section -->
        
        <fcs_function name="systems/autopilot/pitch-hold-deg-mod">
            <function>
                <ifthen>
                    <p>systems/autopilot/gui/altitude-hold-active</p>
                    <product>
                        <p>systems/autopilot/altitude-hold-pitch-error-lag</p>
                        <product>
                            <p>systems/autopilot/altitude-hold-versus-lag</p>
                            <abs><p>systems/autopilot/gui/pitch-hold-deg</p></abs>
                        </product>
                    </product>
                    <p>systems/autopilot/gui/pitch-hold-deg</p>
                </ifthen>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/pitch-rad-error">
            <function>
                <difference>
                    <ifthen>
                        <p>systems/autopilot/gui/pitch-hold-active</p>
                        <toradians>
                            <p>systems/autopilot/pitch-hold-deg-mod</p>
                        </toradians>
                        <ifthen>
                            <p>systems/autopilot/vertical-speed-active</p>
                            <p>systems/autopilot/vertical-speed-pitch-error-gain</p>
                            <p>attitude/pitch-rad</p>
                        </ifthen>
                    </ifthen>
                    <p>attitude/pitch-rad</p>
                </difference>
            </function>
            <clipto>
                <min>-0.25</min>
                <max>0.25</max>
            </clipto>
        </fcs_function>
        
        <pid name="systems/autopilot/pitch-speed-ap-pid">
            <input>systems/autopilot/pitch-rad-error</input>
            <kp>systems/autopilot/pitch-pid-kp</kp>
            <ki>systems/autopilot/pitch-pid-ki</ki>
            <kd>systems/autopilot/pitch-pid-kd</kd>
            <trigger>systems/autopilot/gui/pitch-hold-ap-on-off</trigger>
        </pid>
        
        <pure_gain name="systems/autopilot/pitch-error">
            <input>systems/autopilot/pitch-speed-ap-pid</input>
            <gain>systems/autopilot/pitch-error-coefficient</gain>
        </pure_gain> 
        
        <!-- Vertical speed section -->
        
        <fcs_function name="systems/autopilot/vertical-speed-fpm">
            <function>
                <ifthen>
                    <and>
                        <eq><p>systems/autopilot/vertical-speed-active</p><v>1.0</v></eq>
                        <eq><p>systems/autopilot/gui/altitude-hold-active</p><v>1.0</v></eq>
                    </and>
                    <product>
                        <p>systems/autopilot/altitude-hold-versus</p>
                        <p>systems/autopilot/gui/vertical-speed-fpm</p>
                        <p>systems/autopilot/altitude-hold-ap-pid-norm</p>
                    </product>
                    <p>systems/autopilot/gui/vertical-speed-fpm</p>
                </ifthen>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/vertical-speed-error-norm">
            <function>
                <atan>
                    <quotient>
                        <difference>
                            <p>systems/autopilot/vertical-speed-fpm</p>
                            <p>systems/autopilot/v-up-fpm</p>
                        </difference>
                        <p>systems/autopilot/vertical-speed-error-convergence-norm</p>
                    </quotient>
                </atan>
            </function>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </fcs_function>

        <pid name="systems/autopilot/vertical-speed-ap-pid-norm">
            <input>systems/autopilot/vertical-speed-error-norm</input>
            <kp>systems/autopilot/vertical-speed-pid-kp</kp>
            <ki>systems/autopilot/vertical-speed-pid-ki</ki>
            <kd>systems/autopilot/vertical-speed-pid-kd</kd>
            <trigger>systems/autopilot/vertical-speed-reset-integrator</trigger>
        </pid>
        
        <switch name="systems/autopilot/vertical-speed-reset-integrator">
            <default value="-1"/>
            <test logic="AND" value="0">
                systems/autopilot/vertical-speed-active == 1
                systems/autopilot/vertical-speed-ap-pid-norm LT 0.5
                systems/autopilot/vertical-speed-ap-pid-norm GT -0.5
            </test>
            <test logic="AND" value="2">
                <test logic="AND">
                    systems/autopilot/vertical-speed-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/vertical-speed-ap-pid-norm GE 0.5
                    systems/autopilot/vertical-speed-ap-pid-norm LE 0.5
                </test>
            </test>
        </switch>
        
        <pure_gain name="systems/autopilot/vertical-speed-pitch-error-gain">
            <input>systems/autopilot/vertical-speed-ap-pid-norm</input>
            <gain>systems/autopilot/vertical-speed-error-coefficient</gain>
        </pure_gain> 
        
        <!-- Altitude hold section -->
        
        <fcs_function name="systems/autopilot/altitude-hold-versus">
            <function>
                <ifthen>
                    <ge>
                        <difference>
                            <p>systems/autopilot/gui/altitude-hold-ft</p>
                            <p>systems/autopilot/h-sl-ft-lag</p>
                        </difference>
                        <v>0.0</v>
                    </ge>
                    <v>1.0</v>
                    <v>-1.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/altitude-hold-versus-lag">
            <input>systems/autopilot/altitude-hold-versus</input>
            <c1>systems/autopilot/altitude-hold-versus-lag-C1</c1>
        </lag_filter>
        
        <fcs_function name="systems/autopilot/altitude-hold-error-norm">
            <function>
                <product>
                    <difference>
                        <p>systems/autopilot/gui/altitude-hold-ft</p>
                        <p>systems/autopilot/h-sl-ft-lag</p>
                    </difference>
                    <p>systems/autopilot/altitude-hold-error-coefficient</p>
                    <p>systems/autopilot/altitude-hold-versus-lag</p>
                </product>
            </function>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </fcs_function>
        
        <switch name="systems/autopilot/altitude-hold-limitator-active">
            <default value="0"/>
            <test logic="AND" value="1">
                <test logic="OR">
                    systems/autopilot/gui/pitch-hold-active == 1
                    systems/autopilot/vertical-speed-active == 1
                </test>
                <test logic="AND">
                    systems/autopilot/gui/altitude-hold-active == 1
                </test>
            </test>
        </switch>
        
        <switch name="systems/autopilot/altitude-hold-reset-integrator">
            <default value="-1"/>
            <test logic="AND" value="0">
                systems/autopilot/altitude-hold-limitator-active == 1
            </test>
            <test logic="AND" value="2">
                systems/autopilot/altitude-hold-limitator-active == 1
                systems/autopilot/altitude-hold-ap-saturated == 1
            </test>
        </switch>
        
        <pid name="systems/autopilot/altitude-hold-ap-pid-norm">
            <input>systems/autopilot/altitude-hold-error-norm</input>
            <kp>systems/autopilot/altitude-hold-pid-kp</kp>
            <ki>systems/autopilot/altitude-hold-pid-ki</ki>
            <kd>systems/autopilot/altitude-hold-pid-kd</kd>
            <trigger>systems/autopilot/altitude-hold-reset-integrator</trigger>
        </pid>
        
        <switch name="systems/autopilot/altitude-hold-ap-saturated">
            <default value="0"/>
            <test logic="OR" value="1">
                systems/autopilot/vertical-speed-ap-pid-norm GE 1.0
                systems/autopilot/vertical-speed-ap-pid-norm LE -1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/altitude-hold-ap-pid-norm-active">
            <default value="1"/>
            <test logic="AND" value="systems/autopilot/altitude-hold-ap-pid-norm">
                systems/autopilot/altitude-hold-limitator-active == 1
            </test>
        </switch>
        
        <lag_filter name="systems/autopilot/altitude-hold-pitch-error-lag-to-switch">
            <input>systems/autopilot/altitude-hold-ap-pid-norm-active</input>
            <c1>systems/autopilot/altitude-hold-lag-coefficient</c1>
        </lag_filter>
        
        <switch name="systems/autopilot/altitude-hold-pitch-error-lag">
            <default value="1"/>
            <test logic="AND" value="systems/autopilot/altitude-hold-pitch-error-lag-to-switch">
                systems/autopilot/gui/pitch-hold-active == 1
            </test>
        </switch>
        
        <!-- output select section -->
        
        <switch name="systems/autopilot/pitch-ap-autoswitch-norm">
            <default value="0"/>
            <test logic="AND" value="systems/autopilot/pitch-error">
                systems/autopilot/gui/pitch-hold-active == 1
            </test>
            <test logic="AND" value="systems/autopilot/pitch-error">
                systems/autopilot/vertical-speed-active == 1
            </test>
        </switch>

    </channel>
    
    
    <channel name="Fuel control" execrate="16">
        
        <switch name="systems/autopilot/fuel-total-lbs">
            <default value="systems/autopilot/fuel-total-lbs"/>
            <test logic="AND" value="propulsion/total-fuel-lbs">
                propulsion/total-fuel-lbs GT systems/autopilot/fuel-total-lbs
            </test>
        </switch>
        
        <summer name="systems/autopilot/fuel-droppable-remain-lbs">
            <input>propulsion/tank[3]/contents-lbs</input>
            <input>propulsion/tank[4]/contents-lbs</input>
        </summer>
        
        <switch name="systems/autopilot/fuel-droppable-total-lbs">
            <default value="systems/autopilot/fuel-droppable-total-lbs"/>
            <test logic="AND" value="systems/autopilot/fuel-droppable-remain-lbs">
                systems/autopilot/fuel-droppable-remain-lbs GT systems/autopilot/fuel-droppable-total-lbs
            </test>
        </switch>
        
        <lag_filter name="systems/autopilot/fuel-flow-rate-pps-lag">
            <input>propulsion/engine/fuel-flow-rate-pps</input>
            <c1>0.1</c1>
        </lag_filter>
        
        <pure_gain name="systems/autopilot/fuel-flow-rate-lbhr">
            <input>systems/autopilot/fuel-flow-rate-pps-lag</input>
            <gain>3600.0</gain>
        </pure_gain>
        
        <summer name="systems/autopilot/fuel-remain-lbs">
            <input>systems/autopilot/fuel-total-lbs</input>
            <input>-propulsion/engine/fuel-used-lbs</input>
        </summer>
        
        <fcs_function name="systems/autopilot/fuel-remain-percent">
            <function>
                <ifthen>
                    <gt><p>systems/autopilot/fuel-total-lbs</p><v>1.0</v></gt>
                    <product>
                        <quotient>
                            <p>systems/autopilot/fuel-remain-lbs</p>
                            <p>systems/autopilot/fuel-total-lbs</p>
                        </quotient>
                        <v>100.0</v>
                    </product>
                    <v>0.0</v>
                </ifthen>
            </function>
            <clipto>
                <min>0.0</min>
                <max>100.0</max>
            </clipto>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/fuel-time-residue-sec">
            <function>
                <ifthen>
                    <gt><p>systems/autopilot/fuel-flow-rate-pps-lag</p><v>0.01</v></gt>
                    <quotient>
                        <p>systems/autopilot/fuel-remain-lbs</p>
                        <p>systems/autopilot/fuel-flow-rate-pps-lag</p>
                    </quotient>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <pure_gain name="systems/autopilot/fuel-mph-residue">
            <input>systems/autopilot/fuel-time-residue-sec</input>
            <gain>systems/autopilot/speed-true-on-air-mph-sec</gain>
        </pure_gain>
        
        <!-- Droppable tanks -->
        
        <switch name="systems/starter/drop-tank-press">
            <default value="systems/starter/drop-tank-press"/>
            <test logic="AND" value="1.0">
                systems/autopilot/fuel-droppable-remain-lbs GT 1.0
                systems/autopilot/fuel-droppable-auto == 1
            </test>
        </switch>
        
        <switch name="systems/starter/drop-tank-press">
            <default value="systems/starter/drop-tank-press"/>
            <test logic="AND" value="0.0">
                systems/autopilot/fuel-droppable-remain-lbs LE 1.0
                systems/autopilot/fuel-droppable-auto == 1
            </test>
        </switch>
    
    </channel>
    
    
    <channel name="Propulsion control" execrate="16">

        <fcs_function name="systems/autopilot/propulsion-specific-con">
            <function>
                <ifthen>
                    <gt><p>propulsion/engine/thrust-lbs</p><v>1.0</v></gt>
                    <quotient>
                        <p>systems/autopilot/fuel-flow-rate-lbhr</p>
                        <p>propulsion/engine/thrust-lbs</p>
                    </quotient>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
    </channel>
    
    
    <channel name="Speed control">
        
        <fcs_function name="systems/autopilot/speed-true-on-air-mph">
            <function>
                <ifthen>
                    <gt><p>velocities/vtrue-kts</p><v>50.0</v></gt>
                    <p>velocities/vtrue-kts</p>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/speed-cas-on-air-mph">
            <function>
                <ifthen>
                    <gt><p>velocities/vc-kts</p><v>50.0</v></gt>
                    <p>velocities/vc-kts</p>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <pure_gain name="systems/autopilot/speed-true-on-air-mph-sec">
            <input>systems/autopilot/speed-true-on-air-mph</input>
            <gain>0.00027777</gain>
        </pure_gain>
        
        <fcs_function name="systems/autopilot/speed-mph-difference">
            <function>
                <ifthen>
                    <p>systems/autopilot/speed-throttle-active</p>
                    <product>
                        <difference>
                            <p>systems/autopilot/gui/speed-mph</p>
                            <ifthen>
                                <p>systems/autopilot/speed-set-cas-mph</p>
                                <p>systems/autopilot/speed-cas-on-air-mph</p>
                                <p>systems/autopilot/speed-true-on-air-mph</p>
                            </ifthen>
                        </difference>
                        <p>systems/autopilot/speed-throttle-input-gain</p>
                    </product>
                    <v>0.0</v>
                </ifthen>
            </function>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </fcs_function>
        
        <switch name="systems/autopilot/speed-throttle-ap-saturated">
            <default value="-1"/>
            <test logic="AND" value="0">
                systems/autopilot/speed-throttle-active == 1
                systems/autopilot/speed-mph-difference LT 0.5
                systems/autopilot/speed-mph-difference GT -0.5
            </test>
            <test logic="AND" value="2">
                <test logic="AND">
                    systems/autopilot/speed-throttle-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/speed-mph-difference GE 0.5
                    systems/autopilot/speed-mph-difference LE -0.5
                </test>
            </test>
        </switch>
        
        <pid name="systems/autopilot/speed-mph-pid">
            <input>systems/autopilot/speed-mph-difference</input>
            <kp>systems/autopilot/speed-throttle-kp</kp>
            <ki>systems/autopilot/speed-throttle-ki</ki>
            <kd>systems/autopilot/speed-throttle-kd</kd>
            <trigger>systems/autopilot/speed-throttle-ap-saturated</trigger>
        </pid>
        
        <pure_gain name="systems/autopilot/speed-mph-pid-gain">
            <input>systems/autopilot/speed-mph-pid</input>
            <gain>systems/autopilot/speed-throttle-output-gain</gain>
        </pure_gain>
        
        <summer name="systems/autopilot/speed-mph-pid-gain-sum">
            <input>systems/autopilot/speed-mph-pid-gain</input>
            <input>/controls/engines/engine/throttle</input>
        </summer>
        
        <switch name="systems/autopilot/speed-mph-pid-output">
            <default value="/controls/engines/engine/throttle"/>
            <test logic="AND" value="systems/autopilot/speed-mph-pid-gain-sum">
                systems/autopilot/speed-throttle-active == 1
                systems/autopilot/speed-mph-pid-gain-sum GE 0.3
                systems/autopilot/speed-mph-pid-gain-sum LE 0.90
            </test>
            <test logic="AND" value="0.90">
                systems/autopilot/speed-throttle-active == 1
                systems/autopilot/speed-mph-pid-gain-sum GT 0.90
            </test>
            <test logic="AND" value="0.3">
                systems/autopilot/speed-throttle-active == 1
                systems/autopilot/speed-mph-pid-gain-sum LT 0.3
            </test>
            <output>/controls/engines/engine/throttle</output>
        </switch>
        
    </channel>
    
    
</system>
