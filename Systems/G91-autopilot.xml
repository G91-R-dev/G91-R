<?xml version="1.0"?>

<!-- Autopilot JSBSim
Original work Copyright (c) 2019 Adriano Bassignana (abassign)

The PID configurator is defined by: Zieglerâ€“Nichols method
https://en.wikipedia.org/wiki/Ziegler%E2%80%93Nichols_method
With the four variants:
Zingler-Nichols Classic
Possen Integral Rule
Some Overshoot
No Overshoot
-->

<system>
    
    <property value="0.0">systems/autopilot/phase-take-off</property>
    <property value="0.0">systems/autopilot/phase-landing</property>
    
    <!-- GUI data -->
    
    <property value="0.0">systems/autopilot/gui/rudder-auto-coordination</property>
    <property value="0.0">systems/autopilot/gui/heading-control</property>
    <property value="0.0">systems/autopilot/gui/wing-leveler</property>
    <property value="0.0">systems/autopilot/gui/true-heading</property>
    <property value="0.0">systems/autopilot/gui/true-heading-deg</property>
    <property value="0.0">systems/autopilot/gui/phi-heading</property>
    
    <property value="0.0">systems/autopilot/gui/pitch-alpha</property>
    <property value="0.0">systems/autopilot/gui/pitch-alpha-deg</property>
    <property value="0.0">systems/autopilot/gui/altitude-active</property>
    <property value="0.0">systems/autopilot/gui/vertical-speed</property>
    <property value="2500.0">systems/autopilot/gui/vertical-speed-fpm</property>
    <property value="1.0">systems/autopilot/gui/pitch-angle</property>
    <property value="0.0">systems/autopilot/gui/pitch-angle-deg</property>
    
    <property value="0.0">systems/autopilot/gui/altitude-hold</property>
    <property value="0.0">systems/autopilot/gui/altitude-hold-ft</property>
    <property value="0.0">systems/autopilot/gui/altitude-hold-togle</property>
    
    <property value="0.0">systems/autopilot/gui/altitude-QFE</property>
    <property value="1000.0">systems/autopilot/gui/altitude-QFE-ft</property>
    
    <property value="0.0">systems/autopilot/gui/speed-control</property>
    <property value="1.0">systems/autopilot/gui/speed-throttle</property>
    <property value="0.0">systems/autopilot/gui/speed-pitch</property>
    <property value="0.0">systems/autopilot/gui/speed-brake</property>
    <property value="0.0">systems/autopilot/gui/speed-automatic-flap</property>
    <property value="0.0">systems/autopilot/gui/speed-automatic-gear</property>
    <property value="250.0">systems/autopilot/gui/speed-value</property>
    <property value="0.0">systems/autopilot/gui/speed-set-mph</property>
    <property value="1.0">systems/autopilot/gui/speed-set-cas</property>
    <property value="0.0">systems/autopilot/gui/speed-set-mach</property>
    
    <property value="0.5">systems/autopilot/gui/h-sl-ft-lag-coefficient</property>
    
    <!-- System data section -->
    <property value="0.0">systems/autopilot/v-up-fpm</property>
    <property value="0.0">systems/autopilot/velocity-on-ground-fps</property>
    <property value="0.0">systems/autopilot/velocity-on-ground-fps-lag</property>
    <property value="0.0">systems/autopilot/velocity-on-ground-mph-lag</property>
    <property value="1.0">systems/autopilot/pid-test-kp</property>
    <property value="0.1">systems/autopilot/pid-test-ki</property>
    <property value="0.05">systems/autopilot/pid-test-kd</property>
    <property value="0.0">systems/autopilot/descent-ascent-phase</property>
    <property value="0.0">systems/autopilot/distance-fp</property>
    <property value="0.0">systems/autopilot/distance-nm</property>
    <property value="0.0">systems/autopilot/turn-radius-nm</property>
    <property value="0.0">systems/autopilot/propulsion-specific-con</property>
    
    <!-- Altitude section -->
    <property value="0.0">systems/autopilot/altitude-alt-terrain</property>
    <property value="0.0">systems/autopilot/altitude-hold-active</property>
    <property value="0.0">systems/autopilot/altitude-hold-ft-lag</property>
    <property value="0.1">systems/autopilot/altitude-hold-ft-lag-C1</property>
    <property value="0.0">systems/autopilot/altitude-hold-ft-dif</property>
    <property value="0.0">systems/autopilot/altitude-hold-versus-lag</property>
    <property value="2.0">systems/autopilot/altitude-hold-versus-lag-C1</property>
    <property value="0.0">systems/autopilot/altitude-hold-limitator-active</property>
    <property value="0.1">systems/autopilot/altitude-hold-fdm-lag-coefficient</property>
    <property value="0.0">systems/autopilot/altitude-hold-pid-gain-lag-sw</property>
    <!-- Some overshot Rule PID Ku: 2.8 Tu: 30.0 | 0.924 0.0622 0.00933 -->
    <property value="0.924">systems/autopilot/altitude-hold-pid-kp</property>
    <property value="0.0622">systems/autopilot/altitude-hold-pid-ki</property>
    <property value="0.00933">systems/autopilot/altitude-hold-pid-kd</property>
    <property value="0.0">systems/autopilot/altitude-hold-reset-integrator</property>
    <!-- Attention is foundamental parameter for stability -->
    <property value="1.0">systems/autopilot/altitude-hold-input-gain</property>
    <property value="2.0">systems/autopilot/altitude-hold-output-pow-gain</property>
    <property value="0.005">systems/autopilot/altitude-hold-output-gain</property>
    
    <!-- Altitude QFE section -->
    <property value="0.0">systems/autopilot/altitude-QFE-active</property>
    <property value="0.0">systems/autopilot/altitude-QFE-ft-lag</property>
    <property value="0.1">systems/autopilot/altitude-QFE-ft-lag-C1</property>
    <property value="0.0">systems/autopilot/altitude-QFE-impact-elev-ft</property>
    <property value="0.5">systems/autopilot/altitude-QFE-impact-elev-ft-C1</property>
    <property value="0.0">systems/autopilot/altitude-QFE-impact-elev-intensity</property>
    <property value="0.0">systems/autopilot/altitude-QFE-impact-elev-intensity-lag</property>
    <property value="0.5">systems/autopilot/altitude-QFE-impact-elev-intensity-C1</property>
    <property value="0.0">systems/autopilot/altitude-QFE-impact-elev-intensity-active</property>
    <property value="0.0">systems/autopilot/altitude-QFE-impact-elev-neutre</property>
    <!-- Impact control -->
    <property value="0.0">systems/autopilot/gui/impact-control-active</property>
    
    <!-- Fuel section -->
    <property value="0.0">systems/autopilot/fuel-total-lbs</property>
    <property value="0.0">systems/autopilot/fuel-droppable-auto</property>
    <property value="0.0">systems/autopilot/fuel-droppable-total-lbs</property>
    <property value="0.0">systems/autopilot/fuel-droppable-remain-lbs</property>
    <property value="0.0">systems/autopilot/fuel-flow-rate-lbhr</property>
    <property value="0.0">systems/autopilot/fuel-remain-lbs</property>
    <property value="0.0">systems/autopilot/fuel-remain-percent</property>
    <property value="0.0">systems/autopilot/fuel-time-residue-sec</property>
    <property value="0.0">systems/autopilot/fuel-time-residue-h</property>
    <property value="0.0">systems/autopilot/fuel-nm-residue</property>
    
    <!-- Landing gear section -->
    <property value="0.0">systems/autopilot/landing-gear-set-close</property>
    <property value="0.0">systems/autopilot/landing-gear-set-close-blocked</property>
    <property value="0.0">systems/autopilot/landing-gear-set-open</property>
    <property value="0.0">systems/autopilot/landing-gear-set-open-blocked</property>
    
    <!-- Wing leveler section -->
    <property value="0.0">systems/autopilot/wing-leveler-active</property>
    <property value="0.0">systems/autopilot/wing-leveler-ap-on-off</property>
    <property value="0.5">systems/autopilot/wing-leveler-lag-coefficient</property>
    <property value="-1.0">systems/autopilot/wing-leveler-output-gain</property>
    
    <!-- True heading section -->
    <property value="0.0">systems/autopilot/true-heading-active</property>
    <property value="0.0">systems/autopilot/true-heading-ap-on-off</property>
    <property value="0.5">systems/autopilot/true-heading-lag-coefficient</property>
    <property value="30.0">systems/autopilot/gui/true-heading-max-wing-slope-deg</property>
    <property value="0.5">systems/autopilot/gui/true-heading-max-wing-slope-rad</property>
    <property value="0.5">systems/autopilot/true-heading-max-wing-slope-correction</property>
    <property value="0.0">systems/autopilot/gui/true-heading-turn-direction</property>
    <property value="0.0">systems/autopilot/true-heading-rad</property>
    <property value="0.0">systems/autopilot/heading-true-deg</property>
    <property value="0.0">systems/autopilot/true-heading-deg-delta</property>
    <property value="5.0">systems/autopilot/true-heading-pid-kp</property>
    <property value="0.1">systems/autopilot/true-heading-pid-ki</property>
    <property value="0.5">systems/autopilot/true-heading-pid-kd</property>
    <property value="0.5">systems/autopilot/true-heading-activate-lag-coefficient</property>
    <property value="0.2">systems/autopilot/true-heading-turn-direction-versus-bias</property>
    <property value="10.0">systems/autopilot/true-heading-turn-direction-versus-coefficient</property>
    
    <!-- PHI Heading section -->
    <property value="0.0">systems/autopilot/phi-heading-active</property>
    <property value="0.0">systems/autopilot/phi-heading-deg</property>
    <property value="0.0">systems/autopilot/phi-heading-rad</property>
    <property value="0.0">systems/autopilot/phi-rad-limited</property>
    
    <!-- Rudder section -->
    <property value="0.0">systems/autopilot/rudder-active</property>
    <property value="0.0">systems/autopilot/rudder-rad-bias</property>
    <property value="1.0">systems/autopilot/rudder-Ny-gain</property>
    <property value="0.0">systems/autopilot/rudder-der</property>
    <property value="0.1">systems/autopilot/rudder-output-gain</property>
    <property value="0.0">systems/autopilot/rudder-rad</property>
    <property value="0.0">systems/autopilot/rudder-deg</property>
    <property value="0.8">systems/autopilot/rudder-pid-kp</property>
    <property value="0.1">systems/autopilot/rudder-pid-ki</property>
    <property value="0.2">systems/autopilot/rudder-pid-kd</property>
    <property value="0.0">systems/autopilot/rudder-ap-value-norm</property>
    
    <!-- Pitch section -->
    <property value="0.0">systems/autopilot/pitch-angle-absolute-rad</property>
    <property value="0.0">systems/autopilot/pitch-angle-absolute-rad-lag</property>
    <property value="8.0">systems/autopilot/pitch-angle-absolute-rad-lag-C1</property>
    <property value="0.0">systems/autopilot/pitch-angle-absolute-deg</property>
    <property value="0.0">systems/autopilot/pitch-angle-absolute-deg-lag</property>
    <property value="0.0">systems/autopilot/pitch-error-limiter-rad</property>
    <property value="1.0">systems/autopilot/pitch-error-limiter-coefficient</property>
    <property value="1.5">systems/autopilot/pitch-error-limiter-gain</property>
    <property value="0.0">systems/autopilot/pitch-output-error-coefficient-gain</property>
    <property value="0.0">systems/autopilot/pitch-output-error-coefficient-gain-active</property>
    <property value="0.0">systems/autopilot/pitch-output-error-coefficient-gain-speedbrake</property>
    <property value="0.8">systems/autopilot/pitch-output-error-coefficient-gain-speedbrake-value</property>
    <property value="0.0">systems/autopilot/pitch-output-error-coefficient-gain-flap</property>
    <property value="0.5">systems/autopilot/pitch-output-error-coefficient-gain-flap-value</property>
    <property value="0.0">systems/autopilot/pitch-control-active</property>
    <property value="0.0">systems/autopilot/pitch-angle-active</property>
    <property value="0.0">systems/autopilot/pitch-angle-deg</property>
    <property value="2.0">systems/autopilot/pitch-angle-deg-lag-C1</property>
    <property value="1.0">systems/autopilot/pitch-angle-limiter-factor</property>
    <property value="1.5">systems/autopilot/pitch-angle-pid-kp</property>
    <property value="0.1">systems/autopilot/pitch-angle-pid-ki</property>
    <property value="0.5">systems/autopilot/pitch-angle-pid-kd</property>
    <property value="0.2">systems/autopilot/pitch-angle-output-error-coefficient</property>
    <!-- Alpha -->
    <property value="0.0">systems/autopilot/pitch-alpha-active</property>
    <property value="0.0">systems/autopilot/pitch-alpha-input-deg</property>
    <property value="0.0">systems/autopilot/pitch-alpha-input-rad</property>
    <property value="8.0">systems/autopilot/pitch-alpha-input-lag-C1</property>
    <property value="0.0">systems/autopilot/pitch-alpha-super-deg</property>
    <property value="0.0">systems/autopilot/pitch-alpha-super-deg-lag</property>
    <property value="1.0">systems/autopilot/pitch-alpha-super-deg-C1</property>
    <property value="0.0">systems/autopilot/pitch-alpha-super-active</property>
    <property value="0.0">systems/autopilot/pitch-alpha-super-activate</property>
    <property value="0.0">systems/autopilot/pitch-alpha-super-active-lag</property>
    <property value="0.2">systems/autopilot/pitch-alpha-super-active-C1</property>
    <!-- Some overshot Ku 3.30 Tu 7.070 -->
    <!--
    <property value="1.099">systems/autopilot/pitch-alpha-pid-kp</property>
    <property value="0.3137">systems/autopilot/pitch-alpha-pid-ki</property>
    <property value="0.0471">systems/autopilot/pitch-alpha-pid-kd</property>
    -->
    <!-- No overshot Ku 10.0 Tu 10.0 -->
    <property value="2.000">systems/autopilot/pitch-alpha-pid-kp</property>
    <property value="0.400">systems/autopilot/pitch-alpha-pid-ki</property>
    <property value="0.066">systems/autopilot/pitch-alpha-pid-kd</property>
    
    
    <property value="-0.2">systems/autopilot/pitch-alpha-output-error-coefficient</property>
    
    <!-- Roll section -->
    <property value="3.0">systems/autopilot/roll-pid-kp</property>
    <property value="0.5">systems/autopilot/roll-pid-ki</property>
    <property value="1.5">systems/autopilot/roll-pid-kd</property>
    <property value="0.0">systems/autopilot/roll-ap-autoswitch-norm</property>
    <!-- Speed section -->
    <property value="0.0">systems/autopilot/speed-true-on-air</property>
    <property value="0.0">systems/autopilot/speed-true-on-air-ms-inv</property>
    <property value="0.0">systems/autopilot/speed-cas-on-air</property>
    <property value="0.0">systems/autopilot/speed-cas-on-air-lag</property>
    <property value="0.0">systems/autopilot/speed-mach-on-air</property>
    <property value="0.0">systems/autopilot/speed-true-on-air-sec</property>
    <property value="0.0">systems/autopilot/speed-value</property>
    <property value="0.0">systems/autopilot/speed-throttle-active</property>
    <property value="-1.0">systems/autopilot/speed-throttle-imposed</property>
    <property value="0.01">systems/autopilot/speed-pitch-input-gain</property>
    <property value="0.0">systems/autopilot/speed-reset-integrator</property>
    <property value="0.05">systems/autopilot/speed-throttle-input-gain</property>
    <!--PID -->
    <property value="0.5">systems/autopilot/speed-kp</property>
    <property value="0.1">systems/autopilot/speed-ki</property>
    <property value="0.5">systems/autopilot/speed-kd</property>
    <property value="0.005">systems/autopilot/speed-throttle-output-gain</property>
    <property value="0.0">systems/autopilot/speed-pitch-pid-gain-sum</property>
    <property value="-30.0">systems/autopilot/speed-pitch-output-gain</property>
    <property value="0.0">systems/autopilot/speed-pitch-active</property>
    <property value="0.0">systems/autopilot/speed-brake-set-activate</property>
    <property value="0.0">systems/autopilot/speed-brake-set-deactivate</property>
    <property value="0.0">systems/autopilot/steer-brake-antiskid</property>
    <property value="0.0">systems/autopilot/speed-automatic-flap-active</property>
    <property value="0.0">systems/autopilot/speed-automatic-gear-active</property>
    
    <property value="0.0">systems/autopilot/left-steer-brake</property>
    <property value="0.0">systems/autopilot/right-steer-brake</property>
    <property value="0.0">systems/autopilot/steer-brake-active</property>
    <property value="100.0">systems/autopilot/steer-brake-min-speed</property>
    
    <!-- Vertical speed section -->
    <property value="2.0">systems/autopilot/vertical-speed-fps-lag-C1</property>
    <property value="0.0">systems/autopilot/vertical-speed-active</property>
    <property value="0.0">systems/autopilot/vertical-speed-fpm</property>
    <property value="0.0">systems/autopilot/vertical-speed-reset-integrator</property>
    <!-- PID -->
    <property value="1.5">systems/autopilot/vertical-speed-pid-kp</property>
    <property value="0.2">systems/autopilot/vertical-speed-pid-ki</property>
    <property value="0.1">systems/autopilot/vertical-speed-pid-kd</property>
    <property value="-1.0">systems/autopilot/vertical-speed-output-error-coefficient</property>
    
    
    <channel name="Autopilot GUI Interface" execrate="32">
        
        <switch name="systems/autopilot/wing-leveler-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/heading-control == 1.0
                systems/autopilot/gui/wing-leveler == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/true-heading-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                <test logic="AND">
                    systems/autopilot/gui/heading-control == 1.0
                </test>
                <test logic="OR">
                    systems/autopilot/gui/true-heading == 1.0
                    systems/autopilot/phi-heading-active == 1.0
                </test>
            </test>
        </switch>
        
        <switch name="systems/autopilot/phi-heading-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/heading-control == 1.0
                systems/autopilot/gui/phi-heading == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/rudder-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/rudder-auto-coordination == 1.0
            </test>
        </switch>

        <switch name="systems/autopilot/pitch-angle-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/altitude-active == 1.0
                systems/autopilot/gui/pitch-angle == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/vertical-speed-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/altitude-active == 1.0
                systems/autopilot/gui/vertical-speed == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/pitch-alpha-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/altitude-active == 1.0
                systems/autopilot/gui/pitch-alpha == 1.0
            </test>
        </switch>
        
        <lag_filter name="systems/autopilot/pitch-alpha-super-active-lag">
            <input>systems/autopilot/pitch-alpha-super-active</input>
            <c1>systems/autopilot/pitch-alpha-super-active-C1</c1>
        </lag_filter>
        
        <switch name="systems/autopilot/pitch-alpha-super-activate">
            <default value="systems/autopilot/pitch-alpha-super-activate"/>
            <test logic="OR" value="0.0">
                systems/autopilot/pitch-alpha-super-active == 0.0
                systems/autopilot/pitch-alpha-super-active-lag LE 0.5
            </test>
            <test logic="AND" value="1.0">
                systems/autopilot/pitch-alpha-super-active-lag GT 0.5
            </test>
        </switch>
        
        <switch name="systems/autopilot/pitch-control-active">
            <default value="0.0"/>
            <test logic="OR" value="1.0">
                systems/autopilot/pitch-angle-active == 1.0
                systems/autopilot/vertical-speed-active == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/altitude-hold-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/altitude-active == 1.0
                systems/autopilot/gui/altitude-hold == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/altitude-QFE-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/altitude-active == 1.0
                systems/autopilot/gui/altitude-QFE == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/altitude-hold-limitator-active">
            <default value="0"/>
            <test logic="AND" value="1">
                <test logic="OR">
                    systems/autopilot/pitch-angle-active == 1
                    systems/autopilot/vertical-speed-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/altitude-hold-active == 1
                    systems/autopilot/altitude-QFE-active == 1
                </test>
            </test>
        </switch>
        
        <switch name="systems/autopilot/speed-throttle-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/speed-control == 1.0
                systems/autopilot/gui/speed-throttle == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/speed-pitch-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/speed-control == 1.0
                systems/autopilot/gui/speed-pitch == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/speed-brake-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/speed-control == 1.0
                systems/autopilot/gui/speed-brake == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/speed-automatic-flap-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/speed-control == 1.0
                systems/autopilot/gui/speed-automatic-flap == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/speed-automatic-gear-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/speed-control == 1.0
                systems/autopilot/gui/speed-automatic-gear == 1.0
            </test>
        </switch>
        
        <scheduled_gain name="systems/autopilot/pitch-error-limiter-rad">
            <input>systems/autopilot/pitch-error-limiter-coefficient</input>
            <table>
                <independentVar>systems/autopilot/speed-cas-on-air-lag</independentVar>
                <tableData>
                    0.0      0.3
                    160.0    0.2
                    200.0    0.12
                    300.0    0.06
                    800.0    0.02
                </tableData>
            </table>
            <gain>systems/autopilot/pitch-error-limiter-gain</gain>
        </scheduled_gain>
        
    </channel>
    
    
    <channel name="Auxiliary data" execrate="8">
        
        <fcs_function name="systems/autopilot/velocity-on-ground-fps">
            <function>
                <sqrt>
                    <sum>
                        <product>
                            <p>velocities/v-north-fps</p>
                            <p>velocities/v-north-fps</p>
                        </product>
                        <product>
                            <p>velocities/v-east-fps</p>
                            <p>velocities/v-east-fps</p>
                        </product>
                    </sum>
                </sqrt>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/velocity-on-ground-fps-lag">
            <input>systems/autopilot/velocity-on-ground-fps</input>
            <c1>1.0</c1>
        </lag_filter>
        
        <pure_gain name="systems/autopilot/velocity-on-ground-mph-lag">
            <input>systems/autopilot/velocity-on-ground-fps-lag</input>
            <gain>0.681818</gain>
        </pure_gain>
        
        <pure_gain name="systems/autopilot/v-up-fps">
            <input>velocities/v-down-fps</input>
            <gain>-1.0</gain>
        </pure_gain>
        
        <pure_gain name="systems/autopilot/v-up-fps">
            <input>velocities/v-down-fps</input>
            <gain>-1.0</gain>
        </pure_gain>
        
        <pure_gain name="systems/autopilot/v-up-fps">
            <input>velocities/v-down-fps</input>
            <gain>-1.0</gain>
        </pure_gain>
        
        <lag_filter name="systems/autopilot/v-up-fps-lag">
            <input>systems/autopilot/v-up-fps</input>
            <c1>8.0</c1>
        </lag_filter>
        
        <pure_gain name="systems/autopilot/v-up-fpm-lag">
            <input>systems/autopilot/v-up-fps-lag</input>
            <gain>60.0</gain>
        </pure_gain>
        
        <fcs_function name="systems/autopilot/pitch-angle-absolute-rad">
            <function>
                <ifthen>
                    <le><abs><p>systems/autopilot/velocity-on-ground-fps-lag</p></abs><v>1.0</v></le>
                    <v>0.0</v>
                    <product>
                        <cos>
                            <toradians>
                                <p>systems/autopilot/true-heading-turn-direction-versus-slope-sw-lag-deg</p>
                            </toradians>
                        </cos>
                        <ifthen>
                            <gt><abs><p>systems/autopilot/velocity-on-ground-fps-lag</p></abs><v>1.0</v></gt>
                            <atan>
                                <quotient>
                                    <p>systems/autopilot/v-up-fps-lag</p>
                                    <p>systems/autopilot/velocity-on-ground-fps-lag</p>
                                </quotient>
                            </atan>
                            <ifthen>
                                <ge><p>systems/autopilot/velocity-on-ground-fps-lag</p><v>0.0</v></ge>
                                <v>0.5</v>
                                <v>-0.5</v>
                            </ifthen>
                        </ifthen>
                    </product>
                </ifthen>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/pitch-angle-absolute-rad-lag">
            <input>systems/autopilot/pitch-angle-absolute-rad</input>
            <c1>systems/autopilot/pitch-angle-absolute-rad-lag-C1</c1>
        </lag_filter>

        <pure_gain name="systems/autopilot/pitch-angle-absolute-deg-lag">
            <input>systems/autopilot/pitch-angle-absolute-rad-lag</input>
            <gain>57.2958</gain>
        </pure_gain>
        
        <!-- Speed section -->
        
        <fcs_function name="systems/autopilot/speed-true-on-air">
            <function>
                <ifthen>
                    <gt><p>velocities/vtrue-kts</p><v>0.1</v></gt>
                    <p>velocities/vtrue-kts</p>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/speed-true-fps">
            <function>
                <product>
                    <p>velocities/vtrue-kts</p>
                    <v>1.46667</v>
                </product>
            </function>
        </fcs_function>
        
        <!-- altitude section -->
        
        <switch name="systems/autopilot/altitude-hold-ft">
            <default value="systems/autopilot/gui/altitude-hold-ft"/>
            <test logic="AND" value="systems/gauges/PHI/program/route-altitude-hold-ft">
                systems/autopilot/phi-heading-active == 1
            </test>
        </switch>
        
        <lag_filter name="systems/autopilot/altitude-hold-ft-lag">
            <input>systems/autopilot/altitude-hold-ft</input>
            <c1>systems/autopilot/altitude-hold-ft-lag-C1</c1>
        </lag_filter>
        
        <lag_filter name="systems/autopilot/altitude-QFE-impact-elev-intensity-lag">
            <input>systems/autopilot/altitude-QFE-impact-elev-intensity</input>
            <c1>systems/autopilot/altitude-QFE-impact-elev-intensity-C1</c1>
        </lag_filter>
        
        <fcs_function name="systems/autopilot/altitude-QFE-impact-elev-intensity-fuzy-1-0">
            <function>
                <quotient>
                    <difference>
                        <v>1.57079632679</v>
                        <atan>
                            <difference>
                                <p>systems/autopilot/altitude-QFE-impact-elev-intensity-lag</p>
                                <v>0.5</v>
                            </difference>
                        </atan>
                    </difference>
                    <v>1.57079632679</v>
                </quotient>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/altitude-QFE-impact-elev-intensity-fuzy-0-1">
            <function>
                <quotient>
                    <atan>
                        <difference>
                            <p>systems/autopilot/altitude-QFE-impact-elev-intensity-lag</p>
                            <v>0.5</v>
                        </difference>
                    </atan>
                    <v>1.57079632679</v>
                </quotient>
            </function>
        </fcs_function>
        
        <summer name="systems/autopilot/altitude-alt-terrain">
            <input>position/h-sl-ft</input>
            <input>-/position/altitude-agl-ft</input>
        </summer>
        
        <fcs_function name="systems/autopilot/altitude-QFE-ft-hold">
            <function>
                <ifthen>
                    <gt><p>systems/autopilot/altitude-hold-active</p><v>0.5</v></gt>
                    <difference>
                        <p>systems/autopilot/altitude-hold-ft-lag</p>
                        <p>systems/autopilot/altitude-alt-terrain</p>
                    </difference>
                    <p>systems/autopilot/gui/altitude-QFE-ft</p>
                </ifthen>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/altitude-QFE-ft-lag">
            <input>systems/autopilot/altitude-QFE-ft-hold</input>
            <c1>systems/autopilot/altitude-QFE-ft-lag-C1</c1>
        </lag_filter>
        
        <fcs_function name="systems/autopilot/pitch-angle-deg">
            <function>
                <ifthen>
                    <gt><p>systems/autopilot/gui/impact-control-active</p><v>0.5</v></gt>
                    <sum>
                        <v>1.0</v>
                        <product>
                            <p>systems/autopilot/gui/pitch-angle-deg</p>
                            <p>systems/autopilot/altitude-QFE-impact-elev-intensity-lag</p>
                        </product>
                    </sum>
                    <p>systems/autopilot/gui/pitch-angle-deg</p>
                </ifthen>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/vertical-speed-fpm">
            <function>
                <ifthen>
                    <gt><p>systems/autopilot/gui/impact-control-active</p><v>0.5</v></gt>
                    <sum>
                        <v>1.0</v>
                        <product>
                            <p>systems/autopilot/gui/vertical-speed-fpm</p>
                            <p>systems/autopilot/altitude-QFE-impact-elev-intensity-lag</p>
                            <v>2.0</v>
                        </product>
                    </sum>
                    <p>systems/autopilot/gui/vertical-speed-fpm</p>
                </ifthen>
            </function>
        </fcs_function>
        
    </channel>
    
    
    <channel name="Gain not persistent control" execrate="32">
              
        <switch name="systems/autopilot/pitch-output-error-coefficient-gain-active">
            <default value="systems/autopilot/pitch-output-error-coefficient-gain-active"/>
            <test logic="AND" value="systems/autopilot/pitch-output-error-coefficient-gain">
                systems/autopilot/pitch-output-error-coefficient-gain GE 0.1
            </test>
            <test logic="AND" value="0">
                systems/autopilot/pitch-output-error-coefficient-gain-lag LT 0.1
            </test>
        </switch>
        
        <lag_filter name="systems/autopilot/pitch-output-error-coefficient-gain-lag">
            <input>systems/autopilot/pitch-output-error-coefficient-gain</input>
            <c1>0.5</c1>
        </lag_filter>
    
        <switch name="systems/autopilot/pitch-output-error-coefficient-gain">
            <default value="systems/autopilot/pitch-output-error-coefficient-gain"/>
            <test logic="AND" value="0">
                systems/autopilot/pitch-output-error-coefficient-gain GE 0.1
            </test>
        </switch>
        
        <lag_filter name="systems/autopilot/pitch-output-error-coefficient-gain-active-lag">
            <input>systems/autopilot/pitch-output-error-coefficient-gain-active</input>
            <c1>0.6</c1>
        </lag_filter>
        
        <switch name="systems/autopilot/pitch-output-error-coefficient-gain-active-max">
            <default value="systems/autopilot/pitch-output-error-coefficient-gain-active-max"/>
            <test logic="AND" value="0">
                systems/autopilot/pitch-output-error-coefficient-gain-active-lag LT 0.1
                systems/autopilot/pitch-output-error-coefficient-gain-speedbrake LT 0.1
                systems/autopilot/pitch-output-error-coefficient-gain-flap LT 0.1
                systems/autopilot/altitude-QFE-impact-elev-intensity-active LT 1.0
            </test>
            <test logic="AND" value="systems/autopilot/pitch-output-error-coefficient-gain-active-lag">
                systems/autopilot/pitch-output-error-coefficient-gain-active-lag GT systems/autopilot/pitch-output-error-coefficient-gain-active-max
            </test>
            <test logic="AND" value="systems/autopilot/pitch-output-error-coefficient-gain-speedbrake">
                systems/autopilot/pitch-output-error-coefficient-gain-speedbrake GT systems/autopilot/pitch-output-error-coefficient-gain-active-max
            </test>
            <test logic="AND" value="systems/autopilot/pitch-output-error-coefficient-gain-flap">
                systems/autopilot/pitch-output-error-coefficient-gain-flap GT systems/autopilot/pitch-output-error-coefficient-gain-active-max
            </test>
            <test logic="AND" value="systems/autopilot/altitude-QFE-impact-elev-intensity">
                systems/autopilot/altitude-QFE-impact-elev-intensity-active GE 1.0
                systems/autopilot/altitude-QFE-impact-elev-intensity-lag GT systems/autopilot/pitch-output-error-coefficient-gain-active-max
            </test>
        </switch>
        
    </channel>
    
    
    <channel name="Heading control">
        
        <pure_gain name="systems/autopilot/true-heading-rad">
            <input>systems/autopilot/gui/true-heading-deg</input>
            <gain>0.0174533</gain>
        </pure_gain>
        
        <pure_gain name="systems/autopilot/heading-true-deg">
            <input>attitude/heading-true-rad</input>
            <gain>57.2958</gain>
        </pure_gain>
        
        <fcs_function name="systems/autopilot/phi-heading-deg">
            <function>
                <ifthen>
                    <ge><p>systems/gauges/PHI/program/route-from</p><v>1.0</v></ge>
                    <ifthen>
                        <gt><p>systems/gauges/PHI/indicator/brg-correct</p><v>180.0</v></gt>
                        <difference>
                            <p>systems/gauges/PHI/indicator/brg-correct</p>
                            <v>180.0</v>
                        </difference>
                        <ifthen>
                            <lt><p>systems/gauges/PHI/indicator/brg-correct</p><v>180.0</v></lt>
                            <sum>
                                <p>systems/gauges/PHI/indicator/brg-correct</p>
                                <v>180.0</v>
                            </sum>
                            <v>0.0</v>
                        </ifthen>
                    </ifthen>
                    <p>systems/gauges/PHI/indicator/brg-correct</p>
                </ifthen>
            </function>
        </fcs_function>
        
        <pure_gain name="systems/autopilot/phi-heading-rad">
            <input>systems/autopilot/phi-heading-deg</input>
            <gain>0.0174533</gain>
        </pure_gain>
        
        <pure_gain name="systems/autopilot/true-heading-max-wing-slope-rad">
            <input>systems/autopilot/gui/true-heading-max-wing-slope-deg</input>
            <gain>0.0174533</gain>
        </pure_gain>
        
        <pure_gain name="systems/autopilot/true-heading-rad-delta-phi">
            <input>systems/autopilot/phi-heading-rad</input>
            <gain>-1</gain>
        </pure_gain>
        
        <angle name="systems/autopilot/true-heading-rad-delta-true-heading" unit="RAD">
            <source_angle unit="RAD">attitude/heading-true-rad</source_angle>
            <target_angle unit="RAD">systems/autopilot/true-heading-rad</target_angle>
        </angle>
        
        <switch name="systems/autopilot/true-heading-rad-delta">
            <default value="systems/autopilot/true-heading-rad-delta-true-heading"/>
            <test logic="AND" value="systems/autopilot/true-heading-rad-delta-phi">
                systems/autopilot/phi-heading-active == 1
            </test>
        </switch>
        
        <pure_gain name="systems/autopilot/true-heading-deg-delta">
            <input>systems/autopilot/true-heading-rad-delta</input>
            <gain>57.2958</gain>
        </pure_gain>
        
        <pure_gain name="systems/autopilot/true-heading-deg-delta-norm">
            <input>systems/autopilot/true-heading-deg-delta</input>
            <gain>0.005555</gain>
        </pure_gain>
        
        <pure_gain name="systems/autopilot/true-heading-rad-delta-lim">
            <input>systems/autopilot/true-heading-rad-delta</input>
            <gain>1.0</gain>
            <clipto>
                <min>-0.2</min>
                <max>0.2</max>
            </clipto>
        </pure_gain>
        
        <switch name="systems/autopilot/true-heading-ap-on-off">
            <default value="-1"/>
            <test logic="AND" value="2">
                <test logic="AND">
                    systems/autopilot/true-heading-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/true-heading-rad-delta-lim GE 0.2
                    systems/autopilot/true-heading-rad-delta-lim LE -0.2
                </test>
            </test>
            <test logic="AND" value="0">
                systems/autopilot/true-heading-active == 1
            </test>
        </switch>
        
        <pid name="systems/autopilot/true-heading-rad-delta-pid">
            <input>systems/autopilot/true-heading-rad-delta-lim</input>
            <kp>systems/autopilot/true-heading-pid-kp</kp>
            <ki>systems/autopilot/true-heading-pid-ki</ki>
            <kd>systems/autopilot/true-heading-pid-kd</kd>
            <trigger>systems/autopilot/true-heading-ap-on-off</trigger>
        </pid>
        
        <fcs_function name="systems/autopilot/true-heading-max-wing-slope-rad-correct">
            <function>
                <sum>
                    <product>
                        <atan>
                            <product>
                                <abs><p>systems/autopilot/true-heading-rad-delta</p></abs>
                                <p>systems/autopilot/true-heading-turn-direction-versus-coefficient</p>
                            </product>
                        </atan>
                        <abs><p>systems/autopilot/true-heading-max-wing-slope-rad</p></abs>
                        <p>systems/autopilot/true-heading-max-wing-slope-correction</p>
                    </product>
                    <p>systems/autopilot/true-heading-turn-direction-versus-bias</p>
                </sum>
            </function>
        </fcs_function>
        
        <pure_gain name="systems/autopilot/true-heading-turn-direction-versus-slope">
            <input>systems/autopilot/true-heading-rad-delta-pid</input>
            <gain>systems/autopilot/true-heading-max-wing-slope-rad-correct</gain>
        </pure_gain>
        
        <switch name="systems/autopilot/true-heading-turn-direction-versus-slope-sw">
            <default value="0"/>
            <test logic="AND" value="systems/autopilot/true-heading-turn-direction-versus-slope">
                systems/autopilot/true-heading-active == 1
            </test>
        </switch>
        
        <lag_filter name="systems/autopilot/true-heading-turn-direction-versus-slope-sw-lag">
            <input>systems/autopilot/true-heading-turn-direction-versus-slope-sw</input>
            <c1>systems/autopilot/true-heading-activate-lag-coefficient</c1>
        </lag_filter>
        
        <pure_gain name="systems/autopilot/true-heading-turn-direction-versus-slope-sw-lag-deg">
            <input>systems/autopilot/true-heading-turn-direction-versus-slope-sw-lag</input>
            <gain>57.2958</gain>
        </pure_gain>
        
        <summer name="systems/autopilot/phi-rad-limited">
            <input>attitude/phi-rad</input>
            <input>-systems/autopilot/true-heading-turn-direction-versus-slope-sw-lag</input>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </summer>
        
        <pid name="systems/autopilot/wing-leveler-ap-pid">
            <input>systems/autopilot/phi-rad-limited</input>
            <kp>systems/autopilot/roll-pid-kp</kp>
            <ki>systems/autopilot/roll-pid-ki</ki>
            <kd>systems/autopilot/roll-pid-kd</kd>
            <trigger>systems/autopilot/wing-leveler-ap-on-off</trigger>
        </pid>
        
        <switch name="systems/autopilot/wing-leveler-ap-on-off">
            <default value="-1"/>
            <test logic="AND" value="2">
                <test logic="OR">
                    systems/autopilot/wing-leveler-active == 1
                    systems/autopilot/true-heading-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/phi-rad-limited GE 1.0
                    systems/autopilot/phi-rad-limited LE -1.0
                </test>
            </test>
            <test logic="AND" value="0">
                systems/autopilot/wing-leveler-active == 1
            </test>
        </switch>
        
        <switch name="systems/autopilot/wing-leveler-ap-autoswitch">
            <default value="0"/>
            <test logic="OR" value="systems/autopilot/wing-leveler-ap-pid">
                systems/autopilot/wing-leveler-active == 1
                systems/autopilot/true-heading-active == 1
            </test>
        </switch>

        <!-- output -->
        
        <pure_gain name="systems/autopilot/roll-ap-autoswitch-norm">
            <input>systems/autopilot/wing-leveler-ap-autoswitch</input>
            <gain>systems/autopilot/wing-leveler-output-gain</gain>
        </pure_gain>

    </channel>
    
    
    <channel name="Rudder control">
        
        <pure_gain name="systems/autopilot/rudder-rad">
            <input>accelerations/n-pilot-y-norm</input>
            <gain>systems/autopilot/rudder-Ny-gain</gain>
        </pure_gain>
        
        <pure_gain name="systems/autopilot/rudder-deg">
            <input>systems/autopilot/rudder-rad</input>
            <gain>57.2958</gain>
        </pure_gain>
        
        <summer name="systems/autopilot/rudder-rad-limited">
            <input>systems/autopilot/rudder-rad</input>
            <input>systems/autopilot/rudder-rad-bias</input>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </summer>
        
        <switch name="systems/autopilot/rudder-ap-on-off">
            <default value="-1"/>
            <test logic="AND" value="2">
                <test logic="AND">
                    systems/autopilot/rudder-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/rudder-rad-limited GE 1.0
                    systems/autopilot/rudder-rad-limited LE -1.0
                </test>
            </test>
            <test logic="AND" value="0">
                systems/autopilot/rudder-active == 1
            </test>
        </switch>
        
        <pid name="systems/autopilot/rudder-ap-pid">
            <input>systems/autopilot/rudder-rad-limited</input>
            <kp>systems/autopilot/rudder-pid-kp</kp>
            <ki>systems/autopilot/rudder-pid-ki</ki>
            <kd>systems/autopilot/rudder-pid-kd</kd>
            <trigger>systems/autopilot/rudder-ap-on-off</trigger>
        </pid>
        
        <summer name="systems/autopilot/rudder-ap-pid-sum">
            <input>systems/autopilot/rudder-ap-pid</input>
            <input>systems/autopilot/rudder-der</input>
        </summer>
        
        <switch name="systems/autopilot/rudder-ap-value">
            <default value="0"/>
            <test logic="OR" value="systems/autopilot/rudder-ap-pid-sum">
                systems/autopilot/rudder-active == 1
            </test>
        </switch>

        <!-- output -->
        
        <pure_gain name="systems/autopilot/rudder-ap-value-norm">
            <input>systems/autopilot/rudder-ap-value</input>
            <gain>systems/autopilot/rudder-output-gain</gain>
        </pure_gain>
        
    </channel>
    
    
    <channel name="Altitude control">
        
        <lag_filter name="systems/autopilot/h-sl-ft-lag">
            <input>position/h-sl-ft</input>
            <c1>systems/autopilot/gui/h-sl-ft-lag-coefficient</c1>
        </lag_filter>
        
        <!-- Pitch angle section -->
        
        <fcs_function name="systems/autopilot/pitch-angle-rad-sign">
            <function>
                <toradians>
                    <ifthen>
                        <or>
                            <eq><p>systems/autopilot/altitude-hold-active</p><v>1.0</v></eq>
                            <eq><p>systems/autopilot/altitude-QFE-active</p><v>1.0</v></eq>
                        </or>
                        <product>
                            <p>systems/autopilot/altitude-hold-pid-gain-lag-sw</p>
                            <ifthen>
                                <lt><abs><p>systems/autopilot/pitch-angle-deg</p></abs><v>0.5</v></lt>
                                <v>2.0</v>
                                <abs><p>systems/autopilot/pitch-angle-deg</p></abs>
                            </ifthen>
                        </product>
                        <ifthen>
                            <eq><p>systems/autopilot/pitch-angle-active</p><v>1.0</v></eq>
                            <p>systems/autopilot/pitch-angle-deg</p>
                            <p>systems/autopilot/pitch-angle-absolute-deg-lag</p>
                        </ifthen>
                    </ifthen>
                </toradians>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/pitch-angle-rad-sign-lag">
            <input>systems/autopilot/pitch-angle-rad-sign</input>
            <c1>0.5</c1>
        </lag_filter>
        
        <summer name="systems/autopilot/pitch-angle-rad-error">
            <input>systems/autopilot/pitch-angle-rad-sign-lag</input>
            <input>-systems/autopilot/pitch-angle-absolute-rad-lag</input>
        </summer>
        
        <fcs_function name="systems/autopilot/pitch-angle-rad-error-limiter">
            <function>
                <quotient>
                    <p>systems/autopilot/pitch-angle-rad-error</p>
                    <sum>
                        <product>
                            <p>systems/autopilot/pitch-angle-rad-error</p>
                            <p>systems/autopilot/pitch-angle-rad-error</p>
                        </product>
                        <p>systems/autopilot/pitch-angle-limiter-factor</p>
                    </sum>
                </quotient>
            </function>
            <clipto>
                <min>-systems/autopilot/pitch-error-limiter-rad</min>
                <max>systems/autopilot/pitch-error-limiter-rad</max>
            </clipto>
        </fcs_function>

        <switch name="systems/autopilot/pitch-angle-reset-integrator">
            <default value="1"/>
            <test logic="AND" value="0">
                systems/autopilot/pitch-angle-active == 1
                systems/autopilot/pitch-angle-rad-error-limiter LT systems/autopilot/pitch-error-limiter-rad
                systems/autopilot/pitch-angle-rad-error-limiter GT -systems/autopilot/pitch-error-limiter-rad
            </test>
            <test logic="AND" value="-1">
                <test logic="AND">
                    systems/autopilot/pitch-angle-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/pitch-angle-rad-error-limiter GE systems/autopilot/pitch-error-limiter-rad
                    systems/autopilot/pitch-angle-rad-error-limiter LE -systems/autopilot/pitch-error-limiter-rad
                </test>
            </test>
        </switch>
        
        <pid name="systems/autopilot/pitch-angle-pid">
            <input>systems/autopilot/pitch-angle-rad-error-limiter</input>
            <kp>systems/autopilot/pitch-angle-pid-kp</kp>
            <ki>systems/autopilot/pitch-angle-pid-ki</ki>
            <kd>systems/autopilot/pitch-angle-pid-kd</kd>
            <trigger>systems/autopilot/pitch-angle-reset-integrator</trigger>
        </pid>
        
        <fcs_function name="systems/autopilot/pitch-angle-output-error-correct">
            <function>
                <sum>
                    <p>systems/autopilot/pitch-angle-pid-kp</p>
                    <sum>
                        <log10>
                            <sum>
                                <product>
                                    <abs>
                                        <p>systems/autopilot/pitch-angle-rad-error-limiter</p>
                                    </abs>
                                    <v>5.0</v>
                                </product>
                                <v>1.0</v>
                            </sum>
                        </log10>
                        <v>1.0</v>
                    </sum>
                </sum>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/pitch-angle-error-gain">
            <function>
                <product>
                    <p>systems/autopilot/pitch-angle-pid</p>
                    <p>systems/autopilot/pitch-angle-output-error-correct</p>
                    <p>systems/autopilot/pitch-angle-output-error-coefficient</p>
                </product>
            </function>
        </fcs_function>
        
        <!-- Vertical speed section -->
        
        <fcs_function name="systems/autopilot/vertical-speed-target-sign-fps">
            <function>
                <quotient>
                    <ifthen>
                        <or>
                            <eq><p>systems/autopilot/altitude-hold-active</p><v>1.0</v></eq>
                            <eq><p>systems/autopilot/altitude-QFE-active</p><v>1.0</v></eq>
                        </or>
                        <product>
                            <p>systems/autopilot/altitude-hold-pid-gain-lag-sw</p>
                            <ifthen>
                                <lt><abs><p>systems/autopilot/vertical-speed-fpm</p></abs><v>200.0</v></lt>
                                <v>500.0</v>
                                <abs><p>systems/autopilot/vertical-speed-fpm</p></abs>
                            </ifthen>
                        </product>
                        <ifthen>
                            <eq><p>systems/autopilot/vertical-speed-active</p><v>1.0</v></eq>
                            <p>systems/autopilot/vertical-speed-fpm</p>
                            <p>systems/autopilot/v-up-fpm-lag</p>
                        </ifthen>
                    </ifthen>
                    <v>60.0</v>
                </quotient>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/vertical-speed-target-sign-fps-lag">
            <input>systems/autopilot/vertical-speed-target-sign-fps</input>
            <c1>0.2</c1>
        </lag_filter>
        
        <fcs_function name="systems/autopilot/vertical-speed-slope-target-rad">
            <function>
                <ifthen>
                    <gt><abs><p>systems/autopilot/velocity-on-ground-fps-lag</p></abs><v>1.0</v></gt>
                    <atan>
                        <quotient>
                            <p>systems/autopilot/vertical-speed-target-sign-fps-lag</p>
                            <p>systems/autopilot/velocity-on-ground-fps-lag</p>
                        </quotient>
                    </atan>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/vertical-speed-slope-target-rad-lag">
            <input>systems/autopilot/vertical-speed-slope-target-rad</input>
            <c1>systems/autopilot/vertical-speed-fps-lag-C1</c1>
        </lag_filter>
        
        <pure_gain name="systems/autopilot/vertical-speed-slope-target-deg-lag">
            <input>systems/autopilot/vertical-speed-slope-target-rad-lag</input>
            <gain>57.2958</gain>
        </pure_gain>
        
        <summer name="systems/autopilot/vertical-speed-error-rad">
            <input>systems/autopilot/vertical-speed-slope-target-rad-lag</input>
            <input>-systems/autopilot/pitch-angle-absolute-rad-lag</input>
        </summer>
        
        <fcs_function name="systems/autopilot/pitch-angle-rad-error-limiter">
            <function>
                <quotient>
                    <p>systems/autopilot/vertical-speed-error-rad</p>
                    <sum>
                        <product>
                            <p>systems/autopilot/vertical-speed-error-rad</p>
                            <p>systems/autopilot/vertical-speed-error-rad</p>
                        </product>
                        <p>systems/autopilot/pitch-angle-limiter-factor</p>
                    </sum>
                </quotient>
            </function>
        </fcs_function>
        
        <switch name="systems/autopilot/vertical-speed-reset-integrator">
            <default value="1"/>
            <test logic="AND" value="0">
                systems/autopilot/vertical-speed-active == 1
                systems/autopilot/pitch-angle-rad-error-limiter LT systems/autopilot/pitch-error-limiter-rad
                systems/autopilot/pitch-angle-rad-error-limiter GT -systems/autopilot/pitch-error-limiter-rad
            </test>
            <test logic="AND" value="-1">
                <test logic="AND">
                    systems/autopilot/vertical-speed-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/pitch-angle-rad-error-limiter GE systems/autopilot/pitch-error-limiter-rad
                    systems/autopilot/pitch-angle-rad-error-limiter LE -systems/autopilot/pitch-error-limiter-rad
                </test>
            </test>
        </switch>
        
        <!-- PID -->
        
        <pid name="systems/autopilot/vertical-speed-pid">
            <input>systems/autopilot/pitch-angle-rad-error-limiter</input>
            <kp>systems/autopilot/vertical-speed-pid-kp</kp>
            <ki type="ab3">systems/autopilot/vertical-speed-pid-ki</ki>
            <kd>systems/autopilot/vertical-speed-pid-kd</kd>
            <trigger>systems/autopilot/vertical-speed-reset-integrator</trigger>
        </pid>
        
        <fcs_function name="systems/autopilot/vertical-speed-slope-rad">
            <function>
                <product>
                    <p>systems/autopilot/vertical-speed-pid</p>
                    <p>systems/autopilot/vertical-speed-output-error-coefficient</p>
                    <v>-1.0</v>
                </product>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/vertical-speed-slope-rad-lag">
            <input>systems/autopilot/vertical-speed-slope-rad</input>
            <c1>systems/autopilot/vertical-speed-fps-lag-C1</c1>
        </lag_filter>

        <!-- Altitude hold section -->
        
        <fcs_function name="systems/autopilot/altitude-hold-versus">
            <function>
                <ifthen>
                    <ge><p>systems/autopilot/altitude-hold-pid-gain-lag-sw</p><v>0.0</v></ge>
                    <v>1.0</v>
                    <v>-1.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/altitude-hold-versus-lag">
            <input>systems/autopilot/altitude-hold-versus</input>
            <c1>systems/autopilot/altitude-hold-versus-lag-C1</c1>
        </lag_filter>
        
        <lag_filter name="systems/autopilot/altitude-QFE-impact-elev-ft-lag">
            <input>systems/autopilot/altitude-QFE-impact-elev-ft</input>
            <c1>systems/autopilot/altitude-QFE-impact-elev-ft-C1</c1>
        </lag_filter>
        
        <fcs_function name="systems/autopilot/altitude-selected-ft-dif">
            <function>
                <ifthen>
                    <gt><p>systems/autopilot/altitude-QFE-impact-elev-neutre</p><v>0.01</v></gt>
                    <v>1.0</v>
                    <sum>
                        <product>
                            <p>systems/autopilot/altitude-QFE-impact-elev-intensity-fuzy-0-1</p>
                            <difference>
                                <sum>
                                    <p>systems/autopilot/altitude-QFE-ft-lag</p>
                                    <p>systems/autopilot/altitude-QFE-impact-elev-ft-lag</p>
                                </sum>
                                <p>position/h-sl-ft</p>
                            </difference>
                        </product>
                        <product>
                            <p>systems/autopilot/altitude-QFE-impact-elev-intensity-fuzy-1-0</p>
                            <difference>
                                <p>systems/autopilot/altitude-QFE-ft-lag</p>
                                <p>/position/altitude-agl-ft</p>
                            </difference>
                        </product>
                    </sum>
                </ifthen>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/altitude-QFE-impact-elev-intensity-active">
            <function>
                <ifthen>
                    <le><p>systems/autopilot/altitude-hold-active</p><v>0.5</v></le>
                    <ifthen>
                        <and>
                            <gt><p>systems/autopilot/altitude-QFE-impact-elev-ft-lag</p><v>0.5</v></gt>
                            <gt><p>systems/autopilot/altitude-QFE-impact-elev-intensity-lag</p><v>1.0</v></gt>
                        </and>
                        <v>1.0</v>
                        <v>0.0</v>
                    </ifthen>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <pure_gain name="systems/autopilot/altitude-hold-error-norm">
            <input>systems/autopilot/altitude-selected-ft-dif</input>
            <gain>systems/autopilot/altitude-hold-input-gain</gain>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </pure_gain>
        
        <switch name="systems/autopilot/altitude-hold-reset-integrator">
            <default value="1"/>
            <test logic="AND" value="0">
                systems/autopilot/altitude-hold-limitator-active == 1
                systems/autopilot/altitude-hold-error-norm LT 1.0
                systems/autopilot/altitude-hold-error-norm GT -1.0
            </test>
            <test logic="AND" value="-1">
                <test logic="AND">
                    systems/autopilot/altitude-hold-limitator-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/altitude-hold-error-norm GE 1.0
                    systems/autopilot/altitude-hold-error-norm LE -1.0
                </test>
            </test>
        </switch>
        
        <pid name="systems/autopilot/altitude-hold-pid">
            <input>systems/autopilot/altitude-selected-ft-dif</input>
            <kp>systems/autopilot/altitude-hold-pid-kp</kp>
            <ki type="ab3">systems/autopilot/altitude-hold-pid-ki</ki>
            <kd>systems/autopilot/altitude-hold-pid-kd</kd>
            <trigger>systems/autopilot/altitude-hold-reset-integrator</trigger>
        </pid>
        
        <fcs_function name="systems/autopilot/altitude-hold-pid-gain">
            <function>
                <product>
                    <p>systems/autopilot/altitude-hold-pid</p>
                    <pow>
                        <abs><p>systems/autopilot/altitude-hold-error-norm</p></abs>
                        <p>systems/autopilot/altitude-hold-output-pow-gain</p>
                    </pow>
                    <p>systems/autopilot/altitude-hold-output-gain</p>
                </product>
            </function>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </fcs_function>
 
        <switch name="systems/autopilot/altitude-hold-pid-gain-lag-sw">
            <default value="1"/>
            <test logic="AND" value="systems/autopilot/altitude-hold-pid-gain">
                systems/autopilot/altitude-hold-limitator-active == 1
            </test>
        </switch>
        
        <!-- Pitch alpha section -->
        
        <fcs_function name="systems/autopilot/gui/pitch-alpha-deg">
            <function>
                <ifthen>
                    <eq><p>systems/autopilot/pitch-alpha-active</p><v>1.0</v></eq>
                    <p>systems/autopilot/gui/pitch-alpha-deg</p>
                    <todegrees>
                        <p>systems/autopilot/pitch-alpha-input-rad-lag</p>
                    </todegrees>
                </ifthen>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/pitch-alpha-super-deg-lag">
            <input>systems/autopilot/pitch-alpha-super-deg</input>
            <c1>systems/autopilot/pitch-alpha-super-deg-C1</c1>
        </lag_filter>
        
        <fcs_function name="systems/autopilot/pitch-alpha-input-rad">
            <function>
                <ifthen>
                    <eq><p>systems/autopilot/pitch-alpha-super-activate</p><v>0.0</v></eq>
                    <ifthen>
                        <eq><p>systems/autopilot/pitch-alpha-active</p><v>1.0</v></eq>
                        <toradians>
                            <p>systems/autopilot/gui/pitch-alpha-deg</p>
                        </toradians>
                        <ifthen>
                            <eq><p>systems/autopilot/pitch-angle-active</p><v>1.0</v></eq>
                            <p>systems/autopilot/pitch-angle-error-gain</p>
                            <p>systems/autopilot/vertical-speed-slope-rad</p>
                        </ifthen>
                    </ifthen>
                    <toradians>
                        <p>systems/autopilot/pitch-alpha-super-deg-lag</p>
                    </toradians>
                </ifthen>
            </function>
        </fcs_function>

        <lag_filter name="systems/autopilot/pitch-alpha-input-rad-lag">
            <input>systems/autopilot/pitch-alpha-input-rad</input>
            <c1>systems/autopilot/pitch-alpha-input-lag-C1</c1>
        </lag_filter>
        
        <summer name="systems/autopilot/pitch-alpha-rad-error">
            <input>systems/autopilot/pitch-alpha-input-rad-lag</input>
            <input>-aero/alpha-rad</input>
        </summer>
        
        <fcs_function name="systems/autopilot/pitch-alpha-rad-error-limiter">
            <function>
                <quotient>
                    <p>systems/autopilot/pitch-alpha-rad-error</p>
                    <sum>
                        <product>
                            <p>systems/autopilot/pitch-alpha-rad-error</p>
                            <p>systems/autopilot/pitch-alpha-rad-error</p>
                        </product>
                        <p>systems/autopilot/pitch-angle-limiter-factor</p>
                    </sum>
                </quotient>
            </function>
            <clipto>
                <min>-systems/autopilot/pitch-error-limiter-rad</min>
                <max>systems/autopilot/pitch-error-limiter-rad</max>
            </clipto>
        </fcs_function>

        <switch name="systems/autopilot/pitch-alpha-reset-integrator">
            <default value="1"/>
            <test logic="AND" value="0">
                systems/autopilot/pitch-alpha-rad-error-limiter LT systems/autopilot/pitch-error-limiter-rad
                systems/autopilot/pitch-alpha-rad-error-limiter GT -systems/autopilot/pitch-error-limiter-rad
            </test>
            <test logic="AND" value="-1">
                <test logic="OR">
                    systems/autopilot/pitch-angle-active == 1
                    systems/autopilot/vertical-speed-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/pitch-alpha-rad-error-limiter GE systems/autopilot/pitch-error-limiter-rad
                    systems/autopilot/pitch-alpha-rad-error-limiter LE -systems/autopilot/pitch-error-limiter-rad
                </test>
            </test>
        </switch>
        
        <fcs_function name="systems/autopilot/pitch-alpha-pid-kp-gain">
            <function>
                <product>
                    <p>systems/autopilot/pitch-alpha-pid-kp</p>
                    <sum>
                        <p>systems/autopilot/pitch-output-error-coefficient-gain-active-max</p>
                        <v>1.0</v>
                    </sum>
                </product>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/pitch-alpha-pid-kp-gain-lag">
            <input>systems/autopilot/pitch-alpha-pid-kp-gain</input>
            <c1>1.0</c1>
        </lag_filter>
        
        <pid name="systems/autopilot/pitch-alpha-pid">
            <input>systems/autopilot/pitch-alpha-rad-error-limiter</input>
            <kp>systems/autopilot/pitch-alpha-pid-kp-gain-lag</kp>
            <ki>systems/autopilot/pitch-alpha-pid-ki</ki>
            <kd>systems/autopilot/pitch-alpha-pid-kd</kd>
            <trigger>systems/autopilot/pitch-alpha-reset-integrator</trigger>
        </pid>
        
        <fcs_function name="systems/autopilot/pitch-alpha-pid-gain">
            <function>
                <product>
                    <p>systems/autopilot/pitch-alpha-pid</p>
                    <p>systems/autopilot/pitch-alpha-output-error-coefficient</p>
                    <sum>
                        <p>systems/autopilot/pitch-output-error-coefficient-gain-active-max</p>
                        <v>1.0</v>
                    </sum>
                    <sum>
                        <v>1.0</v>
                        <product>
                            <v>10.0</v>
                            <abs><sin><p>systems/autopilot/true-heading-max-wing-slope-rad</p></sin></abs>
                        </product>
                    </sum>
                </product>
            </function>
        </fcs_function>
        
        <!-- Pitch output section -->
        
        <switch name="fcs/pitch-autopilot-rad">
            <default value="fcs/pitch-autopilot-rad"/>
            <test logic="AND" value="systems/autopilot/pitch-alpha-pid-gain">
                systems/autopilot/gui/altitude-active == 1
            </test>
            <clipto>
                <min>-0.2181662</min>
                <max>0.3054326</max> 
            </clipto>
        </switch>

    </channel>
    
    
    <channel name="distance calculator">
        
        <integrator name="systems/autopilot/distance-fp">
            <input>velocities/u-aero-fps</input>
            <c1>1.0</c1>
        </integrator>
        
        <pure_gain name="systems/autopilot/distance-nm">
            <input>systems/autopilot/distance-fp</input>
            <gain>0.000189394</gain>
        </pure_gain>
        
        <fcs_function name="systems/autopilot/turn-radius-nm">
            <function>
                <ifthen>
                    <ge><abs><p>velocities/r-aero-rad_sec</p></abs><v>0.01</v></ge>
                    <product>
                        <quotient>
                            <p>velocities/u-aero-fps</p>
                            <p>velocities/r-aero-rad_sec</p>
                        </quotient>
                        <v>0.000189394</v>
                        <cos><p>systems/autopilot/true-heading-turn-direction-versus-slope-sw</p></cos>
                    </product>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/turn-radius-nm-lag">
            <input>systems/autopilot/turn-radius-nm</input>
            <c1>1.0</c1>
        </lag_filter>
        
    </channel>
    
    
    <channel name="Fuel control" execrate="16">
        
        <switch name="systems/autopilot/fuel-total-lbs">
            <default value="systems/autopilot/fuel-total-lbs"/>
            <test logic="AND" value="propulsion/total-fuel-lbs">
                propulsion/total-fuel-lbs GT systems/autopilot/fuel-total-lbs
            </test>
        </switch>
        
        <summer name="systems/autopilot/fuel-droppable-remain-lbs">
            <input>propulsion/tank[3]/contents-lbs</input>
            <input>propulsion/tank[4]/contents-lbs</input>
        </summer>
        
        <switch name="systems/autopilot/fuel-droppable-total-lbs">
            <default value="systems/autopilot/fuel-droppable-total-lbs"/>
            <test logic="AND" value="systems/autopilot/fuel-droppable-remain-lbs">
                systems/autopilot/fuel-droppable-remain-lbs GT systems/autopilot/fuel-droppable-total-lbs
            </test>
        </switch>
        
        <lag_filter name="systems/autopilot/fuel-flow-rate-pps-lag">
            <input>propulsion/engine/fuel-flow-rate-pps</input>
            <c1>0.1</c1>
        </lag_filter>
        
        <pure_gain name="systems/autopilot/fuel-flow-rate-lbhr">
            <input>systems/autopilot/fuel-flow-rate-pps-lag</input>
            <gain>3600.0</gain>
        </pure_gain>
        
        <summer name="systems/autopilot/fuel-remain-lbs">
            <input>systems/autopilot/fuel-total-lbs</input>
            <input>-propulsion/engine/fuel-used-lbs</input>
        </summer>
        
        <fcs_function name="systems/autopilot/fuel-remain-percent">
            <function>
                <ifthen>
                    <gt><p>systems/autopilot/fuel-total-lbs</p><v>1.0</v></gt>
                    <product>
                        <quotient>
                            <p>systems/autopilot/fuel-remain-lbs</p>
                            <p>systems/autopilot/fuel-total-lbs</p>
                        </quotient>
                        <v>100.0</v>
                    </product>
                    <v>0.0</v>
                </ifthen>
            </function>
            <clipto>
                <min>0.0</min>
                <max>100.0</max>
            </clipto>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/fuel-time-residue-sec">
            <function>
                <ifthen>
                    <gt><p>systems/autopilot/fuel-flow-rate-pps-lag</p><v>0.01</v></gt>
                    <quotient>
                        <p>systems/autopilot/fuel-remain-lbs</p>
                        <p>systems/autopilot/fuel-flow-rate-pps-lag</p>
                    </quotient>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <pure_gain name="systems/autopilot/fuel-mph-residue">
            <input>systems/autopilot/fuel-time-residue-sec</input>
            <gain>systems/autopilot/speed-true-on-air-sec</gain>
        </pure_gain>
        
        <!-- Droppable tanks -->
        
        <switch name="systems/starter/drop-tank-press">
            <default value="systems/starter/drop-tank-press"/>
            <test logic="AND" value="1.0">
                systems/autopilot/fuel-droppable-remain-lbs GT 1.0
                systems/autopilot/fuel-droppable-auto == 1
            </test>
        </switch>
        
        <switch name="systems/starter/drop-tank-press">
            <default value="systems/starter/drop-tank-press"/>
            <test logic="AND" value="0.0">
                systems/autopilot/fuel-droppable-remain-lbs LE 1.0
                systems/autopilot/fuel-droppable-auto == 1
            </test>
        </switch>
    
    </channel>
    
    
    <channel name="Propulsion control" execrate="16">

        <fcs_function name="systems/autopilot/propulsion-specific-con">
            <function>
                <ifthen>
                    <gt><p>propulsion/engine/thrust-lbs</p><v>1.0</v></gt>
                    <quotient>
                        <p>systems/autopilot/fuel-flow-rate-lbhr</p>
                        <p>propulsion/engine/thrust-lbs</p>
                    </quotient>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
    </channel>
    
    
    <channel name="Speed control">
        
        <pure_gain name="systems/autopilot/speed-true-on-air-ms-inv">
            <input>systems/autopilot/speed-true-on-air</input>
            <gain>-0.00027777777</gain>
        </pure_gain>
        
        <fcs_function name="systems/autopilot/speed-cas-on-air">
            <function>
                <ifthen>
                    <gt><p>velocities/vc-kts</p><v>0.1</v></gt>
                    <p>velocities/vc-kts</p>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/speed-cas-on-air-lag">
            <input>systems/autopilot/speed-cas-on-air</input>
            <c1>0.2</c1>
        </lag_filter>
        
        <fcs_function name="systems/autopilot/speed-mach-on-air">
            <function>
                <ifthen>
                    <gt><p>velocities/mach</p><v>0.01</v></gt>
                    <p>velocities/mach</p>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <pure_gain name="systems/autopilot/speed-true-on-air-sec">
            <input>systems/autopilot/speed-true-on-air</input>
            <gain>0.00027777</gain>
        </pure_gain>
        
        <switch name="systems/autopilot/speed-value">
            <default value="systems/autopilot/speed-value"/>
            <test logic="AND" value="systems/autopilot/speed-true-on-air">
                systems/autopilot/gui/speed-set-mph == 1
            </test>
            <test logic="AND" value="systems/autopilot/speed-cas-on-air">
                systems/autopilot/gui/speed-set-cas == 1
            </test>
            <test logic="AND" value="systems/autopilot/speed-mach-on-air">
                systems/autopilot/gui/speed-set-mach == 1
            </test>
        </switch>
        
        <lag_filter name="systems/autopilot/speed-value-lag">
            <input>systems/autopilot/gui/speed-value</input>
            <c1>0.2</c1>
        </lag_filter>
        
        <fcs_function name="systems/autopilot/speed-difference-throttle">
            <function>
                <ifthen>
                    <p>systems/autopilot/speed-throttle-active</p>
                    <product>
                        <difference>
                            <p>systems/autopilot/speed-value-lag</p>
                            <p>systems/autopilot/speed-value</p>
                        </difference>
                        <ifthen>
                            <p>systems/autopilot/gui/speed-set-mach</p>
                            <v>1000.0</v>
                            <v>1.0</v>
                        </ifthen>
                        <p>systems/autopilot/speed-throttle-input-gain</p>
                    </product>
                    <v>0.0</v>
                </ifthen>
            </function>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/speed-difference-pitch">
            <function>
                <ifthen>
                    <p>systems/autopilot/speed-pitch-active</p>
                    <product>
                        <difference>
                            <p>systems/autopilot/speed-value-lag</p>
                            <p>systems/autopilot/speed-value</p>
                        </difference>
                        <ifthen>
                            <p>systems/autopilot/gui/speed-set-mach</p>
                            <v>1000.0</v>
                            <v>1.0</v>
                        </ifthen>
                        <p>systems/autopilot/speed-pitch-input-gain</p>
                    </product>
                    <v>0.0</v>
                </ifthen>
            </function>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </fcs_function>
        
        <summer name="systems/autopilot/speed-difference">
            <input>systems/autopilot/speed-difference-throttle</input>
            <input>systems/autopilot/speed-difference-pitch</input>
        </summer>
        
        <switch name="systems/autopilot/speed-reset-integrator">
            <default value="-1"/>
            <test logic="AND" value="0">
                <test logic="OR">
                    systems/autopilot/speed-throttle-active == 1
                    systems/autopilot/speed-pitch-active == 1
                </test>
                <test logic="AND">
                    systems/autopilot/speed-difference LT 0.1
                    systems/autopilot/speed-difference GT -0.1
                </test>
            </test>
            <test logic="AND" value="1">
                <test logic="OR">
                    systems/autopilot/speed-throttle-active == 1
                    systems/autopilot/speed-pitch-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/speed-difference GE 0.1
                    systems/autopilot/speed-difference LE -0.1
                </test>
            </test>
        </switch>
        
        <pid name="systems/autopilot/speed-pid">
            <input>systems/autopilot/speed-difference</input>
            <kp>systems/autopilot/speed-kp</kp>
            <ki>systems/autopilot/speed-ki</ki>
            <kd>systems/autopilot/speed-kd</kd>
            <trigger>systems/autopilot/speed-reset-integrator</trigger>
        </pid>
        
        <pure_gain name="systems/autopilot/speed-throttle-pid-gain">
            <input>systems/autopilot/speed-pid</input>
            <gain>systems/autopilot/speed-throttle-output-gain</gain>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </pure_gain>
        
        <lag_filter name="systems/autopilot/speed-throttle-pid-gain-lag">
            <input>systems/autopilot/speed-throttle-pid-gain</input>
            <c1>0.5</c1>
        </lag_filter>
        
        <summer name="systems/autopilot/speed-throttle-pid-gain-sum">
            <input>systems/autopilot/speed-throttle-pid-gain-lag</input>
            <input>/controls/engines/engine/throttle</input>
        </summer>
        
        <switch name="systems/autopilot/speed-pid-output">
            <default value="/controls/engines/engine/throttle"/>
            <test logic="AND" value="systems/autopilot/speed-throttle-imposed">
                systems/autopilot/speed-throttle-imposed GE 0.0
            </test>
            <test logic="AND" value="/controls/engines/engine/throttle">
                systems/autopilot/speed-throttle-active == 0
            </test>
            <test logic="AND" value="systems/autopilot/speed-throttle-pid-gain-sum">
                systems/autopilot/speed-throttle-active == 1
                systems/autopilot/speed-throttle-pid-gain-sum GE 0.2
                systems/autopilot/speed-throttle-pid-gain-sum LE 0.94
            </test>
            <test logic="AND" value="0.90">
                systems/autopilot/speed-throttle-active == 1
                systems/autopilot/speed-throttle-pid-gain-sum GT 0.94
            </test>
            <test logic="AND" value="0.30">
                systems/autopilot/speed-throttle-active == 1
                systems/autopilot/speed-throttle-pid-gain-sum LT 0.2
            </test>
            <output>/controls/engines/engine/throttle</output>
        </switch>
        
        <fcs_function name="systems/autopilot/speed-pitch-pid-gain-sum">
            <function>
                <ifthen>
                    <p>systems/autopilot/speed-pitch-active</p>
                    <product>
                        <p>systems/autopilot/speed-pid</p>
                        <p>systems/autopilot/speed-pitch-output-gain</p>
                    </product>
                    <v>0.0</v>
                </ifthen>
            </function>
            <clipto>
                <min>-60.0</min>
                <max>60.0</max>
            </clipto>
        </fcs_function>
        
    </channel>
    
    
    <channel name="Speed bracke control" execrate="32">
        
        <lag_filter name="systems/autopilot/speed-brake-set-activate-lag">
            <input>systems/autopilot/speed-brake-set-activate</input>
            <c1>0.5</c1>
        </lag_filter>
        
        <lag_filter name="systems/autopilot/speed-brake-set-deactivate-lag">
            <input>systems/autopilot/speed-brake-set-deactivate</input>
            <c1>1.0</c1>
        </lag_filter>
        
        <switch name="systems/autopilot/speed-brake-set-activate-deactivate">
            <default value="0"/>
            <test logic="AND" value="1">
                systems/autopilot/speed-brake-set-activate-lag GT 0.2
                systems/autopilot/speed-brake-set-deactivate-lag LT 0.05
            </test>
            <test logic="AND" value="-1">
                systems/autopilot/speed-brake-set-deactivate-lag GE 0.01
            </test>
        </switch>
        
        <switch name="systems/autopilot/speed-brake-set-activate">
            <default value="systems/autopilot/speed-brake-set-activate"/>
            <test logic="AND" value="0">
                systems/autopilot/speed-brake-set-activate == 1
            </test>
        </switch>
        
        <switch name="systems/autopilot/speed-brake-set-deactivate">
            <default value="systems/autopilot/speed-brake-set-deactivate"/>
            <test logic="AND" value="0">
                systems/autopilot/speed-brake-set-deactivate == 1
            </test>
        </switch>
        
        <fcs_function name="systems/autopilot/pitch-output-error-coefficient-gain-speedbrake">
            <function>
                <ifthen>
                    <and>
                        <gt><p>systems/airbrake/speedbrake-pos-norm</p><v>0.1</v></gt>
                        <eq><p>systems/autopilot/pitch-control-active</p><v>1.0</v></eq>
                    </and>
                    <product>
                        <p>systems/autopilot/pitch-output-error-coefficient-gain-speedbrake-value</p>
                        <sum>
                            <v>1.0</v>
                            <abs>
                                <toradians> 
                                    <p>systems/autopilot/true-heading-turn-direction-versus-slope-sw-lag-deg</p>
                                </toradians>
                            </abs>
                        </sum>
                        <p>systems/airbrake/speedbrake-pos-norm</p>
                        <ifthen>
                            <gt><p>systems/autopilot/speed-cas-on-air-lag</p><v>80.0</v></gt>
                            <quotient>
                                <v>220.0</v>
                                <p>systems/autopilot/speed-cas-on-air-lag</p>
                            </quotient>
                            <v>0.4</v>
                        </ifthen>
                    </product>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <switch name="systems/autopilot/speed-pid-norm">
            <default value="0"/>
            <test logic="AND" value="1">
                systems/autopilot/speed-pid GT 0.1
            </test>
            <test logic="AND" value="-1">
                systems/autopilot/speed-pid LT -0.1
            </test>
        </switch>
        
        <lag_filter name="systems/autopilot/speed-pid-norm-lag">
            <input>systems/autopilot/speed-pid-norm</input>
            <c1>0.1</c1>
        </lag_filter>

        <switch name="systems/airbrake/automatic-cmd">
            <default value="systems/airbrake/automatic-cmd"/>
            <test logic="AND" value="0">
                systems/autopilot/speed-brake-set-activate-deactivate == -1
            </test>
            <test logic="AND" value="1">
                systems/autopilot/speed-brake-set-activate-deactivate == 1
            </test>
            <test logic="AND" value="1">
                <test logic="OR">
                    systems/autopilot/speed-throttle-active == 1
                    systems/autopilot/speed-pitch-active == 1
                </test>
                <test logic="AND">
                    systems/autopilot/speed-throttle-active == 1
                    systems/autopilot/speed-throttle-pid-gain-sum LT 0.3
                    systems/autopilot/speed-brake-active == 1
                    systems/autopilot/speed-pid-norm == -1
                    systems/autopilot/speed-pid-norm-lag LT -0.1
                    systems/autopilot/speed-pid-output GE 0.1
                </test>
            </test>
            <test logic="AND" value="0">
                <test logic="AND">
                    systems/autopilot/speed-throttle-active == 1
                    systems/autopilot/speed-throttle-pid-gain-sum GT 0.25
                    systems/autopilot/speed-brake-active == 1
                    systems/autopilot/speed-pid-norm GE 0
                    systems/autopilot/speed-pid-norm-lag GE -0.1
                    systems/autopilot/speed-pid-output GE 0.1
                </test>
            </test>
            <test logic="AND" value="0">
                <test logic="AND">
                    systems/autopilot/speed-brake-active == 0
                </test>
            </test>
        </switch>
        
    </channel>
    
    
    <channel name="Speed flight status" execrate="32">
    
        <lag_filter name="systems/autopilot/speed-cas-lag">
            <input>velocities/vc-kts</input>
            <c1>0.4</c1>
        </lag_filter>
        
        <lag_filter name="systems/autopilot/altitude-ft-lag">
            <input>/position/altitude-ft</input>
            <c1>0.5</c1>
        </lag_filter>

        <washout_filter name="systems/autopilot/descent-ascent-phase">
            <input>systems/autopilot/altitude-ft-lag</input>
            <c1>1.0</c1>
        </washout_filter>
        
        <switch name="systems/autopilot/phase-take-off">
            <default value="0"/>
            <test logic="AND" value="1">
                systems/autopilot/descent-ascent-phase GE 0.1
                systems/autopilot/speed-cas-lag LT 180.0
                systems/autopilot/altitude-ft-lag LT 5000.0
            </test>
        </switch>
        
    </channel>   
    
    
    <channel name="Speed flap control" execrate="32">

        <switch name="systems/autopilot/speed-flaps">
            <default value="/controls/flight/flaps"/>
            <test logic="AND" value="1">
                systems/autopilot/speed-automatic-flap-active == 1
                systems/autopilot/speed-cas-lag LT 170.0
                systems/autopilot/phase-landing GE 1
            </test>
            <test logic="AND" value="0.33">
                systems/autopilot/speed-automatic-flap-active == 1
                systems/autopilot/speed-cas-lag LT 185.0
                systems/autopilot/phase-landing LE 1
            </test>
            <test logic="AND" value="0">
                systems/autopilot/speed-automatic-flap-active == 1
                systems/autopilot/speed-cas-lag GE 195.0
                systems/autopilot/phase-landing LE 1
            </test>
            <output>/controls/flight/flaps</output>
        </switch>
        
        <fcs_function name="systems/autopilot/pitch-output-error-coefficient-gain-flap">
            <function>
                <ifthen>
                    <and>
                        <gt><p>systems/autopilot/speed-flaps</p><v>0.1</v></gt>
                        <eq><p>systems/autopilot/pitch-control-active</p><v>1.0</v></eq>
                    </and>
                    <product>
                        <p>systems/autopilot/pitch-output-error-coefficient-gain-flap-value</p>
                        <sum>
                            <v>1.0</v>
                            <abs>
                                <toradians> 
                                    <p>systems/autopilot/true-heading-turn-direction-versus-slope-sw-lag-deg</p>
                                </toradians>
                            </abs>
                        </sum>
                        <p>systems/autopilot/speed-flaps</p>
                    </product>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>

    </channel>
    
    
    <channel name="Landing brake" execrate="16">
        
        <switch name="systems/autopilot/steer-brake-activate">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/steer-brake-active GE 2.0
            </test>
        </switch>
        
        <fcs_function name="systems/autopilot/steer-brake-antiskid">
            <function>
                <cos>
                    <quotient>
                        <p>velocities/vtrue-kts</p>
                        <p>systems/autopilot/steer-brake-min-speed</p>
                    </quotient>
                </cos>
            </function>
            <clipto>
                <min>0</min>
                <max>1</max>
            </clipto>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/left-steer-brake">
            <function>
                <ifthen>
                    <gt><p>systems/autopilot/steer-brake-active</p><v>0.5</v></gt>
                    <product>
                        <p>systems/autopilot/steer-brake-antiskid</p>
                        <ifthen>
                            <gt><p>systems/autopilot/steer-brake-activate</p><v>0.5</v></gt>
                            <ifthen>
                                <lt><p>systems/autopilot/true-heading-deg-delta-norm</p><v>0.0</v></lt>
                                <sum>
                                    <p>systems/autopilot/steer-brake-activate</p>
                                    <product>
                                        <p>systems/autopilot/true-heading-deg-delta-norm</p>
                                        <v>-20.0</v>
                                    </product>
                                </sum>
                                <p>systems/autopilot/true-heading-deg-delta-norm</p>
                            </ifthen>
                            <ifthen>
                                <lt><p>systems/autopilot/true-heading-deg-delta-norm</p><v>0.0</v></lt>
                                <product>
                                    <p>systems/autopilot/true-heading-deg-delta-norm</p>
                                    <v>-10.0</v>
                                </product>
                                <v>0.0</v>
                            </ifthen>
                        </ifthen>
                    </product>
                    <v>0.0</v>
                </ifthen>
            </function>
            <clipto>
                <min>0</min>
                <max>1</max>
            </clipto>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/right-steer-brake">
            <function>
                <ifthen>
                    <gt><p>systems/autopilot/steer-brake-active</p><v>0.5</v></gt>
                    <product>
                        <p>systems/autopilot/steer-brake-antiskid</p>
                        <ifthen>
                            <gt><p>systems/autopilot/steer-brake-activate</p><v>0.5</v></gt>
                            <ifthen>
                                <gt><p>systems/autopilot/true-heading-deg-delta-norm</p><v>0.0</v></gt>
                                <sum>
                                    <p>systems/autopilot/steer-brake-activate</p>
                                    <product>
                                        <p>systems/autopilot/true-heading-deg-delta-norm</p>
                                        <v>20.0</v>
                                    </product>
                                </sum>
                                <p>systems/autopilot/steer-brake-activate</p>
                            </ifthen>
                            <ifthen>
                                <gt><p>systems/autopilot/true-heading-deg-delta-norm</p><v>0.0</v></gt>
                                <product>
                                    <p>systems/autopilot/true-heading-deg-delta-norm</p>
                                    <v>10.0</v>
                                </product>
                                <v>0.0</v>
                            </ifthen>
                        </ifthen>
                    </product>
                    <v>0.0</v>
                </ifthen>
            </function>
            <clipto>
                <min>0</min>
                <max>1</max>
            </clipto>
        </fcs_function>
        
    </channel>
    
    
    <channel name="automatic gear" execrate="32">
        
        <washout_filter name="systems/autopilot/speed-automatic-gear-active-wa">
            <input>systems/autopilot/speed-automatic-gear-active</input>
            <c1>1.0</c1>
        </washout_filter>

        <washout_filter name="systems/autopilot/landing-gear-set-open-wa">
            <input>systems/autopilot/landing-gear-set-open</input>
            <c1>1.0</c1>
        </washout_filter>

        <switch name="systems/autopilot/landing-gear-set-close">
            <default value="systems/autopilot/landing-gear-set-close"/>
            <test logic="AND" value="0.0">
                systems/autopilot/landing-gear-set-open-wa GT 0.5
            </test>
            <test logic="AND" value="0.0">
                systems/autopilot/speed-automatic-gear-active-wa GT 0.5
            </test>
        </switch>
        
        <washout_filter name="systems/autopilot/landing-gear-set-close-wa">
            <input>systems/autopilot/landing-gear-set-close</input>
            <c1>1.0</c1>
        </washout_filter>
        
        <switch name="systems/autopilot/landing-gear-set-open">
            <default value="systems/autopilot/landing-gear-set-open"/>
            <test logic="AND" value="0.0">
                systems/autopilot/landing-gear-set-close-wa GT 0.5
            </test>
            <test logic="AND" value="0.0">
                systems/autopilot/speed-automatic-gear-active-wa GT 0.5
            </test>
        </switch>
        
        <switch name="systems/autopilot/gui/speed-automatic-gear">
            <default value="systems/autopilot/gui/speed-automatic-gear"/>
            <test logic="OR" value="0.0">
                systems/autopilot/landing-gear-set-open == 1
                systems/autopilot/landing-gear-set-close == 1
            </test>
        </switch>
        
        <switch name="systems/autopilot/landing-gear-set-close-blocked">
            <default value="systems/autopilot/landing-gear-set-close-blocked"/>
            <test logic="OR" value="0.0">
                systems/autopilot/landing-gear-set-open == 1
                systems/autopilot/speed-automatic-gear-active == 1
                systems/landing-gear/gear-down-manual-command-filtered NE 0 
            </test>
            <test logic="AND" value="1.0">
                systems/autopilot/speed-automatic-gear-active == 0
                systems/autopilot/landing-gear-set-close == 1
                context/gears/on-ground == 0
            </test>
        </switch>
        
        <switch name="systems/autopilot/landing-gear-set-open-blocked">
            <default value="systems/autopilot/landing-gear-set-open-blocked"/>
            <test logic="OR" value="0.0">
                systems/autopilot/landing-gear-set-close == 1
                systems/autopilot/speed-automatic-gear-active == 1
                systems/landing-gear/gear-down-manual-command-filtered NE 0 
                systems/autopilot/speed-cas-on-air-lag GT 185
            </test>
            <test logic="AND" value="1.0">
                systems/autopilot/speed-automatic-gear-active == 0
                systems/autopilot/landing-gear-set-open == 1
                systems/autopilot/speed-cas-on-air-lag LE 185
            </test>
        </switch>
        
        <switch name="systems/landing-gear/gear-command-open">
            <default value="systems/landing-gear/gear-command-open"/>
            <test logic="AND" value="1">
                systems/autopilot/landing-gear-set-open-blocked == 1
                systems/autopilot/landing-gear-set-close-blocked == 0
            </test>
            <test logic="AND" value="1">
                systems/autopilot/speed-automatic-gear-active == 1
                systems/autopilot/speed-cas-on-air-lag LE 160
                /position/altitude-agl-ft LT 3000
            </test>
            <test logic="OR" value="0">
                systems/autopilot/landing-gear-set-open-blocked == 0
                systems/autopilot/landing-gear-set-close-blocked == 1
            </test>
        </switch>

        <switch name="systems/landing-gear/gear-command-close">
            <default value="systems/landing-gear/gear-command-close"/>
            <test logic="AND" value="1">
                systems/autopilot/landing-gear-set-close-blocked == 1
                systems/autopilot/landing-gear-set-open-blocked == 0
            </test>
            <test logic="AND" value="1">
                systems/autopilot/speed-automatic-gear-active == 1
                systems/autopilot/speed-cas-on-air-lag GT 185
            </test>
            <test logic="OR" value="0">
                systems/autopilot/landing-gear-set-close-blocked == 0
                systems/autopilot/landing-gear-set-open-blocked == 1
            </test>
        </switch>
        
    </channel>
    

</system>
