<?xml version="1.0"?>

<!-- Autopilot JSBSim
Original work Copyright (c) 2019 Adriano Bassignana (abassign)

The PID configurator is defined by: Zieglerâ€“Nichols method
https://en.wikipedia.org/wiki/Ziegler%E2%80%93Nichols_method
With the four variants:
Zingler-Nichols Classic
Possen Integral Rule
Some Overshoot
No Overshoot
-->

<system>
    
    <property value="0.0">systems/autopilot/phase-take-off</property>
    <property value="0.0">systems/autopilot/phase-landing</property>
    
    <property value="0.0">systems/autopilot/gui/rudder-auto-coordination</property>
    
    <property value="0.0">systems/autopilot/gui/heading-control</property>
    <property value="0.0">systems/autopilot/gui/wing-leveler</property>
    <property value="0.0">systems/autopilot/gui/true-heading</property>
    <property value="0.0">systems/autopilot/gui/true-heading-deg</property>
    <property value="0.0">systems/autopilot/gui/phi-heading</property>
    
    <property value="0.0">systems/autopilot/gui/altitude-active</property>
    <property value="0.0">systems/autopilot/gui/vertical-speed</property>
    <property value="1000.0">systems/autopilot/gui/vertical-speed-fpm</property>
    <property value="0.0">systems/autopilot/gui/pitch-hold</property>
    <property value="6.0">systems/autopilot/gui/pitch-hold-deg</property>
    <property value="0.0">systems/autopilot/gui/pitch-descent-angle</property>
    <property value="0.0">systems/autopilot/gui/pitch-descent-angle-deg</property>
    
    <property value="0.0">systems/autopilot/gui/altitude-hold</property>
    <property value="0.0">systems/autopilot/gui/altitude-hold-ft</property>
    <property value="0.0">systems/autopilot/gui/altitude-hold-togle</property>
    
    <property value="0.0">systems/autopilot/gui/speed-control</property>
    <property value="1.0">systems/autopilot/gui/speed-throttle</property>
    <property value="0.0">systems/autopilot/gui/speed-pitch</property>
    <property value="0.0">systems/autopilot/gui/speed-brake</property>
    <property value="0.0">systems/autopilot/gui/speed-automatic-flap</property>
    <property value="0.0">systems/autopilot/gui/speed-automatic-gear</property>
    <property value="200.0">systems/autopilot/gui/speed-value</property>
    <property value="0.0">systems/autopilot/gui/speed-set-mph</property>
    <property value="1.0">systems/autopilot/gui/speed-set-cas</property>
    <property value="0.0">systems/autopilot/gui/speed-set-mach</property>
    
    <property value="0.0">systems/autopilot/gui/landing-activate</property>
    <property value="-0.1">systems/autopilot/gui/landing-rwy-offset</property>
    
    <property value="0.0">systems/autopilot/wing-leveler-active</property>
    <property value="0.0">systems/autopilot/wing-leveler-ap-on-off</property>
    <property value="0.5">systems/autopilot/wing-leveler-lag-coefficient</property>
    <property value="-1.0">systems/autopilot/wing-leveler-output-gain</property>
    
    <property value="0.0">systems/autopilot/true-heading-active</property>
    <property value="0.0">systems/autopilot/true-heading-ap-on-off</property>
    <property value="0.5">systems/autopilot/true-heading-lag-coefficient</property>
    <property value="30.0">systems/autopilot/gui/true-heading-max-wing-slope-deg</property>
    <property value="0.5">systems/autopilot/gui/true-heading-max-wing-slope-rad</property>
    <property value="0.0">systems/autopilot/gui/true-heading-turn-direction</property>
    <property value="0.0">systems/autopilot/true-heading-rad</property>
    <property value="0.0">systems/autopilot/heading-true-deg</property>
    <property value="0.0">systems/autopilot/true-heading-deg-delta</property>
    <property value="5.0">systems/autopilot/true-heading-pid-kp</property>
    <property value="0.1">systems/autopilot/true-heading-pid-ki</property>
    <property value="0.5">systems/autopilot/true-heading-pid-kd</property>
    <property value="0.5">systems/autopilot/true-heading-activate-lag-coefficient</property>
    <property value="0.2">systems/autopilot/true-heading-turn-direction-versus-bias</property>
    <property value="10.0">systems/autopilot/true-heading-turn-direction-versus-coefficient</property>
    <property value="0.0">systems/autopilot/phi-heading-active</property>
    <property value="0.0">systems/autopilot/phi-heading-deg</property>
    <property value="0.0">systems/autopilot/phi-heading-rad</property>
    <property value="0.0">systems/autopilot/phi-rad-limited</property>
    
    <property value="0.0">systems/autopilot/rudder-active</property>
    <property value="0.0">systems/autopilot/rudder-rad-bias</property>
    <property value="1.0">systems/autopilot/rudder-Ny-gain</property>
    <property value="0.1">systems/autopilot/rudder-output-gain</property>
    <property value="0.0">systems/autopilot/rudder-rad</property>
    <property value="0.0">systems/autopilot/rudder-deg</property>
    <property value="0.8">systems/autopilot/rudder-pid-kp</property>
    <property value="0.1">systems/autopilot/rudder-pid-ki</property>
    <property value="0.2">systems/autopilot/rudder-pid-kd</property>
    <property value="0.0">systems/autopilot/rudder-ap-value-norm</property>
    
    <property value="0.0">systems/autopilot/pitch-hold-active</property>
    <property value="0.0">systems/autopilot/pitch-reset-integrator</property>
    
    <property value="0.0">systems/autopilot/v-up-fpm</property>
    <property value="0.0">systems/autopilot/elevator-cmd</property>
    <property value="0.0">systems/autopilot/pitch-hold-deg-lag</property>
    <property value="1.0">systems/autopilot/pitch-hold-deg-lag-C1</property>
    <!-- Zingler Integral Rule Ku: 35 Tu: 256 -->
    <property value="20.400">systems/autopilot/pitch-pid-kp</property>
    <property value="0.1594">systems/autopilot/pitch-pid-ki</property>
    <property value="0.00996">systems/autopilot/pitch-pid-kd</property>
    <!-- -->
    <property value="3.0">systems/autopilot/pitch-input-error-coefficient</property>
    <property value="-0.5">systems/autopilot/pitch-output-error-coefficient</property>
    <property value="0.0">systems/autopilot/pitch-error</property>
    <property value="0.0">systems/autopilot/pitch-ap-autoswitch-norm</property>
    <property value="0.1">systems/autopilot/pitch-descent-input-error-coefficient</property>
    <property value="0.0">systems/autopilot/pitch-descent-angle-active</property>
    <property value="0.0">systems/autopilot/pitch-descent-angle-deg</property>
    <property value="0.0">systems/autopilot/pitch-descent-angle-deg-lag</property>
    
    <property value="0.0">systems/autopilot/vertical-speed-fpm</property>
    <property value="0.0">systems/autopilot/vertical-speed-fpm-lag</property>
    <property value="1.0">systems/autopilot/vertical-speed-fpm-lag-C1</property>
    <property value="0.0">systems/autopilot/vertical-speed-active</property>
    <property value="0.0">systems/autopilot/vertical-speed-reset-integrator</property>
    <!-- Possen Integral Rule Ku: 0.130 Tu: 8.67 -->
    <property value="0.091">systems/autopilot/vertical-speed-pid-kp</property>
    <property value="0.026">systems/autopilot/vertical-speed-pid-ki</property>
    <property value="0.002">systems/autopilot/vertical-speed-pid-kd</property>
    <!-- -->
    <property value="0.4">systems/autopilot/vertical-speed-output-error-coefficient</property>
    <property value="0.001">systems/autopilot/vertical-speed-error-input-coefficient</property>
    <property value="0.0">systems/autopilot/vertical-speed-pitch-error-gain</property>
    
    <property value="0.5">systems/autopilot/gui/h-sl-ft-lag-coefficient</property>
    <property value="0.0">systems/autopilot/gui/altitude-hold-active</property>
    <property value="0.0">systems/autopilot/altitude-hold-ft</property>
    <property value="0.0">systems/autopilot/altitude-hold-ft-dif</property>
    <property value="0.0">systems/autopilot/altitude-hold-versus-lag</property>
    <property value="2.0">systems/autopilot/altitude-hold-versus-lag-C1</property>
    <property value="0.0">systems/autopilot/altitude-hold-limitator-active</property>
    <property value="0.1">systems/autopilot/altitude-hold-fdm-lag-coefficient</property>
    <property value="0.0">systems/autopilot/altitude-hold-pid-gain-lag-sw</property>
    <!-- Possen Integral Rule Ku: 0.8 Tu: 50 -->
    <property value="0.480">systems/autopilot/altitude-hold-pid-kp</property>
    <property value="0.019">systems/autopilot/altitude-hold-pid-ki</property>
    <property value="0.001">systems/autopilot/altitude-hold-pid-kd</property>
    <!-- -->
    <property value="0.0">systems/autopilot/altitude-hold-reset-integrator</property>
    <!-- Attention is foundamental parameter for stability -->
    <property value="0.02">systems/autopilot/altitude-hold-input-gain</property>
    <property value="1.5">systems/autopilot/altitude-hold-output-pow-gain</property>
    <property value="2.0">systems/autopilot/altitude-hold-output-gain</property>
    
    <property value="3.0">systems/autopilot/roll-pid-kp</property>
    <property value="0.5">systems/autopilot/roll-pid-ki</property>
    <property value="1.5">systems/autopilot/roll-pid-kd</property>
    <property value="0.0">systems/autopilot/roll-ap-autoswitch-norm</property>
    
    <property value="0.0">systems/autopilot/speed-true-on-air</property>
    <property value="0.0">systems/autopilot/speed-cas-on-air</property>
    <property value="0.0">systems/autopilot/speed-cas-on-air-lag</property>
    <property value="0.0">systems/autopilot/speed-mach-on-air</property>
    <property value="0.0">systems/autopilot/speed-true-on-air-sec</property>
    <property value="0.0">systems/autopilot/speed-value</property>
    <property value="0.0">systems/autopilot/speed-throttle-active</property>
    <property value="-1.0">systems/autopilot/speed-throttle-imposed</property>
    <property value="0.05">systems/autopilot/speed-throttle-input-gain</property>
    <property value="0.01">systems/autopilot/speed-pitch-input-gain</property>
    <property value="0.0">systems/autopilot/speed-reset-integrator</property>
    <!-- Possen Integral Rule Ku: 1.4 Tu: 50.0 -->
    <property value="0.98">systems/autopilot/speed-kp</property>
    <property value="0.0.049">systems/autopilot/speed-ki</property>
    <property value="0.003">systems/autopilot/speed-kd</property>
    <!-- -->
    <property value="0.001">systems/autopilot/speed-throttle-output-gain</property>
    <property value="0.0">systems/autopilot/speed-pitch-pid-gain-sum</property>
    <property value="-30.0">systems/autopilot/speed-pitch-output-gain</property>
    
    <property value="0.0">systems/autopilot/speed-pitch-active</property>
    <property value="0.0">systems/autopilot/speed-brake-set-active</property>
    <property value="0.0">systems/autopilot/speed-automatic-flap-active</property>
    <property value="0.0">systems/autopilot/speed-automatic-gear-active</property>
    
    <property value="0.0">systems/autopilot/descent-ascent-phase</property>
    
    <property value="0.0">systems/autopilot/fuel-total-lbs</property>
    <property value="0.0">systems/autopilot/fuel-droppable-auto</property>
    <property value="0.0">systems/autopilot/fuel-droppable-total-lbs</property>
    <property value="0.0">systems/autopilot/fuel-droppable-remain-lbs</property>
    <property value="0.0">systems/autopilot/fuel-flow-rate-lbhr</property>
    <property value="0.0">systems/autopilot/fuel-remain-lbs</property>
    <property value="0.0">systems/autopilot/fuel-remain-percent</property>
    <property value="0.0">systems/autopilot/fuel-time-residue-sec</property>
    <property value="0.0">systems/autopilot/fuel-time-residue-h</property>
    <property value="0.0">systems/autopilot/fuel-nm-residue</property>
    
    <property value="0.0">systems/autopilot/propulsion-specific-con</property>
    
    <property value="0.0">systems/autopilot/left-steer-brake</property>
    <property value="0.0">systems/autopilot/right-steer-brake</property>
    <property value="0.0">systems/autopilot/steer-brake</property>
    <property value="-250.0">systems/autopilot/steer-brake-min-speed</property>
    
    
    <channel name="Autopilot GUI Interface" execrate="32">
        
        <switch name="systems/autopilot/wing-leveler-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/heading-control == 1.0
                systems/autopilot/gui/wing-leveler == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/true-heading-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                <test logic="AND">
                    systems/autopilot/gui/heading-control == 1.0
                </test>
                <test logic="OR">
                    systems/autopilot/gui/true-heading == 1.0
                    systems/autopilot/phi-heading-active == 1.0
                </test>
            </test>
        </switch>
        
        <switch name="systems/autopilot/phi-heading-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/heading-control == 1.0
                systems/autopilot/gui/phi-heading == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/rudder-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/rudder-auto-coordination == 1.0
            </test>
        </switch>

        <switch name="systems/autopilot/pitch-hold-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/altitude-active == 1.0
                systems/autopilot/gui/pitch-hold == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/pitch-descent-angle-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/altitude-active == 1.0
                systems/autopilot/gui/pitch-descent-angle == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/vertical-speed-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/altitude-active == 1.0
                systems/autopilot/gui/vertical-speed == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/gui/altitude-hold-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/altitude-active == 1.0
                systems/autopilot/gui/altitude-hold == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/altitude-hold-limitator-active">
            <default value="0"/>
            <test logic="AND" value="1">
                <test logic="OR">
                    systems/autopilot/pitch-hold-active == 1
                    systems/autopilot/vertical-speed-active == 1
                </test>
                <test logic="AND">
                    systems/autopilot/gui/altitude-hold-active == 1
                </test>
            </test>
        </switch>
        
        <switch name="systems/autopilot/speed-throttle-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/speed-control == 1.0
                systems/autopilot/gui/speed-throttle == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/speed-pitch-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/speed-control == 1.0
                systems/autopilot/gui/speed-pitch == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/speed-brake-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/speed-control == 1.0
                systems/autopilot/gui/speed-brake == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/speed-automatic-flap-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/speed-control == 1.0
                systems/autopilot/gui/speed-automatic-flap == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/speed-automatic-gear-active">
            <default value="0.0"/>
            <test logic="AND" value="1.0">
                systems/autopilot/gui/speed-control == 1.0
                systems/autopilot/gui/speed-automatic-gear == 1.0
            </test>
        </switch>
        
    </channel>
    
    
    <channel name="Heading control">
        
        <pure_gain name="systems/autopilot/true-heading-rad">
            <input>systems/autopilot/gui/true-heading-deg</input>
            <gain>0.0174533</gain>
        </pure_gain>
        
        <pure_gain name="systems/autopilot/heading-true-deg">
            <input>attitude/heading-true-rad</input>
            <gain>57.2958</gain>
        </pure_gain>
        
        <fcs_function name="systems/autopilot/phi-heading-deg">
            <function>
                <ifthen>
                    <ge><p>systems/gauges/PHI/program/route-from</p><v>1.0</v></ge>
                    <ifthen>
                        <gt><p>systems/gauges/PHI/indicator/brg-correct</p><v>180.0</v></gt>
                        <difference>
                            <p>systems/gauges/PHI/indicator/brg-correct</p>
                            <v>180.0</v>
                        </difference>
                        <ifthen>
                            <lt><p>systems/gauges/PHI/indicator/brg-correct</p><v>180.0</v></lt>
                            <sum>
                                <p>systems/gauges/PHI/indicator/brg-correct</p>
                                <v>180.0</v>
                            </sum>
                            <v>0.0</v>
                        </ifthen>
                    </ifthen>
                    <p>systems/gauges/PHI/indicator/brg-correct</p>
                </ifthen>
            </function>
        </fcs_function>
        
        <pure_gain name="systems/autopilot/phi-heading-rad">
            <input>systems/autopilot/phi-heading-deg</input>
            <gain>0.0174533</gain>
        </pure_gain>
        
        <pure_gain name="systems/autopilot/true-heading-max-wing-slope-rad">
            <input>systems/autopilot/gui/true-heading-max-wing-slope-deg</input>
            <gain>0.0174533</gain>
        </pure_gain>
        
        <fcs_function name="systems/autopilot/true-heading-rad-prop-dif">
            <function>
                <ifthen>
                    <p>systems/autopilot/phi-heading-active</p>
                    <product>
                        <p>systems/autopilot/phi-heading-rad</p>
                        <v>-1.0</v>
                    </product>
                    <difference>
                        <p>systems/autopilot/true-heading-rad</p>
                        <p>attitude/heading-true-rad</p>
                    </difference>
                </ifthen>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/true-heading-rad-delta">
            <function>
                <ifthen>
                    <ge><p>systems/autopilot/true-heading-rad-prop-dif</p><pi/></ge>
                    <difference>
                        <p>systems/autopilot/true-heading-rad-prop-dif</p>
                        <product><pi/><v>1.0</v></product>
                    </difference>
                    <ifthen>
                        <lt><p>systems/autopilot/true-heading-rad-prop-dif</p><product><pi/><v>-1.0</v></product></lt>
                        <sum>
                            <p>systems/autopilot/true-heading-rad-prop-dif</p>
                            <product><pi/><v>2.0</v></product>
                        </sum>
                        <p>systems/autopilot/true-heading-rad-prop-dif</p>
                    </ifthen>
                </ifthen>
            </function>
        </fcs_function>

        <pure_gain name="systems/autopilot/true-heading-deg-delta">
            <input>systems/autopilot/true-heading-rad-delta</input>
            <gain>57.2958</gain>
        </pure_gain>
        
        <pure_gain name="systems/autopilot/true-heading-rad-delta-lim">
            <input>systems/autopilot/true-heading-rad-delta</input>
            <gain>1.0</gain>
            <clipto>
                <min>-0.2</min>
                <max>0.2</max>
            </clipto>
        </pure_gain>
        
        <switch name="systems/autopilot/true-heading-ap-on-off">
            <default value="-1"/>
            <test logic="AND" value="2">
                <test logic="AND">
                    systems/autopilot/true-heading-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/true-heading-rad-delta-lim GE 0.2
                    systems/autopilot/true-heading-rad-delta-lim LE -0.2
                </test>
            </test>
            <test logic="AND" value="0">
                systems/autopilot/true-heading-active == 1
            </test>
        </switch>
        
        <pid name="systems/autopilot/true-heading-rad-delta-pid">
            <input>systems/autopilot/true-heading-rad-delta-lim</input>
            <kp>systems/autopilot/true-heading-pid-kp</kp>
            <ki>systems/autopilot/true-heading-pid-ki</ki>
            <kd>systems/autopilot/true-heading-pid-kd</kd>
            <trigger>systems/autopilot/true-heading-ap-on-off</trigger>
        </pid>
        
        <fcs_function name="systems/autopilot/true-heading-max-wing-slope-rad-correct">
            <function>
                <sum>
                    <product>
                        <atan>
                            <product>
                                <abs><p>systems/autopilot/true-heading-rad-delta</p></abs>
                                <p>systems/autopilot/true-heading-turn-direction-versus-coefficient</p>
                            </product>
                        </atan>
                        <abs><p>systems/autopilot/true-heading-max-wing-slope-rad</p></abs>
                        <v>0.63637</v>
                    </product>
                    <p>systems/autopilot/true-heading-turn-direction-versus-bias</p>
                </sum>
            </function>
        </fcs_function>
        
        <pure_gain name="systems/autopilot/true-heading-turn-direction-versus-slope">
            <input>systems/autopilot/true-heading-rad-delta-pid</input>
            <gain>systems/autopilot/true-heading-max-wing-slope-rad-correct</gain>
        </pure_gain>
        
        <switch name="systems/autopilot/true-heading-turn-direction-versus-slope-sw">
            <default value="0"/>
            <test logic="AND" value="systems/autopilot/true-heading-turn-direction-versus-slope">
                systems/autopilot/true-heading-active == 1
            </test>
        </switch>
        
        <lag_filter name="systems/autopilot/true-heading-turn-direction-versus-slope-sw-lag">
            <input>systems/autopilot/true-heading-turn-direction-versus-slope-sw</input>
            <c1>systems/autopilot/true-heading-activate-lag-coefficient</c1>
        </lag_filter>
        
        <pure_gain name="systems/autopilot/true-heading-turn-direction-versus-slope-sw-lag-deg">
            <input>systems/autopilot/true-heading-turn-direction-versus-slope-sw-lag</input>
            <gain>57.2958</gain>
        </pure_gain>
        
        <summer name="systems/autopilot/phi-rad-limited">
            <input>attitude/phi-rad</input>
            <input>-systems/autopilot/true-heading-turn-direction-versus-slope-sw-lag</input>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </summer>
        
        <pid name="systems/autopilot/wing-leveler-ap-pid">
            <input>systems/autopilot/phi-rad-limited</input>
            <kp>systems/autopilot/roll-pid-kp</kp>
            <ki>systems/autopilot/roll-pid-ki</ki>
            <kd>systems/autopilot/roll-pid-kd</kd>
            <trigger>systems/autopilot/wing-leveler-ap-on-off</trigger>
        </pid>
        
        <switch name="systems/autopilot/wing-leveler-ap-on-off">
            <default value="-1"/>
            <test logic="AND" value="2">
                <test logic="OR">
                    systems/autopilot/wing-leveler-active == 1
                    systems/autopilot/true-heading-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/phi-rad-limited GE 1.0
                    systems/autopilot/phi-rad-limited LE -1.0
                </test>
            </test>
            <test logic="AND" value="0">
                systems/autopilot/wing-leveler-active == 1
            </test>
        </switch>
        
        <switch name="systems/autopilot/wing-leveler-ap-autoswitch">
            <default value="0"/>
            <test logic="OR" value="systems/autopilot/wing-leveler-ap-pid">
                systems/autopilot/wing-leveler-active == 1
                systems/autopilot/true-heading-active == 1
            </test>
        </switch>

        <!-- output -->
        
        <pure_gain name="systems/autopilot/roll-ap-autoswitch-norm">
            <input>systems/autopilot/wing-leveler-ap-autoswitch</input>
            <gain>systems/autopilot/wing-leveler-output-gain</gain>
        </pure_gain>

    </channel>
    
    
    <channel name="Rudder control">
        
        <pure_gain name="systems/autopilot/rudder-rad">
            <input>accelerations/n-pilot-y-norm</input>
            <gain>systems/autopilot/rudder-Ny-gain</gain>
        </pure_gain>
        
        <pure_gain name="systems/autopilot/rudder-deg">
            <input>systems/autopilot/rudder-rad</input>
            <gain>57.2958</gain>
        </pure_gain>
        
        <summer name="systems/autopilot/rudder-rad-limited">
            <input>systems/autopilot/rudder-rad</input>
            <input>systems/autopilot/rudder-rad-bias</input>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </summer>
        
        <switch name="systems/autopilot/rudder-ap-on-off">
            <default value="-1"/>
            <test logic="AND" value="2">
                <test logic="AND">
                    systems/autopilot/rudder-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/rudder-rad-limited GE 1.0
                    systems/autopilot/rudder-rad-limited LE -1.0
                </test>
            </test>
            <test logic="AND" value="0">
                systems/autopilot/rudder-active == 1
            </test>
        </switch>
        
        <pid name="systems/autopilot/rudder-ap-pid">
            <input>systems/autopilot/rudder-rad-limited</input>
            <kp>systems/autopilot/rudder-pid-kp</kp>
            <ki>systems/autopilot/rudder-pid-ki</ki>
            <kd>systems/autopilot/rudder-pid-kd</kd>
            <trigger>systems/autopilot/rudder-ap-on-off</trigger>
        </pid>
        
        <switch name="systems/autopilot/rudder-ap-value">
            <default value="0"/>
            <test logic="OR" value="systems/autopilot/rudder-ap-pid">
                systems/autopilot/rudder-active == 1
            </test>
        </switch>

        <!-- output -->
        
        <pure_gain name="systems/autopilot/rudder-ap-value-norm">
            <input>systems/autopilot/rudder-ap-value</input>
            <gain>systems/autopilot/rudder-output-gain</gain>
        </pure_gain>
        
    </channel>
    
    
    <channel name="Altitude control">
        
        <pure_gain name="systems/autopilot/v-up-fpm">
            <input>velocities/v-down-fps</input>
            <gain>-60</gain>
        </pure_gain>
        
        <lag_filter name="systems/autopilot/v-up-fpm-lag">
            <input>systems/autopilot/v-up-fpm</input>
            <c1>0.1</c1>
        </lag_filter>
        
        <lag_filter name="systems/autopilot/h-sl-ft-lag">
            <input>position/h-sl-ft</input>
            <c1>systems/autopilot/gui/h-sl-ft-lag-coefficient</c1>
        </lag_filter>

        <!-- Pitch section -->
        
        <fcs_function name="systems/autopilot/pitch-hold-deg-mod">
            <function>
                <ifthen>
                    <p>systems/autopilot/gui/altitude-hold-active</p>
                    <product>
                        <p>systems/autopilot/altitude-hold-pid-gain-lag-sw</p>
                        <abs><p>systems/autopilot/gui/pitch-hold-deg</p></abs>
                    </product>
                    <sum>
                        <p>systems/autopilot/gui/pitch-hold-deg</p>
                        <p>systems/autopilot/speed-pitch-pid-gain-sum</p>
                    </sum>
                </ifthen>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/pitch-descent-angle-deg">
            <function>
                <ifthen>
                    <gt><p>velocities/vtrue-fps</p><v>10.0</v></gt>
                    <difference>
                        <v>90.0</v>
                        <todegrees>
                            <acos>
                                <quotient>
                                    <p>velocities/h-dot-fps</p>
                                    <p>velocities/vtrue-fps</p>
                                </quotient>
                            </acos>
                        </todegrees>
                    </difference>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/pitch-hold-deg-lag">
            <input>systems/autopilot/pitch-hold-deg-mod</input>
            <c1>systems/autopilot/pitch-hold-deg-lag-C1</c1>
            <clipto>
                <min>-20.0</min>
                <max>20.0</max>
            </clipto>
        </lag_filter>
        
        <lag_filter name="systems/autopilot/pitch-descent-angle-deg-lag">
            <input>systems/autopilot/gui/pitch-descent-angle-deg</input>
            <c1>systems/autopilot/pitch-hold-deg-lag-C1</c1>
            <clipto>
                <min>-40.0</min>
                <max>20.0</max>
            </clipto>
        </lag_filter>
        
        <fcs_function name="systems/autopilot/pitch-rad-error">
            <function>
                <ifthen>
                    <p>systems/autopilot/pitch-descent-angle-active</p>
                    <product>
                        <toradians>
                            <difference>
                                <p>systems/autopilot/pitch-descent-angle-deg-lag</p>
                                <p>systems/autopilot/pitch-descent-angle-deg</p>
                            </difference>
                        </toradians>
                        <p>systems/autopilot/pitch-descent-input-error-coefficient</p>
                    </product>
                    <product>
                        <difference>
                            <ifthen>
                                <p>systems/autopilot/pitch-hold-active</p>
                                <toradians>
                                    <p>systems/autopilot/pitch-hold-deg-mod</p>
                                </toradians>
                                <ifthen>
                                    <p>systems/autopilot/vertical-speed-active</p>
                                    <p>systems/autopilot/vertical-speed-pitch-error-gain</p>
                                    <p>attitude/pitch-rad</p>
                                </ifthen>
                            </ifthen>
                            <p>attitude/pitch-rad</p>
                        </difference>
                        <p>systems/autopilot/pitch-input-error-coefficient</p>
                    </product>
                </ifthen>
            </function>
            <clipto>
                <min>-0.5</min>
                <max>0.5</max>
            </clipto>
        </fcs_function>
        
        <switch name="systems/autopilot/pitch-reset-integrator">
            <default value="-1"/>
            <test logic="AND" value="0">
                <test logic="OR">
                    systems/autopilot/pitch-hold-active == 1
                    systems/autopilot/pitch-descent-angle-active == 1
                </test>
                <test logic="AND">
                    systems/autopilot/pitch-rad-error LT 0.5
                    systems/autopilot/pitch-rad-error GT -0.5
                </test>
            </test>
            <test logic="AND" value="2">
                <test logic="OR">
                    systems/autopilot/pitch-hold-active == 1
                    systems/autopilot/pitch-descent-angle-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/pitch-rad-error GE 0.5
                    systems/autopilot/pitch-rad-error LE -0.5
                </test>
            </test>
        </switch>
        
        <pid name="systems/autopilot/pitch-speed-ap-pid" type="ab3">
            <input>systems/autopilot/pitch-rad-error</input>
            <kp>systems/autopilot/pitch-pid-kp</kp>
            <ki>systems/autopilot/pitch-pid-ki</ki>
            <kd>systems/autopilot/pitch-pid-kd</kd>
            <trigger>systems/autopilot/pitch-reset-integrator</trigger>
        </pid>
        
        <pure_gain name="systems/autopilot/pitch-error">
            <input>systems/autopilot/pitch-speed-ap-pid</input>
            <gain>systems/autopilot/pitch-output-error-coefficient</gain>
        </pure_gain> 
        
        <!-- Vertical speed section -->
        
        <fcs_function name="systems/autopilot/vertical-speed-fpm">
            <function>
                <ifthen>
                    <and>
                        <eq><p>systems/autopilot/vertical-speed-active</p><v>1.0</v></eq>
                        <eq><p>systems/autopilot/gui/altitude-hold-active</p><v>1.0</v></eq>
                    </and>
                    <product>
                        <abs><p>systems/autopilot/gui/vertical-speed-fpm</p></abs>
                        <p>systems/autopilot/altitude-hold-pid-gain-lag-sw</p>
                    </product>
                    <p>systems/autopilot/gui/vertical-speed-fpm</p>
                </ifthen>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/vertical-speed-fpm-lag">
            <input>systems/autopilot/vertical-speed-fpm</input>
            <c1>systems/autopilot/vertical-speed-fpm-lag-C1</c1>
            <clipto>
                <min>-12000.0</min>
                <max>8000.0</max>
            </clipto>
        </lag_filter>
        
        <fcs_function name="systems/autopilot/vertical-speed-error-norm">
            <function>
                <product>
                    <difference>
                        <p>systems/autopilot/vertical-speed-fpm-lag</p>
                        <p>systems/autopilot/v-up-fpm</p>
                    </difference>
                    <p>systems/autopilot/vertical-speed-error-input-coefficient</p>
                </product>
            </function>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </fcs_function>
        
        <switch name="systems/autopilot/vertical-speed-reset-integrator">
            <default value="-1"/>
            <test logic="AND" value="0">
                systems/autopilot/vertical-speed-active == 1
                systems/autopilot/vertical-speed-ap-pid-norm LT 1.0
                systems/autopilot/vertical-speed-ap-pid-norm GT -1.0
            </test>
            <test logic="AND" value="2">
                <test logic="AND">
                    systems/autopilot/vertical-speed-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/vertical-speed-ap-pid-norm GE 1.0
                    systems/autopilot/vertical-speed-ap-pid-norm LE -1.0
                </test>
            </test>
        </switch>

        <pid name="systems/autopilot/vertical-speed-ap-pid-norm" type="ab3">
            <input>systems/autopilot/vertical-speed-error-norm</input>
            <kp>systems/autopilot/vertical-speed-pid-kp</kp>
            <ki>systems/autopilot/vertical-speed-pid-ki</ki>
            <kd>systems/autopilot/vertical-speed-pid-kd</kd>
            <trigger>systems/autopilot/vertical-speed-reset-integrator</trigger>
        </pid>
        
        <pure_gain name="systems/autopilot/vertical-speed-pitch-error-gain">
            <input>systems/autopilot/vertical-speed-ap-pid-norm</input>
            <gain>systems/autopilot/vertical-speed-output-error-coefficient</gain>
        </pure_gain> 
        
        <!-- Altitude hold section -->
        
        <fcs_function name="systems/autopilot/altitude-hold-versus">
            <function>
                <ifthen>
                    <ge><p>systems/autopilot/altitude-hold-pid-gain-lag-sw</p><v>0.0</v></ge>
                    <v>1.0</v>
                    <v>-1.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/altitude-hold-versus-lag">
            <input>systems/autopilot/altitude-hold-versus</input>
            <c1>systems/autopilot/altitude-hold-versus-lag-C1</c1>
        </lag_filter>
        
        <switch name="systems/autopilot/altitude-hold-ft">
            <default value="systems/autopilot/gui/altitude-hold-ft"/>
            <test logic="AND" value="systems/gauges/PHI/program/route-altitude-hold-ft">
                systems/autopilot/phi-heading-active == 1
            </test>
        </switch>
        
        <summer name="systems/autopilot/altitude-hold-ft-dif">
            <input>systems/autopilot/altitude-hold-ft</input>
            <input>-position/h-sl-ft</input>
        </summer>
        
        <pure_gain name="systems/autopilot/altitude-hold-error-norm">
            <input>systems/autopilot/altitude-hold-ft-dif</input>
            <gain>systems/autopilot/altitude-hold-input-gain</gain>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </pure_gain>
        
        <switch name="systems/autopilot/altitude-hold-reset-integrator">
            <default value="-1"/>
            <test logic="AND" value="0">
                systems/autopilot/altitude-hold-limitator-active == 1
                systems/autopilot/altitude-hold-error-norm LT 1.0
                systems/autopilot/altitude-hold-error-norm GT -1.0
            </test>
            <test logic="AND" value="-1">
                <test logic="AND">
                    systems/autopilot/altitude-hold-limitator-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/altitude-hold-error-norm GE 1.0
                    systems/autopilot/altitude-hold-error-norm LE -1.0
                </test>
            </test>
        </switch>
        
        <pid name="systems/autopilot/altitude-hold-pid" type="ab3">
            <input>systems/autopilot/altitude-hold-error-norm</input>
            <kp>systems/autopilot/altitude-hold-pid-kp</kp>
            <ki>systems/autopilot/altitude-hold-pid-ki</ki>
            <kd>systems/autopilot/altitude-hold-pid-kd</kd>
            <trigger>systems/autopilot/altitude-hold-reset-integrator</trigger>
        </pid>
        
        <fcs_function name="systems/autopilot/altitude-hold-pid-gain">
            <function>
                <product>
                    <p>systems/autopilot/altitude-hold-pid</p>
                    <pow>
                        <abs><p>systems/autopilot/altitude-hold-error-norm</p></abs>
                        <p>systems/autopilot/altitude-hold-output-pow-gain</p>
                    </pow>
                    <p>systems/autopilot/altitude-hold-output-gain</p>
                </product>
            </function>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </fcs_function>
 
        <switch name="systems/autopilot/altitude-hold-pid-gain-lag-sw">
            <default value="1"/>
            <test logic="AND" value="systems/autopilot/altitude-hold-pid-gain">
                systems/autopilot/altitude-hold-limitator-active == 1
            </test>
        </switch>
        
        <switch name="systems/autopilot/pitch-ap-autoswitch-norm">
            <default value="0"/>
            <test logic="AND" value="systems/autopilot/pitch-error">
                systems/autopilot/pitch-hold-active == 1
            </test>
            <test logic="AND" value="systems/autopilot/pitch-error">
                systems/autopilot/pitch-descent-angle-active == 1
            </test>
            <test logic="AND" value="systems/autopilot/pitch-error">
                systems/autopilot/vertical-speed-active == 1
            </test>
        </switch>
        
    </channel>
    
    
    <channel name="Fuel control" execrate="16">
        
        <switch name="systems/autopilot/fuel-total-lbs">
            <default value="systems/autopilot/fuel-total-lbs"/>
            <test logic="AND" value="propulsion/total-fuel-lbs">
                propulsion/total-fuel-lbs GT systems/autopilot/fuel-total-lbs
            </test>
        </switch>
        
        <summer name="systems/autopilot/fuel-droppable-remain-lbs">
            <input>propulsion/tank[3]/contents-lbs</input>
            <input>propulsion/tank[4]/contents-lbs</input>
        </summer>
        
        <switch name="systems/autopilot/fuel-droppable-total-lbs">
            <default value="systems/autopilot/fuel-droppable-total-lbs"/>
            <test logic="AND" value="systems/autopilot/fuel-droppable-remain-lbs">
                systems/autopilot/fuel-droppable-remain-lbs GT systems/autopilot/fuel-droppable-total-lbs
            </test>
        </switch>
        
        <lag_filter name="systems/autopilot/fuel-flow-rate-pps-lag">
            <input>propulsion/engine/fuel-flow-rate-pps</input>
            <c1>0.1</c1>
        </lag_filter>
        
        <pure_gain name="systems/autopilot/fuel-flow-rate-lbhr">
            <input>systems/autopilot/fuel-flow-rate-pps-lag</input>
            <gain>3600.0</gain>
        </pure_gain>
        
        <summer name="systems/autopilot/fuel-remain-lbs">
            <input>systems/autopilot/fuel-total-lbs</input>
            <input>-propulsion/engine/fuel-used-lbs</input>
        </summer>
        
        <fcs_function name="systems/autopilot/fuel-remain-percent">
            <function>
                <ifthen>
                    <gt><p>systems/autopilot/fuel-total-lbs</p><v>1.0</v></gt>
                    <product>
                        <quotient>
                            <p>systems/autopilot/fuel-remain-lbs</p>
                            <p>systems/autopilot/fuel-total-lbs</p>
                        </quotient>
                        <v>100.0</v>
                    </product>
                    <v>0.0</v>
                </ifthen>
            </function>
            <clipto>
                <min>0.0</min>
                <max>100.0</max>
            </clipto>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/fuel-time-residue-sec">
            <function>
                <ifthen>
                    <gt><p>systems/autopilot/fuel-flow-rate-pps-lag</p><v>0.01</v></gt>
                    <quotient>
                        <p>systems/autopilot/fuel-remain-lbs</p>
                        <p>systems/autopilot/fuel-flow-rate-pps-lag</p>
                    </quotient>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <pure_gain name="systems/autopilot/fuel-mph-residue">
            <input>systems/autopilot/fuel-time-residue-sec</input>
            <gain>systems/autopilot/speed-true-on-air-sec</gain>
        </pure_gain>
        
        <!-- Droppable tanks -->
        
        <switch name="systems/starter/drop-tank-press">
            <default value="systems/starter/drop-tank-press"/>
            <test logic="AND" value="1.0">
                systems/autopilot/fuel-droppable-remain-lbs GT 1.0
                systems/autopilot/fuel-droppable-auto == 1
            </test>
        </switch>
        
        <switch name="systems/starter/drop-tank-press">
            <default value="systems/starter/drop-tank-press"/>
            <test logic="AND" value="0.0">
                systems/autopilot/fuel-droppable-remain-lbs LE 1.0
                systems/autopilot/fuel-droppable-auto == 1
            </test>
        </switch>
    
    </channel>
    
    
    <channel name="Propulsion control" execrate="16">

        <fcs_function name="systems/autopilot/propulsion-specific-con">
            <function>
                <ifthen>
                    <gt><p>propulsion/engine/thrust-lbs</p><v>1.0</v></gt>
                    <quotient>
                        <p>systems/autopilot/fuel-flow-rate-lbhr</p>
                        <p>propulsion/engine/thrust-lbs</p>
                    </quotient>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
    </channel>
    
    
    <channel name="Speed control">
        
        <fcs_function name="systems/autopilot/speed-true-on-air">
            <function>
                <ifthen>
                    <gt><p>velocities/vtrue-kts</p><v>50.0</v></gt>
                    <p>velocities/vtrue-kts</p>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/speed-cas-on-air">
            <function>
                <ifthen>
                    <gt><p>velocities/vc-kts</p><v>50.0</v></gt>
                    <p>velocities/vc-kts</p>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/autopilot/speed-cas-on-air-lag">
            <input>systems/autopilot/speed-cas-on-air</input>
            <c1>0.2</c1>
        </lag_filter>
        
        <fcs_function name="systems/autopilot/speed-mach-on-air">
            <function>
                <ifthen>
                    <gt><p>velocities/mach</p><v>0.01</v></gt>
                    <p>velocities/mach</p>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <pure_gain name="systems/autopilot/speed-true-on-air-sec">
            <input>systems/autopilot/speed-true-on-air</input>
            <gain>0.00027777</gain>
        </pure_gain>
        
        <switch name="systems/autopilot/speed-value">
            <default value="systems/autopilot/speed-value"/>
            <test logic="AND" value="systems/autopilot/speed-true-on-air">
                systems/autopilot/gui/speed-set-mph == 1
            </test>
            <test logic="AND" value="systems/autopilot/speed-cas-on-air">
                systems/autopilot/gui/speed-set-cas == 1
            </test>
            <test logic="AND" value="systems/autopilot/speed-mach-on-air">
                systems/autopilot/gui/speed-set-mach == 1
            </test>
        </switch>
        
        <lag_filter name="systems/autopilot/speed-value-lag">
            <input>systems/autopilot/gui/speed-value</input>
            <c1>0.2</c1>
        </lag_filter>
        
        <fcs_function name="systems/autopilot/speed-difference-throttle">
            <function>
                <ifthen>
                    <p>systems/autopilot/speed-throttle-active</p>
                    <product>
                        <difference>
                            <p>systems/autopilot/speed-value-lag</p>
                            <p>systems/autopilot/speed-value</p>
                        </difference>
                        <ifthen>
                            <p>systems/autopilot/gui/speed-set-mach</p>
                            <v>1000.0</v>
                            <v>1.0</v>
                        </ifthen>
                        <p>systems/autopilot/speed-throttle-input-gain</p>
                    </product>
                    <v>0.0</v>
                </ifthen>
            </function>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </fcs_function>
        
        <fcs_function name="systems/autopilot/speed-difference-pitch">
            <function>
                <ifthen>
                    <p>systems/autopilot/speed-pitch-active</p>
                    <product>
                        <difference>
                            <p>systems/autopilot/speed-value-lag</p>
                            <p>systems/autopilot/speed-value</p>
                        </difference>
                        <ifthen>
                            <p>systems/autopilot/gui/speed-set-mach</p>
                            <v>1000.0</v>
                            <v>1.0</v>
                        </ifthen>
                        <p>systems/autopilot/speed-pitch-input-gain</p>
                    </product>
                    <v>0.0</v>
                </ifthen>
            </function>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </fcs_function>
        
        <summer name="systems/autopilot/speed-difference">
            <input>systems/autopilot/speed-difference-throttle</input>
            <input>systems/autopilot/speed-difference-pitch</input>
        </summer>
        
        <switch name="systems/autopilot/speed-reset-integrator">
            <default value="-1"/>
            <test logic="AND" value="0">
                <test logic="OR">
                    systems/autopilot/speed-throttle-active == 1
                    systems/autopilot/speed-pitch-active == 1
                </test>
                <test logic="AND">
                    systems/autopilot/speed-difference LT 0.1
                    systems/autopilot/speed-difference GT -0.1
                </test>
            </test>
            <test logic="AND" value="2">
                <test logic="OR">
                    systems/autopilot/speed-throttle-active == 1
                    systems/autopilot/speed-pitch-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/speed-difference GE 0.1
                    systems/autopilot/speed-difference LE -0.1
                </test>
            </test>
        </switch>
        
        <pid name="systems/autopilot/speed-pid">
            <input>systems/autopilot/speed-difference</input>
            <kp>systems/autopilot/speed-kp</kp>
            <ki>systems/autopilot/speed-ki</ki>
            <kd>systems/autopilot/speed-kd</kd>
            <trigger>systems/autopilot/speed-reset-integrator</trigger>
        </pid>
        
        <pure_gain name="systems/autopilot/speed-throttle-pid-gain">
            <input>systems/autopilot/speed-pid</input>
            <gain>systems/autopilot/speed-throttle-output-gain</gain>
            <clipto>
                <min>-1.0</min>
                <max>1.0</max>
            </clipto>
        </pure_gain>
        
        <summer name="systems/autopilot/speed-throttle-pid-gain-sum">
            <input>systems/autopilot/speed-throttle-pid-gain</input>
            <input>/controls/engines/engine/throttle</input>
        </summer>
        
        <switch name="systems/autopilot/speed-pid-output">
            <default value="/controls/engines/engine/throttle"/>
            <test logic="AND" value="systems/autopilot/speed-throttle-imposed">
                systems/autopilot/speed-throttle-imposed GE 0.0
            </test>
            <test logic="AND" value="/controls/engines/engine/throttle">
                systems/autopilot/speed-throttle-active == 0
            </test>
            <test logic="AND" value="systems/autopilot/speed-throttle-pid-gain-sum">
                systems/autopilot/speed-throttle-active == 1
                systems/autopilot/speed-throttle-pid-gain-sum GE 0.2
                systems/autopilot/speed-throttle-pid-gain-sum LE 0.94
            </test>
            <test logic="AND" value="0.90">
                systems/autopilot/speed-throttle-active == 1
                systems/autopilot/speed-throttle-pid-gain-sum GT 0.94
            </test>
            <test logic="AND" value="0.30">
                systems/autopilot/speed-throttle-active == 1
                systems/autopilot/speed-throttle-pid-gain-sum LT 0.2
            </test>
            <output>/controls/engines/engine/throttle</output>
        </switch>
        
        <switch name="systems/autopilot/speed-throttle-imposed">
            <default value="systems/autopilot/speed-throttle-imposed"/>
            <test logic="AND" value="-1">
                systems/autopilot/speed-throttle-imposed GE 0.0
            </test>
        </switch>
        
        <fcs_function name="systems/autopilot/speed-pitch-pid-gain-sum">
            <function>
                <ifthen>
                    <p>systems/autopilot/speed-pitch-active</p>
                    <product>
                        <p>systems/autopilot/speed-pid</p>
                        <p>systems/autopilot/speed-pitch-output-gain</p>
                    </product>
                    <v>0.0</v>
                </ifthen>
            </function>
            <clipto>
                <min>-60.0</min>
                <max>60.0</max>
            </clipto>
        </fcs_function>
        
    </channel>
    
    
    <channel name="Speed airbracke control" execrate="32">
        
        <switch name="systems/autopilot/speed-pid-norm">
            <default value="0"/>
            <test logic="AND" value="1">
                systems/autopilot/speed-pid GT 0.1
            </test>
            <test logic="AND" value="-1">
                systems/autopilot/speed-pid LT -0.1
            </test>
        </switch>
        
        <lag_filter name="systems/autopilot/speed-pid-norm-lag">
            <input>systems/autopilot/speed-pid-norm</input>
            <c1>0.1</c1>
        </lag_filter>
        
        <switch name="systems/airbrake/automatic-cmd">
            <default value="systems/airbrake/automatic-cmd"/>
            <test logic="AND" value="1">
                systems/autopilot/speed-brake-set-active == 1
            </test>
            <test logic="AND" value="1">
                <test logic="OR">
                    systems/autopilot/speed-throttle-active == 1
                    systems/autopilot/speed-pitch-active == 1
                </test>
                <test logic="AND">
                    systems/autopilot/speed-brake-active == 1
                    systems/autopilot/speed-pid-norm == -1
                    systems/autopilot/speed-pid-norm-lag LT -0.1
                    systems/autopilot/speed-pid-output LE 0.2
                </test>
            </test>
            <test logic="AND" value="0">
                <test logic="OR">
                    systems/autopilot/speed-throttle-active == 0
                    systems/autopilot/speed-pitch-active == 0
                    systems/autopilot/speed-pid-output GE 0.3
                </test>
                <test logic="AND">
                    systems/autopilot/speed-pid-norm GE 0
                    systems/autopilot/speed-pid-norm-lag GE -0.1
                </test>
            </test>
        </switch>
        
    </channel>
    
    
    <channel name="Speed flight status" execrate="32">
    
        <lag_filter name="systems/autopilot/speed-cas-lag">
            <input>velocities/vc-kts</input>
            <c1>0.5</c1>
        </lag_filter>
        
        <lag_filter name="systems/autopilot/altitude-ft-lag">
            <input>/position/altitude-ft</input>
            <c1>0.5</c1>
        </lag_filter>

        <washout_filter name="systems/autopilot/descent-ascent-phase">
            <input>systems/autopilot/altitude-ft-lag</input>
            <c1>1.0</c1>
        </washout_filter>
        
        <switch name="systems/autopilot/phase-take-off">
            <default value="0"/>
            <test logic="AND" value="1">
                systems/autopilot/descent-ascent-phase GE 0.1
                systems/autopilot/speed-cas-lag LT 180.0
                systems/autopilot/altitude-ft-lag LT 5000.0
            </test>
        </switch>
        
    </channel>   
    
    
    <channel name="Speed flap control" execrate="32">

        <switch name="systems/autopilot/speed-flaps">
            <default value="/controls/flight/flaps"/>
            <test logic="AND" value="1">
                systems/autopilot/speed-automatic-flap-active == 1
                systems/autopilot/speed-cas-lag LT 170.0
                systems/autopilot/phase-landing == 1
            </test>
            <test logic="AND" value="0.33">
                systems/autopilot/speed-automatic-flap-active == 1
                systems/autopilot/speed-cas-lag LT 185.0
                systems/autopilot/phase-landing == 1
            </test>
            <test logic="AND" value="0">
                <test logic="AND">
                    systems/autopilot/speed-automatic-flap-active == 1
                </test>
                <test logic="OR">
                    systems/autopilot/speed-cas-lag GE 185.0
                    systems/autopilot/phase-landing == 0
                </test>
            </test>
            <output>/controls/flight/flaps</output>
        </switch>

    </channel>
    
    
    <channel name="Landing barke" execrate="8">
        
        <fcs_function name="systems/autopilot/steer-brake-modulated">
            <function>
                <sum>
                    <v>1.2</v>
                    <quotient>
                        <p>velocities/vtrue-kts</p>
                        <p>systems/autopilot/steer-brake-min-speed</p>
                    </quotient>
                </sum>
            </function>
            <clipto>
                <min>0</min>
                <max>1</max>
            </clipto>
        </fcs_function>
        
        <switch name="systems/autopilot/left-steer-brake">
            <default value="0"/>
            <test logic="AND" value="systems/autopilot/steer-brake-modulated">
                systems/autopilot/steer-brake == 1.0
            </test>
        </switch>
        
        <switch name="systems/autopilot/right-steer-brake">
            <default value="0"/>
            <test logic="AND" value="systems/autopilot/steer-brake-modulated">
                systems/autopilot/steer-brake == 1.0
            </test>
        </switch>

    </channel>
    
    
    <channel name="automatic gear" execrate="32">
        
        <switch name="systems/landing-gear/gear-down-command">
            <default value="systems/landing-gear/gear-down-command"/>
            <test logic="AND" value="1.0">
                systems/autopilot/speed-automatic-gear-active == 1.0
                systems/landing-gear/allarm-active == 1.0
                systems/landing-gear/gear-down-status == 0.0
            </test>
            <test logic="AND" value="-1.0">
                systems/autopilot/speed-automatic-gear-active == 1.0
                systems/autopilot/speed-cas-on-air-lag GT 180
                systems/landing-gear/gear-down-status == 1.0
            </test>
        </switch>
        
    </channel>
    

</system>
